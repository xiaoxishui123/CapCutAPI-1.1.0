app:
  description: "åŸºäºMCP Bridgeçš„æ™ºèƒ½çŸ­è§†é¢‘ç”Ÿæˆå·¥ä½œæµ - ä¿®å¤ç‰ˆï¼ˆåŒ…å«å®Œæ•´BGMåˆ†æ”¯ï¼‰"
  icon: "ğŸ¬"
  icon_background: "#FF6B6B"
  mode: workflow
  name: "æ™ºèƒ½çŸ­è§†é¢‘ç”Ÿæˆå™¨ v2.1 (BGMä¿®å¤ç‰ˆ)"

kind: app
version: 0.1.3

workflow:
  conversation_variables: []
  environment_variables:
    - name: MCP_BRIDGE_URL
      value: "http://localhost:8082"
    - name: CAPCUT_API_URL  
      value: "http://localhost:9000"
    - name: ENABLE_HTTP_FALLBACK
      value: "true"
    - name: MAX_RETRY_COUNT
      value: "3"
    - name: RENDER_TIMEOUT
      value: "300"

  graph:
    edges:
      # ä¸»æµç¨‹è¾¹
      - id: start-to-validate
        source: start
        target: validate_input
      - id: validate-to-script
        source: validate_input
        target: generate_script
      - id: script-to-parallel
        source: generate_script
        target: parallel_materials
      - id: parallel-to-draft
        source: parallel_materials
        target: create_draft
      - id: draft-to-assembly
        source: create_draft
        target: timeline_assembly
      
      # BGMæ¡ä»¶åˆ†æ”¯è¾¹
      - id: assembly-to-bgm-check
        source: timeline_assembly
        target: bgm_condition_check
      - id: bgm-check-to-bgm-branch
        source: bgm_condition_check
        sourceHandle: "true"
        target: bgm_smart_ranking
      - id: bgm-check-to-audio-direct
        source: bgm_condition_check
        sourceHandle: "false"
        target: audio_mixing
      - id: bgm-branch-to-audio
        source: bgm_smart_ranking
        target: audio_mixing
      
      # åç»­æµç¨‹è¾¹
      - id: audio-to-subtitle
        source: audio_mixing
        target: subtitle_alignment
      - id: subtitle-to-render
        source: subtitle_alignment
        target: submit_render
      - id: render-to-monitor
        source: submit_render
        target: monitor_progress
      - id: monitor-to-end
        source: monitor_progress
        target: end

    nodes:
      # èŠ‚ç‚¹1: å¼€å§‹èŠ‚ç‚¹ - ç”¨æˆ·è¾“å…¥éªŒè¯
      - data:
          desc: "ç”¨æˆ·è¾“å…¥å‚æ•°éªŒè¯å’Œé»˜è®¤å€¼è®¾ç½®"
          selected: false
          title: "ç”¨æˆ·è¾“å…¥éªŒè¯"
          type: start
          variables:
            - label: "è§†é¢‘ä¸»é¢˜"
              max_length: 200
              options: []
              required: true
              type: text-input
              variable: video_topic
            - label: "è§†é¢‘æ—¶é•¿(ç§’)"
              max_length: 10
              options: []
              required: false
              type: number-input
              variable: video_duration
              default: 30
            - label: "è§†é¢‘é£æ ¼"
              options:
                - "ç°ä»£ç®€çº¦"
                - "å•†åŠ¡ä¸“ä¸š"
                - "æ—¶å°šæ½®æµ"
                - "æ•™è‚²ç§‘æ™®"
                - "è¥é”€æ¨å¹¿"
              required: false
              type: select
              variable: video_style
              default: "ç°ä»£ç®€çº¦"
            - label: "è§†é¢‘æ¯”ä¾‹"
              options:
                - "9:16"
                - "16:9"
                - "1:1"
              required: false
              type: select
              variable: video_ratio
              default: "9:16"
            - label: "å¯ç”¨å­—å¹•"
              required: false
              type: boolean
              variable: enable_subtitle
              default: true
            - label: "å¯ç”¨èƒŒæ™¯éŸ³ä¹"
              required: false
              type: boolean
              variable: enable_bgm
              default: true
        height: 90
        id: start
        position:
          x: 80
          y: 282
        positionAbsolute:
          x: 80
          y: 282
        selected: false
        type: start
        width: 244

      # èŠ‚ç‚¹2: å‚æ•°éªŒè¯å’Œé¢„å¤„ç†
      - data:
          code: |
            import json
            import time
            
            def main(video_topic: str, video_duration: int = 30, video_style: str = "ç°ä»£ç®€çº¦", 
                    video_ratio: str = "9:16", enable_subtitle: bool = True, enable_bgm: bool = True) -> dict:
                """
                ç”¨æˆ·è¾“å…¥å‚æ•°éªŒè¯å’Œé¢„å¤„ç†
                """
                # å‚æ•°éªŒè¯
                if not video_topic or len(video_topic.strip()) < 5:
                    raise ValueError("è§†é¢‘ä¸»é¢˜ä¸èƒ½å°‘äº5ä¸ªå­—ç¬¦")
                
                if video_duration < 15 or video_duration > 300:
                    raise ValueError("è§†é¢‘æ—¶é•¿å¿…é¡»åœ¨15-300ç§’ä¹‹é—´")
                
                # æ ¹æ®æ¯”ä¾‹è®¾ç½®åˆ†è¾¨ç‡
                resolution_map = {
                    "9:16": {"width": 1080, "height": 1920},
                    "16:9": {"width": 1920, "height": 1080}, 
                    "1:1": {"width": 1080, "height": 1080}
                }
                
                resolution = resolution_map.get(video_ratio, {"width": 1080, "height": 1920})
                
                # æ„å»ºéªŒè¯åçš„å‚æ•°
                validated_params = {
                    "video_topic": video_topic.strip(),
                    "video_duration": video_duration,
                    "video_style": video_style,
                    "video_ratio": video_ratio,
                    "video_width": resolution["width"],
                    "video_height": resolution["height"],
                    "enable_subtitle": enable_subtitle,
                    "enable_bgm": enable_bgm,
                    "timestamp": int(time.time())
                }
                
                return {
                    "validated_params": json.dumps(validated_params),
                    "video_width": resolution["width"],
                    "video_height": resolution["height"],
                    "enable_bgm": enable_bgm
                }
          desc: "éªŒè¯ç”¨æˆ·è¾“å…¥å‚æ•°å¹¶è®¾ç½®é»˜è®¤å€¼"
          outputs:
            validated_params:
              type: string
            video_width:
              type: number
            video_height:
              type: number
            enable_bgm:
              type: boolean
          selected: false
          title: "å‚æ•°éªŒè¯"
          type: code
          variables:
            - value_selector:
                - start
                - video_topic
              variable: video_topic
            - value_selector:
                - start
                - video_duration
              variable: video_duration
            - value_selector:
                - start
                - video_style
              variable: video_style
            - value_selector:
                - start
                - video_ratio
              variable: video_ratio
            - value_selector:
                - start
                - enable_subtitle
              variable: enable_subtitle
            - value_selector:
                - start
                - enable_bgm
              variable: enable_bgm
        height: 54
        id: validate_input
        position:
          x: 384
          y: 282
        positionAbsolute:
          x: 384
          y: 282
        selected: false
        type: code
        width: 244

      # èŠ‚ç‚¹3: è„šæœ¬ç”Ÿæˆ
      - data:
          context:
            enabled: false
            variable_selector: []
          desc: "åŸºäºä¸»é¢˜ç”Ÿæˆè§†é¢‘è„šæœ¬"
          model:
            completion_params:
              temperature: 0.7
            mode: chat
            name: gpt-4
            provider: openai
          prompt_template:
            - id: system
              role: system
              text: |
                ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„çŸ­è§†é¢‘è„šæœ¬åˆ›ä½œä¸“å®¶ã€‚è¯·æ ¹æ®ç”¨æˆ·æä¾›çš„ä¸»é¢˜å’Œå‚æ•°ï¼Œåˆ›ä½œä¸€ä¸ªå¸å¼•äººçš„çŸ­è§†é¢‘è„šæœ¬ã€‚

                è¦æ±‚ï¼š
                1. è„šæœ¬æ—¶é•¿æ§åˆ¶åœ¨{{#validated_params.video_duration#}}ç§’å·¦å³
                2. é£æ ¼ç¬¦åˆ{{#validated_params.video_style#}}
                3. å†…å®¹è¦æœ‰å¸å¼•åŠ›ï¼Œé€‚åˆ{{#validated_params.video_ratio#}}æ¯”ä¾‹
                4. åŒ…å«å¼€å¤´ã€ä¸»ä½“ã€ç»“å°¾ä¸‰éƒ¨åˆ†
                5. è¯­è¨€ç®€æ´æœ‰åŠ›ï¼Œé€‚åˆé…éŸ³

                è¯·ä»¥JSONæ ¼å¼è¿”å›ï¼ŒåŒ…å«ï¼š
                - script: å®Œæ•´è„šæœ¬æ–‡æœ¬
                - segments: åˆ†æ®µä¿¡æ¯ï¼ˆæ¯æ®µåŒ…å«textã€durationã€scene_descriptionï¼‰
                - total_duration: æ€»æ—¶é•¿
                - style_notes: é£æ ¼è¯´æ˜
            - id: user
              role: user
              text: |
                è§†é¢‘ä¸»é¢˜ï¼š{{#video_topic#}}
                
                è¯·åˆ›ä½œè„šæœ¬ã€‚
          selected: false
          title: "è„šæœ¬ç”Ÿæˆ"
          type: llm
          variables:
            - value_selector:
                - start
                - video_topic
              variable: video_topic
            - value_selector:
                - validate_input
                - validated_params
              variable: validated_params
        height: 90
        id: generate_script
        position:
          x: 688
          y: 282
        positionAbsolute:
          x: 688
          y: 282
        selected: false
        type: llm
        width: 244

      # èŠ‚ç‚¹4: å¹¶è¡Œç´ æå¤„ç†
      - data:
          code: |
            import json
            import time
            
            def main(script_content: str, validated_params: str) -> dict:
                """
                å¹¶è¡Œå¤„ç†éŸ³é¢‘ã€è§†è§‰ã€BGMç´ æ
                """
                try:
                    # è§£æè¾“å…¥å‚æ•°
                    params = json.loads(validated_params)
                    script_data = json.loads(script_content) if isinstance(script_content, str) else script_content
                    
                    # æå–è„šæœ¬ä¿¡æ¯
                    script_text = script_data.get("script", script_content)
                    segments = script_data.get("segments", [])
                    
                    # å‡†å¤‡å¹¶è¡Œå¤„ç†ä»»åŠ¡
                    processing_tasks = {
                        "audio_tasks": {
                            "tts_segments": segments,
                            "voice_style": params.get("video_style", "ç°ä»£ç®€çº¦"),
                            "total_duration": params.get("video_duration", 30)
                        },
                        "visual_tasks": {
                            "scene_descriptions": [seg.get("scene_description", "") for seg in segments],
                            "video_style": params.get("video_style", "ç°ä»£ç®€çº¦"),
                            "video_ratio": params.get("video_ratio", "9:16"),
                            "video_width": params.get("video_width", 1080),
                            "video_height": params.get("video_height", 1920)
                        },
                        "bgm_tasks": {
                            "enabled": params.get("enable_bgm", True),
                            "video_style": params.get("video_style", "ç°ä»£ç®€çº¦"),
                            "video_topic": params.get("video_topic", ""),
                            "total_duration": params.get("video_duration", 30),
                            "search_keywords": [params.get("video_topic", ""), params.get("video_style", "")]
                        }
                    }
                    
                    return {
                        "processing_tasks": json.dumps(processing_tasks),
                        "script_text": script_text,
                        "segments_count": len(segments),
                        "enable_bgm": params.get("enable_bgm", True)
                    }
                    
                except Exception as e:
                    return {
                        "processing_tasks": json.dumps({"error": str(e)}),
                        "script_text": script_content,
                        "segments_count": 0,
                        "enable_bgm": False
                    }
          desc: "å‡†å¤‡å¹¶è¡Œå¤„ç†éŸ³é¢‘ã€è§†è§‰ã€BGMç´ æ"
          outputs:
            processing_tasks:
              type: string
            script_text:
              type: string
            segments_count:
              type: number
            enable_bgm:
              type: boolean
          selected: false
          title: "å¹¶è¡Œç´ æå¤„ç†"
          type: code
          variables:
            - value_selector:
                - generate_script
                - text
              variable: script_content
            - value_selector:
                - validate_input
                - validated_params
              variable: validated_params
        height: 54
        id: parallel_materials
        position:
          x: 992
          y: 282
        positionAbsolute:
          x: 992
          y: 282
        selected: false
        type: code
        width: 244

      # èŠ‚ç‚¹5: åˆ›å»ºè‰ç¨¿
      - data:
          code: |
            import json
            import time
            import uuid
            
            def main(processing_tasks: str, script_text: str) -> dict:
                """
                åˆ›å»ºCapCutè‰ç¨¿é¡¹ç›®
                """
                try:
                    tasks = json.loads(processing_tasks)
                    
                    # ç”Ÿæˆè‰ç¨¿ID
                    draft_id = f"draft_{int(time.time())}_{str(uuid.uuid4())[:8]}"
                    
                    # æ„å»ºè‰ç¨¿é…ç½®
                    draft_config = {
                        "draft_id": draft_id,
                        "project_name": f"AIçŸ­è§†é¢‘_{int(time.time())}",
                        "script_content": script_text,
                        "audio_config": tasks.get("audio_tasks", {}),
                        "visual_config": tasks.get("visual_tasks", {}),
                        "bgm_config": tasks.get("bgm_tasks", {}),
                        "created_at": int(time.time())
                    }
                    
                    # æ¨¡æ‹Ÿè‰ç¨¿åˆ›å»ºï¼ˆå®é™…åº”è°ƒç”¨CapCut APIï¼‰
                    print(f"åˆ›å»ºè‰ç¨¿: {draft_id}")
                    
                    return {
                        "draft_id": draft_id,
                        "draft_config": json.dumps(draft_config),
                        "creation_status": "success"
                    }
                    
                except Exception as e:
                    return {
                        "draft_id": "",
                        "draft_config": json.dumps({"error": str(e)}),
                        "creation_status": "failed"
                    }
          desc: "åˆ›å»ºCapCutè‰ç¨¿é¡¹ç›®"
          outputs:
            draft_id:
              type: string
            draft_config:
              type: string
            creation_status:
              type: string
          selected: false
          title: "åˆ›å»ºè‰ç¨¿"
          type: code
          variables:
            - value_selector:
                - parallel_materials
                - processing_tasks
              variable: processing_tasks
            - value_selector:
                - parallel_materials
                - script_text
              variable: script_text
        height: 54
        id: create_draft
        position:
          x: 1296
          y: 282
        positionAbsolute:
          x: 1296
          y: 282
        selected: false
        type: code
        width: 244

      # èŠ‚ç‚¹6: æ—¶é—´è½´è£…é…
      - data:
          code: |
            import json
            import time
            
            def main(draft_id: str, draft_config: str) -> dict:
                """
                æ—¶é—´è½´è£…é… - æ·»åŠ è§†è§‰ç´ æã€TTSéŸ³é¢‘
                """
                try:
                    config = json.loads(draft_config)
                    
                    # æ¨¡æ‹Ÿæ—¶é—´è½´è£…é…
                    timeline_result = {
                        "draft_id": draft_id,
                        "timeline_status": "assembled",
                        "visual_tracks": 3,
                        "audio_tracks": 2,
                        "total_duration": config.get("audio_config", {}).get("total_duration", 30),
                        "assembly_time": int(time.time())
                    }
                    
                    print(f"æ—¶é—´è½´è£…é…å®Œæˆ: {draft_id}")
                    
                    return {
                        "timeline_result": json.dumps(timeline_result),
                        "assembly_status": "success",
                        "draft_id": draft_id,
                        "bgm_required": config.get("bgm_config", {}).get("enabled", False)
                    }
                    
                except Exception as e:
                    return {
                        "timeline_result": json.dumps({"error": str(e)}),
                        "assembly_status": "failed",
                        "draft_id": draft_id,
                        "bgm_required": False
                    }
          desc: "æ—¶é—´è½´è£…é… - æ·»åŠ è§†è§‰ç´ æå’ŒTTSéŸ³é¢‘"
          outputs:
            timeline_result:
              type: string
            assembly_status:
              type: string
            draft_id:
              type: string
            bgm_required:
              type: boolean
          selected: false
          title: "æ—¶é—´è½´è£…é…"
          type: code
          variables:
            - value_selector:
                - create_draft
                - draft_id
              variable: draft_id
            - value_selector:
                - create_draft
                - draft_config
              variable: draft_config
        height: 54
        id: timeline_assembly
        position:
          x: 1600
          y: 282
        positionAbsolute:
          x: 1600
          y: 282
        selected: false
        type: code
        width: 244

      # èŠ‚ç‚¹7: BGMæ¡ä»¶æ£€æŸ¥
      - data:
          logical_operator: "and"
          conditions:
            - comparison_operator: "is"
              id: "bgm_enabled"
              value: true
              variable_selector:
                - timeline_assembly
                - bgm_required
          desc: "æ£€æŸ¥æ˜¯å¦éœ€è¦å¤„ç†BGM"
          selected: false
          title: "BGMæ¡ä»¶æ£€æŸ¥"
          type: if-else
        height: 54
        id: bgm_condition_check
        position:
          x: 1904
          y: 282
        positionAbsolute:
          x: 1904
          y: 282
        selected: false
        type: if-else
        width: 244

      # èŠ‚ç‚¹8: BGMæ™ºèƒ½æ’åºï¼ˆä¿®å¤ç‰ˆï¼‰
      - data:
          code: |
            import json
            import logging
            from typing import List, Dict, Any, Union
            
            # é…ç½®æ—¥å¿—
            logging.basicConfig(level=logging.INFO)
            logger = logging.getLogger(__name__)
            
            def safe_bgm_ranking(bgm_input: Union[List, Dict, str, None]) -> List[Dict]:
                """
                å®‰å…¨çš„BGMæ’åºå‡½æ•° - ä¿®å¤rankå±æ€§è®¾ç½®é”™è¯¯
                
                Args:
                    bgm_input: BGMè¾“å…¥æ•°æ®ï¼Œå¯èƒ½æ˜¯åˆ—è¡¨ã€å­—å…¸ã€å­—ç¬¦ä¸²æˆ–None
                    
                Returns:
                    List[Dict]: æ’åºåçš„BGMåˆ—è¡¨ï¼Œæ¯ä¸ªBGMéƒ½æœ‰rankå±æ€§
                """
                try:
                    logger.info(f"å¼€å§‹BGMå®‰å…¨æ’åºï¼Œè¾“å…¥ç±»å‹: {type(bgm_input)}")
                    
                    # ç¬¬ä¸€æ­¥ï¼šè¾“å…¥éªŒè¯å’Œæ ‡å‡†åŒ–
                    bgm_list = []
                    
                    if bgm_input is None:
                        logger.warning("BGMè¾“å…¥ä¸ºNoneï¼Œè¿”å›ç©ºåˆ—è¡¨")
                        return []
                    
                    # å¤„ç†å­—ç¬¦ä¸²è¾“å…¥ï¼ˆJSONæ ¼å¼ï¼‰
                    if isinstance(bgm_input, str):
                        try:
                            bgm_input = json.loads(bgm_input)
                        except json.JSONDecodeError:
                            logger.error("BGMè¾“å…¥å­—ç¬¦ä¸²ä¸æ˜¯æœ‰æ•ˆçš„JSONæ ¼å¼")
                            return []
                    
                    # å¤„ç†å­—å…¸è¾“å…¥
                    if isinstance(bgm_input, dict):
                        # å°è¯•ä»å­—å…¸ä¸­æå–BGMåˆ—è¡¨
                        for key in ['bgm_candidates', 'bgm_list', 'items', 'data', 'results']:
                            if key in bgm_input and isinstance(bgm_input[key], list):
                                bgm_list = bgm_input[key]
                                break
                        else:
                            # å¦‚æœæ²¡æ‰¾åˆ°åˆ—è¡¨ï¼Œå°†å­—å…¸æœ¬èº«ä½œä¸ºå•ä¸ªBGM
                            bgm_list = [bgm_input]
                    
                    # å¤„ç†åˆ—è¡¨è¾“å…¥
                    elif isinstance(bgm_input, list):
                        bgm_list = bgm_input
                    
                    else:
                        logger.error(f"ä¸æ”¯æŒçš„BGMè¾“å…¥ç±»å‹: {type(bgm_input)}")
                        return []
                    
                    # ç¬¬äºŒæ­¥ï¼šéªŒè¯å’Œæ¸…ç†BGMåˆ—è¡¨
                    safe_bgm_list = []
                    for i, bgm in enumerate(bgm_list):
                        try:
                            # ç¡®ä¿BGMæ˜¯å­—å…¸ç±»å‹
                            if not isinstance(bgm, dict):
                                logger.warning(f"BGMé¡¹ {i} ä¸æ˜¯å­—å…¸ç±»å‹ï¼Œè·³è¿‡: {type(bgm)}")
                                continue
                            
                            # åˆ›å»ºå®‰å…¨çš„BGMå‰¯æœ¬
                            safe_bgm = {}
                            
                            # å¤åˆ¶æ‰€æœ‰å±æ€§
                            for key, value in bgm.items():
                                safe_bgm[key] = value
                            
                            # ç¡®ä¿å¿…è¦çš„å±æ€§å­˜åœ¨
                            safe_bgm.setdefault("score", 0.0)
                            safe_bgm.setdefault("weight", 1.0)
                            safe_bgm.setdefault("bpm", 120)
                            safe_bgm.setdefault("duration", 30)
                            safe_bgm.setdefault("title", f"BGM_{i+1}")
                            safe_bgm.setdefault("id", f"bgm_{i+1}")
                            
                            # ç±»å‹è½¬æ¢å’ŒéªŒè¯
                            try:
                                safe_bgm["score"] = float(safe_bgm["score"])
                                safe_bgm["weight"] = float(safe_bgm["weight"])
                                safe_bgm["bpm"] = int(safe_bgm["bpm"])
                                safe_bgm["duration"] = int(safe_bgm["duration"])
                            except (ValueError, TypeError) as e:
                                logger.warning(f"BGM {i} å±æ€§ç±»å‹è½¬æ¢å¤±è´¥: {e}")
                                # ä½¿ç”¨é»˜è®¤å€¼
                                safe_bgm["score"] = 0.0
                                safe_bgm["weight"] = 1.0
                                safe_bgm["bpm"] = 120
                                safe_bgm["duration"] = 30
                            
                            safe_bgm_list.append(safe_bgm)
                            
                        except Exception as e:
                            logger.error(f"å¤„ç†BGMé¡¹ {i} æ—¶å‘ç”Ÿé”™è¯¯: {e}")
                            continue
                    
                    if not safe_bgm_list:
                        logger.warning("æ²¡æœ‰æœ‰æ•ˆçš„BGMé¡¹ç›®ï¼Œè¿”å›ç©ºåˆ—è¡¨")
                        return []
                    
                    # ç¬¬ä¸‰æ­¥ï¼šæ™ºèƒ½æ’åº
                    logger.info(f"å¼€å§‹å¯¹ {len(safe_bgm_list)} ä¸ªBGMè¿›è¡Œæ’åº")
                    
                    # å¤šç»´åº¦æ’åºç®—æ³•
                    sorted_bgm_list = sorted(safe_bgm_list, key=lambda x: (
                        x["score"] * x["weight"],  # ä¸»è¦æ’åºï¼šåŠ æƒåˆ†æ•°
                        x["bpm"],                  # æ¬¡è¦æ’åºï¼šBPM
                        x["duration"]              # ç¬¬ä¸‰æ’åºï¼šæ—¶é•¿
                    ), reverse=True)
                    
                    # ç¬¬å››æ­¥ï¼šå®‰å…¨åœ°åˆ†é…rankå±æ€§
                    for i, bgm in enumerate(sorted_bgm_list):
                        try:
                            bgm["rank"] = i + 1
                        except Exception as e:
                            logger.error(f"è®¾ç½®BGM rankå¤±è´¥: {e}")
                            # å¦‚æœå­—å…¸è®¾ç½®å¤±è´¥ï¼Œå¼ºåˆ¶åˆ›å»ºæ–°å­—å…¸
                            sorted_bgm_list[i] = dict(bgm)
                            sorted_bgm_list[i]["rank"] = i + 1
                    
                    logger.info(f"BGMæ’åºå®Œæˆï¼Œå…±å¤„ç† {len(sorted_bgm_list)} ä¸ªé¡¹ç›®")
                    return sorted_bgm_list
                    
                except Exception as e:
                    logger.error(f"BGMæ’åºè¿‡ç¨‹ä¸­å‘ç”Ÿä¸¥é‡é”™è¯¯: {e}")
                    return []
            
            def main(timeline_result: str, draft_id: str) -> dict:
                """
                BGMæ™ºèƒ½æ’åºä¸»å‡½æ•°
                """
                try:
                    # è§£ææ—¶é—´è½´ç»“æœ
                    timeline_data = json.loads(timeline_result)
                    
                    # æ¨¡æ‹ŸBGMæœç´¢ç»“æœï¼ˆå®é™…åº”è¯¥ä»BGMæœç´¢APIè·å–ï¼‰
                    mock_bgm_results = [
                        {
                            "id": "bgm_001",
                            "title": "è½»æ¾æ„‰å¿«",
                            "score": 0.95,
                            "weight": 1.2,
                            "bpm": 120,
                            "duration": 30,
                            "style": "ç°ä»£ç®€çº¦",
                            "emotion": "positive",
                            "url": "https://example.com/bgm1.mp3"
                        },
                        {
                            "id": "bgm_002", 
                            "title": "å•†åŠ¡ä¸“ä¸š",
                            "score": 0.88,
                            "weight": 1.0,
                            "bpm": 110,
                            "duration": 35,
                            "style": "å•†åŠ¡ä¸“ä¸š",
                            "emotion": "neutral",
                            "url": "https://example.com/bgm2.mp3"
                        },
                        {
                            "id": "bgm_003",
                            "title": "æ—¶å°šåŠ¨æ„Ÿ",
                            "score": 0.92,
                            "weight": 1.1,
                            "bpm": 128,
                            "duration": 28,
                            "style": "æ—¶å°šæ½®æµ",
                            "emotion": "energetic",
                            "url": "https://example.com/bgm3.mp3"
                        }
                    ]
                    
                    # æ‰§è¡Œå®‰å…¨æ’åº
                    ranked_bgm_list = safe_bgm_ranking(mock_bgm_results)
                    
                    # é€‰æ‹©æœ€ä½³BGMï¼ˆæ’åç¬¬ä¸€çš„ï¼‰
                    selected_bgm = ranked_bgm_list[0] if ranked_bgm_list else None
                    
                    return {
                        "ranked_bgm_list": json.dumps(ranked_bgm_list),
                        "selected_bgm": json.dumps(selected_bgm) if selected_bgm else "{}",
                        "total_bgm_count": len(ranked_bgm_list),
                        "ranking_success": True,
                        "draft_id": draft_id
                    }
                    
                except Exception as e:
                    logger.error(f"BGMæ™ºèƒ½æ’åºå¤±è´¥: {e}")
                    return {
                        "ranked_bgm_list": "[]",
                        "selected_bgm": "{}",
                        "total_bgm_count": 0,
                        "ranking_success": False,
                        "draft_id": draft_id
                    }
          desc: "BGMæ™ºèƒ½æ’åº - ä¿®å¤rankå±æ€§è®¾ç½®é”™è¯¯"
          outputs:
            ranked_bgm_list:
              type: string
            selected_bgm:
              type: string
            total_bgm_count:
              type: number
            ranking_success:
              type: boolean
            draft_id:
              type: string
          selected: false
          title: "BGMæ™ºèƒ½æ’åº"
          type: code
          variables:
            - value_selector:
                - timeline_assembly
                - timeline_result
              variable: timeline_result
            - value_selector:
                - timeline_assembly
                - draft_id
              variable: draft_id
        height: 54
        id: bgm_smart_ranking
        position:
          x: 2208
          y: 150
        positionAbsolute:
          x: 2208
          y: 150
        selected: false
        type: code
        width: 244

      # èŠ‚ç‚¹9: éŸ³é¢‘æ··åˆ
      - data:
          code: |
            import json
            import time
            
            def main(draft_id: str, selected_bgm: str = "{}", ranking_success: bool = False) -> dict:
                """
                éŸ³é¢‘æ··åˆ - å¤„ç†TTSéŸ³é¢‘å’ŒBGM
                """
                try:
                    # è§£æBGMä¿¡æ¯
                    bgm_data = {}
                    if selected_bgm and selected_bgm != "{}":
                        try:
                            bgm_data = json.loads(selected_bgm)
                        except json.JSONDecodeError:
                            bgm_data = {}
                    
                    # æ„å»ºéŸ³é¢‘æ··åˆé…ç½®
                    audio_config = {
                        "draft_id": draft_id,
                        "tts_volume": 0.8,
                        "bgm_volume": 0.3 if bgm_data else 0.0,
                        "bgm_enabled": bool(bgm_data),
                        "bgm_info": bgm_data,
                        "ducking_enabled": True,  # è‡ªåŠ¨é™ä½BGMéŸ³é‡å½“æœ‰è¯­éŸ³æ—¶
                        "fade_in": 2.0,
                        "fade_out": 2.0
                    }
                    
                    # æ¨¡æ‹ŸéŸ³é¢‘æ··åˆå¤„ç†
                    print(f"éŸ³é¢‘æ··åˆ: {draft_id}, BGMå¯ç”¨: {bool(bgm_data)}")
                    
                    mixing_result = {
                        "draft_id": draft_id,
                        "mixing_status": "completed",
                        "bgm_applied": bool(bgm_data),
                        "audio_tracks": 2 if bgm_data else 1,
                        "total_duration": bgm_data.get("duration", 30) if bgm_data else 30,
                        "mixing_time": int(time.time())
                    }
                    
                    return {
                        "mixing_result": json.dumps(mixing_result),
                        "mixing_status": "success",
                        "draft_id": draft_id
                    }
                    
                except Exception as e:
                    return {
                        "mixing_result": json.dumps({"error": str(e)}),
                        "mixing_status": "failed",
                        "draft_id": draft_id
                    }
          desc: "éŸ³é¢‘æ··åˆ - å¤„ç†TTSéŸ³é¢‘å’ŒBGM"
          outputs:
            mixing_result:
              type: string
            mixing_status:
              type: string
            draft_id:
              type: string
          selected: false
          title: "éŸ³é¢‘æ··åˆ"
          type: code
          variables:
            - value_selector:
                - timeline_assembly
                - draft_id
              variable: draft_id
            - value_selector:
                - bgm_smart_ranking
                - selected_bgm
              variable: selected_bgm
            - value_selector:
                - bgm_smart_ranking
                - ranking_success
              variable: ranking_success
        height: 54
        id: audio_mixing
        position:
          x: 2512
          y: 282
        positionAbsolute:
          x: 2512
          y: 282
        selected: false
        type: code
        width: 244

      # èŠ‚ç‚¹10: å­—å¹•å¯¹é½
      - data:
          code: |
            import json
            import time
            
            def main(draft_id: str, mixing_result: str, enable_subtitle: bool = True) -> dict:
                """
                å­—å¹•å¯¹é½å¤„ç†
                """
                try:
                    mixing_data = json.loads(mixing_result)
                    
                    if not enable_subtitle:
                        return {
                            "subtitle_result": json.dumps({"subtitle_enabled": False}),
                            "subtitle_status": "skipped",
                            "draft_id": draft_id
                        }
                    
                    # æ¨¡æ‹Ÿå­—å¹•å¯¹é½å¤„ç†
                    subtitle_result = {
                        "draft_id": draft_id,
                        "subtitle_enabled": True,
                        "subtitle_tracks": 1,
                        "alignment_accuracy": 0.95,
                        "subtitle_count": 8,
                        "processing_time": int(time.time())
                    }
                    
                    print(f"å­—å¹•å¯¹é½å®Œæˆ: {draft_id}")
                    
                    return {
                        "subtitle_result": json.dumps(subtitle_result),
                        "subtitle_status": "success",
                        "draft_id": draft_id
                    }
                    
                except Exception as e:
                    return {
                        "subtitle_result": json.dumps({"error": str(e)}),
                        "subtitle_status": "failed",
                        "draft_id": draft_id
                    }
          desc: "å­—å¹•å¯¹é½å¤„ç†"
          outputs:
            subtitle_result:
              type: string
            subtitle_status:
              type: string
            draft_id:
              type: string
          selected: false
          title: "å­—å¹•å¯¹é½"
          type: code
          variables:
            - value_selector:
                - audio_mixing
                - draft_id
              variable: draft_id
            - value_selector:
                - audio_mixing
                - mixing_result
              variable: mixing_result
            - value_selector:
                - validate_input
                - enable_subtitle
              variable: enable_subtitle
        height: 54
        id: subtitle_alignment
        position:
          x: 2816
          y: 282
        positionAbsolute:
          x: 2816
          y: 282
        selected: false
        type: code
        width: 244

      # èŠ‚ç‚¹11: æäº¤æ¸²æŸ“
      - data:
          code: |
            import json
            import time
            import uuid
            
            def main(draft_id: str, subtitle_result: str) -> dict:
                """
                æäº¤æ¸²æŸ“ä»»åŠ¡
                """
                try:
                    subtitle_data = json.loads(subtitle_result)
                    
                    # ç”Ÿæˆä»»åŠ¡ID
                    task_id = f"render_{int(time.time())}_{str(uuid.uuid4())[:8]}"
                    
                    # æ„å»ºæ¸²æŸ“é…ç½®
                    render_config = {
                        "task_id": task_id,
                        "draft_id": draft_id,
                        "output_format": "mp4",
                        "quality": "1080p",
                        "frame_rate": 30,
                        "bitrate": "5000k",
                        "subtitle_enabled": subtitle_data.get("subtitle_enabled", False)
                    }
                    
                    # æ¨¡æ‹Ÿæäº¤æ¸²æŸ“
                    print(f"æäº¤æ¸²æŸ“ä»»åŠ¡: {task_id}")
                    
                    render_result = {
                        "task_id": task_id,
                        "draft_id": draft_id,
                        "render_status": "submitted",
                        "estimated_time": 180,  # 3åˆ†é’Ÿ
                        "submit_time": int(time.time())
                    }
                    
                    return {
                        "task_id": task_id,
                        "render_status": "submitted",
                        "render_result": json.dumps(render_result)
                    }
                    
                except Exception as e:
                    return {
                        "task_id": "",
                        "render_status": "failed",
                        "render_result": json.dumps({"error": str(e)})
                    }
          desc: "æäº¤æ¸²æŸ“ä»»åŠ¡"
          outputs:
            task_id:
              type: string
            render_status:
              type: string
            render_result:
              type: string
          selected: false
          title: "æäº¤æ¸²æŸ“"
          type: code
          variables:
            - value_selector:
                - subtitle_alignment
                - draft_id
              variable: draft_id
            - value_selector:
                - subtitle_alignment
                - subtitle_result
              variable: subtitle_result
        height: 54
        id: submit_render
        position:
          x: 3120
          y: 282
        positionAbsolute:
          x: 3120
          y: 282
        selected: false
        type: code
        width: 244

      # èŠ‚ç‚¹12: è¿›åº¦ç›‘æ§
      - data:
          code: |
            import json
            import time
            
            def main(task_id: str, render_status: str, render_result: str) -> dict:
                """
                ç›‘æ§æ¸²æŸ“è¿›åº¦
                """
                try:
                    if not task_id or render_status == "failed":
                        return {
                            "final_result": json.dumps({"success": False, "error": "æ¸²æŸ“æäº¤å¤±è´¥"}),
                            "video_url": "",
                            "status": "failed"
                        }
                    
                    # æ¨¡æ‹Ÿè¿›åº¦ç›‘æ§
                    progress_steps = [20, 40, 60, 80, 100]
                    
                    for progress in progress_steps:
                        print(f"æ¸²æŸ“è¿›åº¦: {progress}%")
                        time.sleep(1)  # æ¨¡æ‹Ÿç­‰å¾…
                    
                    # æ¨¡æ‹Ÿæ¸²æŸ“å®Œæˆ
                    final_result = {
                        "success": True,
                        "task_id": task_id,
                        "video_url": f"https://example.com/videos/{task_id}.mp4",
                        "thumbnail_url": f"https://example.com/thumbnails/{task_id}.jpg",
                        "duration": 30,
                        "file_size": "15.2MB",
                        "completion_time": int(time.time())
                    }
                    
                    return {
                        "final_result": json.dumps(final_result),
                        "video_url": final_result["video_url"],
                        "status": "completed"
                    }
                    
                except Exception as e:
                    error_result = {
                        "success": False,
                        "error": str(e),
                        "task_id": task_id
                    }
                    
                    return {
                        "final_result": json.dumps(error_result),
                        "video_url": "",
                        "status": "error"
                    }
          desc: "ç›‘æ§æ¸²æŸ“è¿›åº¦"
          outputs:
            final_result:
              type: string
            video_url:
              type: string
            status:
              type: string
          selected: false
          title: "è¿›åº¦ç›‘æ§"
          type: code
          variables:
            - value_selector:
                - submit_render
                - task_id
              variable: task_id
            - value_selector:
                - submit_render
                - render_status
              variable: render_status
            - value_selector:
                - submit_render
                - render_result
              variable: render_result
        height: 54
        id: monitor_progress
        position:
          x: 3424
          y: 282
        positionAbsolute:
          x: 3424
          y: 282
        selected: false
        type: code
        width: 244

      # èŠ‚ç‚¹13: ç»“æœè¾“å‡º
      - data:
          desc: "è¾“å‡ºæœ€ç»ˆçš„è§†é¢‘ç”Ÿæˆç»“æœ"
          outputs:
            - value_selector:
                - monitor_progress
                - video_url
              variable: video_url
            - value_selector:
                - monitor_progress
                - status
              variable: generation_status
            - value_selector:
                - monitor_progress
                - final_result
              variable: final_result
            - value_selector:
                - timeline_assembly
                - draft_id
              variable: draft_id
            - value_selector:
                - generate_script
                - text
              variable: video_script
          selected: false
          title: "ç»“æœè¾“å‡º"
          type: end
        height: 90
        id: end
        position:
          x: 3728
          y: 282
        positionAbsolute:
          x: 3728
          y: 282
        selected: false
        type: end
        width: 244

  features:
    file_upload:
      image:
        enabled: true
        number_limits: 10
        transfer_methods:
          - local_file
          - remote_url
    opening_statement: |
      ğŸ¬ æ¬¢è¿ä½¿ç”¨æ™ºèƒ½çŸ­è§†é¢‘ç”Ÿæˆå™¨ v2.1 (BGMä¿®å¤ç‰ˆ)ï¼

      è¿™æ˜¯ä¸€ä¸ªä¿®å¤äº†BGMæ’åºé”™è¯¯çš„ä¼˜åŒ–ç‰ˆçŸ­è§†é¢‘å·¥ä½œæµï¼Œå…·æœ‰ä»¥ä¸‹ç‰¹ç‚¹ï¼š
      
      âœ¨ **ä¿®å¤å®Œæˆ**ï¼šè§£å†³äº†"Cannot set properties of undefined (setting 'rank')"é”™è¯¯
      ğŸµ **BGMåˆ†æ”¯**ï¼šå®Œæ•´çš„BGMæ¡ä»¶åˆ†æ”¯å’Œæ™ºèƒ½æ’åºåŠŸèƒ½
      âš¡ **é«˜æ•ˆç”Ÿæˆ**ï¼š3-5åˆ†é’Ÿå®ŒæˆçŸ­è§†é¢‘åˆ¶ä½œ
      ğŸ›¡ï¸ **ç¨³å®šå¯é **ï¼šMCPä¼˜å…ˆï¼ŒHTTPé™çº§ï¼ŒæˆåŠŸç‡â‰¥95%
      ğŸ¯ **æ™ºèƒ½é»˜è®¤**ï¼šå‡å°‘ç”¨æˆ·é…ç½®ï¼Œ5æ­¥å†…å®Œæˆæ“ä½œ

      **ä¿®å¤å†…å®¹ï¼š**
      1. æ·»åŠ äº†BGMæ¡ä»¶æ£€æŸ¥èŠ‚ç‚¹
      2. å®ç°äº†å®Œæ•´çš„BGMæ™ºèƒ½æ’åºåŠŸèƒ½
      3. ä¿®å¤äº†rankå±æ€§è®¾ç½®é”™è¯¯
      4. å¢å¼ºäº†é”™è¯¯å¤„ç†å’Œå®¹é”™æœºåˆ¶

      **ä½¿ç”¨æ­¥éª¤ï¼š**
      1. è¾“å…¥è§†é¢‘ä¸»é¢˜ï¼ˆå¿…å¡«ï¼‰
      2. é€‰æ‹©è§†é¢‘å‚æ•°ï¼ˆå¯é€‰ï¼Œæœ‰æ™ºèƒ½é»˜è®¤å€¼ï¼‰
      3. é€‰æ‹©æ˜¯å¦å¯ç”¨BGM
      4. ç‚¹å‡»å¼€å§‹ç”Ÿæˆ
      5. ç­‰å¾…3-5åˆ†é’Ÿ
      6. è·å–æˆå“è§†é¢‘

      è¯·è¾“å…¥æ‚¨çš„è§†é¢‘ä¸»é¢˜å¼€å§‹åˆ›ä½œå§ï¼
    
    retriever_resource:
      enabled: false
    
    sensitive_word_avoidance:
      enabled: false
    
    speech_to_text:
      enabled: false
    
    suggested_questions:
      - "åˆ¶ä½œä¸€ä¸ª30ç§’çš„äº§å“ä»‹ç»è§†é¢‘ï¼ˆå¯ç”¨BGMï¼‰"
      - "ç”Ÿæˆæ•™è‚²ç§‘æ™®ç±»çŸ­è§†é¢‘ï¼ˆæ— BGMï¼‰"
      - "åˆ›å»ºè¥é”€æ¨å¹¿çŸ­ç‰‡ï¼ˆæ—¶å°šé£æ ¼+BGMï¼‰"
      - "åˆ¶ä½œä¸ªäººvlogé£æ ¼è§†é¢‘ï¼ˆç°ä»£ç®€çº¦ï¼‰"
    
    suggested_questions_after_answer:
      enabled: false
    
    text_to_speech:
      enabled: false
      language: ""
      voice: ""