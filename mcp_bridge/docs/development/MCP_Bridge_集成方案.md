# MCP Bridge 与 Dify 短视频工作流集成方案

## 📋 集成概述

本方案基于您的 PRD 文档，将 MCP Bridge 服务集成到 Dify 短视频工作流中，实现从 40+ 节点简化到 11 个核心节点的优化目标。

### 🎯 优化目标对比

| 指标 | 当前版本 | 优化目标 | MCP Bridge 贡献 |
|------|---------|---------|----------------|
| 节点数量 | 40+ | 11 | 减少素材处理节点 |
| 生成时间 | 8-12分钟 | 3-5分钟 | 并行处理+本地操作 |
| 成功率 | 85% | ≥95% | 降级机制+重试策略 |
| 操作步骤 | 15+ | ≤5 | 智能默认值+批量操作 |

## 🏗️ 架构设计

### 1. 服务状态确认

✅ **MCP Bridge**: http://localhost:8082 (健康)
✅ **CapCut API**: http://localhost:9000 (健康)
⚠️ **CapCut HTTP**: 不健康（但不影响 MCP 功能）

### 2. 集成架构图

```
用户输入 → Dify工作流 → MCP Bridge → CapCut API
    ↓           ↓           ↓           ↓
参数验证    节点编排    协议转换    视频处理
    ↓           ↓           ↓           ↓
内容生成    流程控制    降级机制    素材管理
    ↓           ↓           ↓           ↓
结果输出 ← 状态监控 ← 错误处理 ← 草稿导出
```

## 🔧 核心节点设计（11个节点）

### 节点 1: 用户输入验证
```yaml
节点类型: 开始节点
功能: 参数验证和默认值设置
输入变量:
  - video_topic: 视频主题 (必填)
  - video_duration: 视频时长 (默认30秒)
  - video_style: 视频风格 (默认"现代简约")
  - video_ratio: 视频比例 (默认"9:16")
  - enable_subtitle: 是否添加字幕 (默认true)
  - enable_bgm: 是否添加背景音乐 (默认true)
```

### 节点 2: 内容脚本生成
```yaml
节点类型: LLM节点
模型: 豆包AI
功能: 基于主题生成分镜脚本
输出: 结构化的视频脚本JSON
```

### 节点 3: 并行素材生成启动
```yaml
节点类型: 并行分支
分支1: TTS语音合成
分支2: 字幕文件生成  
分支3: BGM素材准备
分支4: 视觉素材生成
```

### 节点 4: MCP草稿创建
```yaml
节点类型: MCP工具调用
工具: create_draft
参数:
  title: "{{video_script.title}}"
  width: "{{video_width}}"
  height: "{{video_height}}"
降级策略: HTTP API调用
```

### 节点 5: 素材收敛与登记
```yaml
节点类型: 代码执行
功能: 等待所有并行素材完成，批量登记到草稿
MCP工具: batch_add_materials
降级策略: 逐个添加素材
```

### 节点 6: 时间轴装配
```yaml
节点类型: MCP工具调用
功能: 基于音频主时钟进行时间轴装配
工具: timeline_assembly
策略: 语音为主时钟，BGM和字幕对齐
```

### 节点 7: 音频混合处理
```yaml
节点类型: MCP工具调用
功能: 音频轨道混合和音量调节
工具: audio_mixing
包含: TTS + BGM + ducking处理
```

### 节点 8: 字幕对齐
```yaml
节点类型: MCP工具调用
功能: 字幕与最终音频时间戳对齐
工具: subtitle_alignment
```

### 节点 9: 渲染提交
```yaml
节点类型: MCP工具调用
功能: 提交渲染任务
工具: submit_render
降级策略: 仅保存草稿
```

### 节点 10: 进度监控
```yaml
节点类型: 循环节点
功能: 监控渲染进度
策略: 回调优先，轮询降级
```

### 节点 11: 结果输出
```yaml
节点类型: 结束节点
功能: 返回视频下载链接和元数据
输出: video_url, draft_id, metadata
```

## 🔄 降级机制设计

### 1. MCP → HTTP 降级策略

```yaml
降级触发条件:
  - MCP服务不可用
  - 连续3次调用失败
  - 响应时间超过30秒

降级路径:
  create_draft: POST /create_draft
  add_materials: POST /add_video, /add_image, /add_text
  timeline_assembly: POST /timeline_operations
  render_submit: POST /export_video
```

### 2. 健康检查机制

```yaml
检查频率: 每30秒
检查端点: 
  - http://localhost:8082/health
  - http://localhost:9000/health
熔断阈值: 连续5次失败
恢复策略: 指数退避重试
```

## 📊 监控和可观测性

### 1. 关键指标

```yaml
性能指标:
  - 端到端耗时: 目标 ≤300秒
  - 各节点耗时: 分阶段监控
  - 成功率: 目标 ≥95%
  - 重试率: 监控降级频率

业务指标:
  - 用户操作步骤: 目标 ≤5步
  - 参数配置数量: 目标 ≤8个
  - 错误恢复时间: 目标 ≤60秒
```

### 2. 日志记录

```yaml
日志级别:
  - INFO: 正常流程节点
  - WARN: 降级和重试
  - ERROR: 失败和异常
  - DEBUG: 详细调试信息

日志格式:
  timestamp: ISO8601
  workflow_id: 唯一标识
  node_name: 节点名称
  operation: 操作类型
  duration: 执行时长
  status: 成功/失败/重试
```

## 🚀 部署和配置

### 1. Dify MCP 服务器配置

```yaml
服务器名称: CapCut MCP Bridge
服务器URL: http://localhost:8082
服务器标识: capcut-mcp-bridge
描述: 剪映视频编辑MCP桥接服务
超时时间: 30秒
重试次数: 3
健康检查: 启用
```

### 2. 环境变量配置

```bash
# MCP Bridge 配置
MCP_BRIDGE_URL=http://localhost:8082
MCP_BRIDGE_TIMEOUT=30
MCP_BRIDGE_RETRY_COUNT=3

# CapCut API 配置  
CAPCUT_API_URL=http://localhost:9000
CAPCUT_API_TIMEOUT=60

# 降级配置
ENABLE_HTTP_FALLBACK=true
FALLBACK_THRESHOLD=3
```

## 🧪 测试策略

### 1. 单元测试

```yaml
测试范围:
  - MCP工具调用
  - 降级机制触发
  - 错误处理逻辑
  - 参数验证

测试工具:
  - Dify工作流测试
  - MCP Bridge健康检查
  - 模拟故障注入
```

### 2. 集成测试

```yaml
测试场景:
  - 正常流程端到端
  - MCP服务故障降级
  - 网络超时处理
  - 并发请求处理

验收标准:
  - 成功率 ≥95%
  - 响应时间 ≤300秒
  - 降级无数据丢失
  - 错误提示清晰
```

## 📈 性能优化

### 1. 并行处理优化

```yaml
并行任务:
  - TTS语音合成 (30-60秒)
  - 字幕生成 (10-20秒)
  - BGM搜索 (15-30秒)
  - 视觉素材生成 (60-180秒)

收敛策略:
  - 设置超时阈值
  - 部分失败容错
  - 智能重试机制
```

### 2. 缓存策略

```yaml
缓存层级:
  - 脚本模板缓存
  - 素材文件缓存
  - 渲染参数缓存

缓存策略:
  - LRU淘汰算法
  - 24小时过期时间
  - 压缩存储优化
```

## 🔒 安全和合规

### 1. 访问控制

```yaml
API认证:
  - MCP Bridge: 内网访问
  - CapCut API: 本地服务
  
访问限制:
  - IP白名单: 127.0.0.1, 10.0.0.0/8
  - 请求限流: 100次/分钟
  - 并发限制: 10个并发任务
```

### 2. 数据安全

```yaml
数据处理:
  - 临时文件自动清理
  - 敏感信息脱敏
  - 传输加密（内网可选）

隐私保护:
  - 用户数据不持久化
  - 生成内容可选删除
  - 访问日志定期清理
```

## 📞 故障排除

### 常见问题及解决方案

#### 1. MCP服务连接失败
```bash
# 检查服务状态
curl http://localhost:8082/health

# 重启MCP Bridge服务
sudo systemctl restart mcp-bridge.service

# 查看服务日志
sudo journalctl -u mcp-bridge.service -f
```

#### 2. 工作流执行超时
```yaml
排查步骤:
  1. 检查各节点执行时间
  2. 确认并行任务状态
  3. 验证网络连通性
  4. 查看降级机制是否触发
```

#### 3. 渲染质量问题
```yaml
检查项目:
  1. 素材分辨率匹配
  2. 音频采样率一致
  3. 时间轴对齐精度
  4. 编码参数配置
```

---

## 📋 实施计划

### 阶段1: 基础集成 (1-2天)
- [ ] 配置Dify MCP服务器
- [ ] 创建基础工作流模板
- [ ] 实现核心11个节点
- [ ] 基础功能测试

### 阶段2: 优化增强 (2-3天)  
- [ ] 实现降级机制
- [ ] 添加监控和日志
- [ ] 性能调优
- [ ] 压力测试

### 阶段3: 生产部署 (1天)
- [ ] 生产环境配置
- [ ] 安全加固
- [ ] 文档完善
- [ ] 用户培训

**总预计时间: 4-6天**

---

## 🎯 成功标准

- ✅ 节点数量从40+减少到11个
- ✅ 生成时间从8-12分钟缩短到3-5分钟  
- ✅ 成功率从85%提升到95%以上
- ✅ 用户操作步骤从15+减少到5步以内
- ✅ 降级机制100%可用
- ✅ 监控覆盖率100%

通过这个集成方案，您将获得一个高效、稳定、易用的短视频自动生成系统！