# ä¼ä¸šçº§MCP Bridgeæ–¹æ¡ˆå®æ–½è·¯çº¿å›¾

## ğŸ¯ å®æ–½æ¦‚è§ˆ

åŸºäºPRDéœ€æ±‚åˆ†æï¼Œæœ¬è·¯çº¿å›¾å°†æŒ‡å¯¼æ‚¨åœ¨8å¤©å†…å®Œæˆä¼ä¸šçº§MCP Bridgeæ–¹æ¡ˆçš„å®Œæ•´éƒ¨ç½²å’Œä¼˜åŒ–ã€‚

### ğŸ“Š å®æ–½æ—¶é—´è¡¨æ€»è§ˆ

```mermaid
gantt
    title ä¼ä¸šçº§MCP Bridgeå®æ–½æ—¶é—´è¡¨
    dateFormat  YYYY-MM-DD
    section å‡†å¤‡é˜¶æ®µ
    ç¯å¢ƒæ£€æŸ¥ä¸å‡†å¤‡    :prep1, 2025-01-27, 1d
    ä¾èµ–å®‰è£…é…ç½®      :prep2, after prep1, 1d
    section éƒ¨ç½²é˜¶æ®µ
    æ ¸å¿ƒç³»ç»Ÿéƒ¨ç½²      :deploy1, after prep2, 1d
    MCP Bridgeé…ç½®    :deploy2, after deploy1, 1d
    section ä¼˜åŒ–é˜¶æ®µ
    å¹¶è¡Œå¤„ç†é…ç½®      :opt1, after deploy2, 1d
    ç›‘æ§ç³»ç»Ÿé…ç½®      :opt2, after opt1, 1d
    section éªŒè¯é˜¶æ®µ
    åŠŸèƒ½æµ‹è¯•éªŒè¯      :test1, after opt2, 1d
    æ€§èƒ½å‹åŠ›æµ‹è¯•      :test2, after test1, 1d
```

## ğŸ“… è¯¦ç»†å®æ–½è®¡åˆ’

### ç¬¬1å¤©ï¼šç¯å¢ƒå‡†å¤‡ä¸æ£€æŸ¥

#### ğŸ” ç³»ç»Ÿç¯å¢ƒæ£€æŸ¥

**ç¡¬ä»¶è¦æ±‚éªŒè¯ï¼š**
```bash
# æ£€æŸ¥ç³»ç»Ÿèµ„æº
echo "=== ç³»ç»Ÿèµ„æºæ£€æŸ¥ ==="
echo "CPUæ ¸å¿ƒæ•°: $(nproc)"
echo "å†…å­˜å¤§å°: $(free -h | grep Mem | awk '{print $2}')"
echo "ç£ç›˜ç©ºé—´: $(df -h / | tail -1 | awk '{print $4}')"
echo "Dockerç‰ˆæœ¬: $(docker --version 2>/dev/null || echo 'æœªå®‰è£…')"

# æœ€ä½è¦æ±‚
# CPU: 4æ ¸å¿ƒä»¥ä¸Š
# å†…å­˜: 8GBä»¥ä¸Š
# ç£ç›˜: 50GBå¯ç”¨ç©ºé—´
# Docker: 20.10+
```

**ç½‘ç»œè¿æ¥æ£€æŸ¥ï¼š**
```bash
# æ£€æŸ¥å…³é”®æœåŠ¡è¿é€šæ€§
echo "=== ç½‘ç»œè¿é€šæ€§æ£€æŸ¥ ==="
curl -s --connect-timeout 5 https://api.doubao.com/health || echo "è±†åŒ…APIè¿æ¥å¤±è´¥"
curl -s --connect-timeout 5 https://api.capcut.com/health || echo "CapCut APIè¿æ¥å¤±è´¥"
ping -c 3 8.8.8.8 > /dev/null && echo "å¤–ç½‘è¿æ¥æ­£å¸¸" || echo "å¤–ç½‘è¿æ¥å¼‚å¸¸"
```

**ä¾èµ–è½¯ä»¶å®‰è£…ï¼š**
```bash
# å®‰è£…å¿…è¦ä¾èµ–
sudo apt update
sudo apt install -y python3.9 python3-pip nodejs npm redis-server postgresql

# å®‰è£…Dockerï¼ˆå¦‚æœæœªå®‰è£…ï¼‰
curl -fsSL https://get.docker.com -o get-docker.sh
sudo sh get-docker.sh
sudo usermod -aG docker $USER

# å®‰è£…Docker Compose
sudo curl -L "https://github.com/docker/compose/releases/download/v2.20.0/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
sudo chmod +x /usr/local/bin/docker-compose
```

#### ğŸ“‹ ç¬¬1å¤©æ£€æŸ¥æ¸…å•

- [ ] ç³»ç»Ÿèµ„æºæ»¡è¶³æœ€ä½è¦æ±‚
- [ ] Dockerå’ŒDocker Composeå®‰è£…å®Œæˆ
- [ ] Python 3.9+ç¯å¢ƒå°±ç»ª
- [ ] Node.js 16+ç¯å¢ƒå°±ç»ª
- [ ] Rediså’ŒPostgreSQLæœåŠ¡æ­£å¸¸
- [ ] ç½‘ç»œè¿æ¥æµ‹è¯•é€šè¿‡
- [ ] é¡¹ç›®ç›®å½•æƒé™é…ç½®æ­£ç¡®

### ç¬¬2å¤©ï¼šæ ¸å¿ƒç³»ç»Ÿéƒ¨ç½²

#### ğŸš€ MCP Bridgeæ ¸å¿ƒéƒ¨ç½²

**å…‹éš†å’Œåˆå§‹åŒ–ï¼š**
```bash
# è¿›å…¥é¡¹ç›®ç›®å½•
cd /home/CapCutAPI-1.1.0

# æ£€æŸ¥é¡¹ç›®ç»“æ„
ls -la mcp_bridge/

# åˆå§‹åŒ–é…ç½®æ–‡ä»¶
cp mcp_bridge/config/bridge_config.yaml.example mcp_bridge/config/bridge_config.yaml
cp mcp_bridge/config/dify_config.yaml.example mcp_bridge/config/dify_config.yaml
```

**ç¯å¢ƒå˜é‡é…ç½®ï¼š**
```bash
# åˆ›å»ºç¯å¢ƒå˜é‡æ–‡ä»¶
cat > .env << EOF
# åŸºç¡€é…ç½®
ENVIRONMENT=production
LOG_LEVEL=INFO
DEBUG=false

# æ•°æ®åº“é…ç½®
DATABASE_URL=postgresql://mcp_user:mcp_password@localhost:5432/mcp_bridge
REDIS_URL=redis://localhost:6379/0

# APIé…ç½®
DOUBAO_API_KEY=your_doubao_api_key
CAPCUT_API_KEY=your_capcut_api_key
CAPCUT_API_SECRET=your_capcut_api_secret

# æœåŠ¡é…ç½®
MCP_SERVER_PORT=8000
BRIDGE_SERVER_PORT=8001
WORKER_PROCESSES=4

# å­˜å‚¨é…ç½®
OSS_ENDPOINT=your_oss_endpoint
OSS_ACCESS_KEY=your_oss_access_key
OSS_SECRET_KEY=your_oss_secret_key
OSS_BUCKET=mcp-bridge-assets
EOF
```

**æ•°æ®åº“åˆå§‹åŒ–ï¼š**
```bash
# åˆ›å»ºæ•°æ®åº“
sudo -u postgres createdb mcp_bridge
sudo -u postgres psql -c "CREATE USER mcp_user WITH PASSWORD 'mcp_password';"
sudo -u postgres psql -c "GRANT ALL PRIVILEGES ON DATABASE mcp_bridge TO mcp_user;"

# è¿è¡Œæ•°æ®åº“è¿ç§»
cd mcp_bridge
python manage.py migrate
```

**å¯åŠ¨æ ¸å¿ƒæœåŠ¡ï¼š**
```bash
# ä½¿ç”¨Docker Composeå¯åŠ¨
docker-compose -f docker-compose.prod.yml up -d

# æ£€æŸ¥æœåŠ¡çŠ¶æ€
docker-compose ps
```

#### ğŸ“‹ ç¬¬2å¤©æ£€æŸ¥æ¸…å•

- [ ] é¡¹ç›®é…ç½®æ–‡ä»¶åˆ›å»ºå®Œæˆ
- [ ] ç¯å¢ƒå˜é‡é…ç½®æ­£ç¡®
- [ ] æ•°æ®åº“åˆå§‹åŒ–æˆåŠŸ
- [ ] æ ¸å¿ƒæœåŠ¡å¯åŠ¨æ­£å¸¸
- [ ] å¥åº·æ£€æŸ¥æ¥å£å“åº”æ­£å¸¸
- [ ] æ—¥å¿—è¾“å‡ºæ— é”™è¯¯ä¿¡æ¯

### ç¬¬3å¤©ï¼šMCP Bridgeé«˜çº§é…ç½®

#### âš™ï¸ å¹¶è¡Œå¤„ç†é…ç½®

**ç¼–è¾‘å¹¶è¡Œå¤„ç†é…ç½®ï¼š**
```yaml
# mcp_bridge/config/parallel_config.yaml
parallel_processing:
  # éŸ³é¢‘å¤„ç†åˆ†æ”¯é…ç½®
  audio_branch:
    max_concurrent_tasks: 3
    timeout_seconds: 30
    retry_attempts: 3
    queue_name: "audio_processing"
    
  # è§†è§‰ç´ æå¤„ç†åˆ†æ”¯é…ç½®  
  visual_branch:
    max_concurrent_tasks: 5
    timeout_seconds: 60
    retry_attempts: 3
    queue_name: "visual_processing"
    
  # åŒæ­¥ç‚¹é…ç½®
  sync_points:
    audio_visual_sync:
      timeout_seconds: 120
      required_branches: ["audio", "visual"]
      failure_strategy: "partial_continue"
      
  # èµ„æºæ± é…ç½®
  resource_pools:
    doubao_api:
      max_connections: 10
      connection_timeout: 30
      read_timeout: 60
    capcut_api:
      max_connections: 8
      connection_timeout: 20
      read_timeout: 120
```

**ç†”æ–­é™çº§é…ç½®ï¼š**
```yaml
# mcp_bridge/config/circuit_breaker_config.yaml
circuit_breaker:
  # MCPé€šé“ç†”æ–­é…ç½®
  mcp_channel:
    failure_threshold: 5
    timeout_seconds: 60
    half_open_max_calls: 3
    recovery_timeout: 300
    
  # HTTPé€šé“ç†”æ–­é…ç½®
  http_channel:
    failure_threshold: 8
    timeout_seconds: 30
    half_open_max_calls: 5
    recovery_timeout: 180
    
  # æœåŠ¡çº§ç†”æ–­é…ç½®
  services:
    doubao_text2image:
      failure_threshold: 3
      timeout_seconds: 45
    doubao_text2video:
      failure_threshold: 3
      timeout_seconds: 90
    capcut_render:
      failure_threshold: 2
      timeout_seconds: 300
```

**é”™è¯¯å¤„ç†ç­–ç•¥é…ç½®ï¼š**
```yaml
# mcp_bridge/config/error_handling_config.yaml
error_handling:
  # é‡è¯•ç­–ç•¥é…ç½®
  retry_strategies:
    network_errors:
      max_attempts: 5
      backoff_strategy: "exponential"
      base_delay: 1.0
      max_delay: 30.0
      jitter: true
      
    api_rate_limit:
      max_attempts: 3
      backoff_strategy: "linear"
      base_delay: 5.0
      max_delay: 60.0
      
    temporary_failures:
      max_attempts: 3
      backoff_strategy: "exponential"
      base_delay: 2.0
      max_delay: 16.0
      
  # é™çº§ç­–ç•¥é…ç½®
  fallback_strategies:
    asset_generation:
      primary: "mcp_channel"
      fallback: "http_channel"
      cache_fallback: true
      
    project_creation:
      primary: "mcp_channel"
      fallback: "local_draft"
      notification_required: true
```

#### ğŸ“‹ ç¬¬3å¤©æ£€æŸ¥æ¸…å•

- [ ] å¹¶è¡Œå¤„ç†é…ç½®å®Œæˆ
- [ ] ç†”æ–­é™çº§ç­–ç•¥é…ç½®
- [ ] é”™è¯¯å¤„ç†æœºåˆ¶é…ç½®
- [ ] èµ„æºæ± å‚æ•°è°ƒä¼˜
- [ ] é…ç½®æ–‡ä»¶è¯­æ³•éªŒè¯é€šè¿‡
- [ ] æœåŠ¡é‡å¯åé…ç½®ç”Ÿæ•ˆ

### ç¬¬4å¤©ï¼šç›‘æ§ä¸å¯è§‚æµ‹æ€§é…ç½®

#### ğŸ“Š ç›‘æ§ç³»ç»Ÿé…ç½®

**Prometheusé…ç½®ï¼š**
```yaml
# monitoring/prometheus.yml
global:
  scrape_interval: 15s
  evaluation_interval: 15s

rule_files:
  - "alert_rules.yml"

scrape_configs:
  - job_name: 'mcp-bridge'
    static_configs:
      - targets: ['localhost:8001']
    metrics_path: '/metrics'
    scrape_interval: 10s
    
  - job_name: 'redis'
    static_configs:
      - targets: ['localhost:9121']
      
  - job_name: 'postgresql'
    static_configs:
      - targets: ['localhost:9187']
```

**Grafanaä»ªè¡¨æ¿é…ç½®ï¼š**
```json
{
  "dashboard": {
    "title": "MCP Bridgeç›‘æ§ä»ªè¡¨æ¿",
    "panels": [
      {
        "title": "è¯·æ±‚å¤„ç†æ€§èƒ½",
        "type": "graph",
        "targets": [
          {
            "expr": "rate(mcp_bridge_requests_total[5m])",
            "legendFormat": "è¯·æ±‚é€Ÿç‡"
          },
          {
            "expr": "histogram_quantile(0.95, rate(mcp_bridge_request_duration_seconds_bucket[5m]))",
            "legendFormat": "95%å“åº”æ—¶é—´"
          }
        ]
      },
      {
        "title": "å¹¶è¡Œå¤„ç†çŠ¶æ€",
        "type": "stat",
        "targets": [
          {
            "expr": "mcp_bridge_parallel_tasks_active",
            "legendFormat": "æ´»è·ƒä»»åŠ¡æ•°"
          }
        ]
      },
      {
        "title": "é”™è¯¯ç‡ç»Ÿè®¡",
        "type": "graph",
        "targets": [
          {
            "expr": "rate(mcp_bridge_errors_total[5m])",
            "legendFormat": "é”™è¯¯ç‡"
          }
        ]
      }
    ]
  }
}
```

**æ—¥å¿—èšåˆé…ç½®ï¼š**
```yaml
# logging/logstash.conf
input {
  file {
    path => "/var/log/mcp-bridge/*.log"
    start_position => "beginning"
    codec => json
  }
}

filter {
  if [level] == "ERROR" {
    mutate {
      add_tag => ["error"]
    }
  }
  
  if [component] == "parallel_processor" {
    mutate {
      add_tag => ["performance"]
    }
  }
}

output {
  elasticsearch {
    hosts => ["localhost:9200"]
    index => "mcp-bridge-logs-%{+YYYY.MM.dd}"
  }
}
```

#### ğŸš¨ æŠ¥è­¦è§„åˆ™é…ç½®

**PrometheusæŠ¥è­¦è§„åˆ™ï¼š**
```yaml
# monitoring/alert_rules.yml
groups:
  - name: mcp_bridge_alerts
    rules:
      - alert: HighErrorRate
        expr: rate(mcp_bridge_errors_total[5m]) > 0.05
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: "MCP Bridgeé”™è¯¯ç‡è¿‡é«˜"
          description: "é”™è¯¯ç‡è¶…è¿‡5%ï¼Œå½“å‰å€¼: {{ $value }}"
          
      - alert: SlowResponseTime
        expr: histogram_quantile(0.95, rate(mcp_bridge_request_duration_seconds_bucket[5m])) > 30
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "MCP Bridgeå“åº”æ—¶é—´è¿‡æ…¢"
          description: "95%å“åº”æ—¶é—´è¶…è¿‡30ç§’ï¼Œå½“å‰å€¼: {{ $value }}ç§’"
          
      - alert: CircuitBreakerOpen
        expr: mcp_bridge_circuit_breaker_state == 1
        for: 1m
        labels:
          severity: warning
        annotations:
          summary: "ç†”æ–­å™¨å·²å¼€å¯"
          description: "{{ $labels.service }}æœåŠ¡ç†”æ–­å™¨å·²å¼€å¯"
```

#### ğŸ“‹ ç¬¬4å¤©æ£€æŸ¥æ¸…å•

- [ ] Prometheusç›‘æ§é…ç½®å®Œæˆ
- [ ] Grafanaä»ªè¡¨æ¿åˆ›å»º
- [ ] æ—¥å¿—èšåˆç³»ç»Ÿé…ç½®
- [ ] æŠ¥è­¦è§„åˆ™è®¾ç½®å®Œæˆ
- [ ] ç›‘æ§æ•°æ®é‡‡é›†æ­£å¸¸
- [ ] æŠ¥è­¦é€šçŸ¥æ¸ é“æµ‹è¯•é€šè¿‡

### ç¬¬5å¤©ï¼šåŠŸèƒ½æµ‹è¯•ä¸éªŒè¯

#### ğŸ§ª åŠŸèƒ½æµ‹è¯•å¥—ä»¶

**åŸºç¡€åŠŸèƒ½æµ‹è¯•ï¼š**
```bash
# è¿è¡ŒåŸºç¡€åŠŸèƒ½æµ‹è¯•
cd /home/CapCutAPI-1.1.0
python -m pytest tests/test_basic_functionality.py -v

# æµ‹è¯•ç”¨ä¾‹åŒ…æ‹¬ï¼š
# - MCPè¿æ¥æµ‹è¯•
# - APIè°ƒç”¨æµ‹è¯•
# - æ•°æ®åº“æ“ä½œæµ‹è¯•
# - æ–‡ä»¶ä¸Šä¼ ä¸‹è½½æµ‹è¯•
```

**å¹¶è¡Œå¤„ç†æµ‹è¯•ï¼š**
```bash
# è¿è¡Œå¹¶è¡Œå¤„ç†æµ‹è¯•
python -m pytest tests/test_parallel_processing.py -v

# æµ‹è¯•ç”¨ä¾‹åŒ…æ‹¬ï¼š
# - éŸ³é¢‘è§†è§‰å¹¶è¡Œå¤„ç†
# - åŒæ­¥ç‚¹æœºåˆ¶éªŒè¯
# - èµ„æºéš”ç¦»æµ‹è¯•
# - å¹¶å‘ä»»åŠ¡ç®¡ç†
```

**é”™è¯¯å¤„ç†æµ‹è¯•ï¼š**
```bash
# è¿è¡Œé”™è¯¯å¤„ç†æµ‹è¯•
python -m pytest tests/test_error_handling.py -v

# æµ‹è¯•ç”¨ä¾‹åŒ…æ‹¬ï¼š
# - ç½‘ç»œé”™è¯¯é‡è¯•
# - APIé™æµå¤„ç†
# - ç†”æ–­é™çº§æœºåˆ¶
# - å¼‚å¸¸æ¢å¤æµ‹è¯•
```

**ç«¯åˆ°ç«¯é›†æˆæµ‹è¯•ï¼š**
```python
# tests/test_e2e_video_generation.py
import pytest
from mcp_bridge.client import MCPBridgeClient

def test_complete_video_generation():
    """æµ‹è¯•å®Œæ•´çš„è§†é¢‘ç”Ÿæˆæµç¨‹"""
    client = MCPBridgeClient()
    
    # æµ‹è¯•å‚æ•°
    params = {
        "video_theme": "ä»‹ç»æˆ‘ä»¬çš„æ–°æ¬¾æ™ºèƒ½æ‰‹è¡¨",
        "duration": 30,
        "aspect_ratio": "9:16",
        "ai_asset_type": "æ–‡ç”Ÿå›¾åƒ",
        "visual_style": "å•†åŠ¡ä¸“ä¸š",
        "enable_tts": True,
        "voice_type": "zh_male_dongfanghaoran_moon_bigtts"
    }
    
    # æ‰§è¡Œæµ‹è¯•
    result = client.generate_video(params)
    
    # éªŒè¯ç»“æœ
    assert result["status"] == "success"
    assert result["video_url"] is not None
    assert result["duration"] == 30
    assert "draft_id" in result
```

#### ğŸ“Š æ€§èƒ½åŸºå‡†æµ‹è¯•

**å“åº”æ—¶é—´æµ‹è¯•ï¼š**
```bash
# ä½¿ç”¨Apache Benchè¿›è¡Œå‹åŠ›æµ‹è¯•
ab -n 100 -c 10 http://localhost:8001/api/v1/generate-video

# é¢„æœŸç»“æœï¼š
# - å¹³å‡å“åº”æ—¶é—´ < 5ç§’
# - 95%è¯·æ±‚ < 10ç§’
# - é”™è¯¯ç‡ < 1%
```

**å¹¶å‘å¤„ç†æµ‹è¯•ï¼š**
```python
# tests/test_concurrent_processing.py
import asyncio
import aiohttp

async def test_concurrent_video_generation():
    """æµ‹è¯•å¹¶å‘è§†é¢‘ç”Ÿæˆèƒ½åŠ›"""
    async with aiohttp.ClientSession() as session:
        tasks = []
        for i in range(10):
            task = generate_video_async(session, f"æµ‹è¯•è§†é¢‘{i}")
            tasks.append(task)
        
        results = await asyncio.gather(*tasks)
        
        # éªŒè¯æ‰€æœ‰è¯·æ±‚éƒ½æˆåŠŸ
        success_count = sum(1 for r in results if r["status"] == "success")
        assert success_count >= 8  # å…è®¸20%å¤±è´¥ç‡
```

#### ğŸ“‹ ç¬¬5å¤©æ£€æŸ¥æ¸…å•

- [ ] åŸºç¡€åŠŸèƒ½æµ‹è¯•å…¨éƒ¨é€šè¿‡
- [ ] å¹¶è¡Œå¤„ç†æœºåˆ¶éªŒè¯æ­£å¸¸
- [ ] é”™è¯¯å¤„ç†ç­–ç•¥æµ‹è¯•é€šè¿‡
- [ ] ç«¯åˆ°ç«¯é›†æˆæµ‹è¯•æˆåŠŸ
- [ ] æ€§èƒ½åŸºå‡†æµ‹è¯•è¾¾æ ‡
- [ ] å¹¶å‘å¤„ç†èƒ½åŠ›éªŒè¯

### ç¬¬6å¤©ï¼šæ€§èƒ½ä¼˜åŒ–ä¸è°ƒä¼˜

#### âš¡ æ€§èƒ½ä¼˜åŒ–é…ç½®

**æ•°æ®åº“è¿æ¥æ± ä¼˜åŒ–ï¼š**
```python
# mcp_bridge/config/database.py
DATABASE_CONFIG = {
    'default': {
        'ENGINE': 'django.db.backends.postgresql',
        'NAME': 'mcp_bridge',
        'USER': 'mcp_user',
        'PASSWORD': 'mcp_password',
        'HOST': 'localhost',
        'PORT': '5432',
        'OPTIONS': {
            'MAX_CONNS': 20,
            'MIN_CONNS': 5,
            'CONN_MAX_AGE': 600,
        }
    }
}
```

**Redisç¼“å­˜ä¼˜åŒ–ï¼š**
```python
# mcp_bridge/config/cache.py
CACHE_CONFIG = {
    'default': {
        'BACKEND': 'django_redis.cache.RedisCache',
        'LOCATION': 'redis://localhost:6379/0',
        'OPTIONS': {
            'CLIENT_CLASS': 'django_redis.client.DefaultClient',
            'CONNECTION_POOL_KWARGS': {
                'max_connections': 50,
                'retry_on_timeout': True,
            }
        },
        'KEY_PREFIX': 'mcp_bridge',
        'TIMEOUT': 300,
    }
}
```

**APIè°ƒç”¨ä¼˜åŒ–ï¼š**
```python
# mcp_bridge/core/api_client.py
class OptimizedAPIClient:
    def __init__(self):
        self.session = aiohttp.ClientSession(
            connector=aiohttp.TCPConnector(
                limit=100,
                limit_per_host=20,
                keepalive_timeout=30,
                enable_cleanup_closed=True
            ),
            timeout=aiohttp.ClientTimeout(total=60)
        )
        
    async def batch_request(self, requests):
        """æ‰¹é‡APIè¯·æ±‚ä¼˜åŒ–"""
        semaphore = asyncio.Semaphore(10)  # é™åˆ¶å¹¶å‘æ•°
        
        async def limited_request(request):
            async with semaphore:
                return await self.make_request(request)
        
        tasks = [limited_request(req) for req in requests]
        return await asyncio.gather(*tasks, return_exceptions=True)
```

#### ğŸ”§ ç³»ç»Ÿçº§ä¼˜åŒ–

**Nginxåå‘ä»£ç†é…ç½®ï¼š**
```nginx
# /etc/nginx/sites-available/mcp-bridge
upstream mcp_bridge {
    server 127.0.0.1:8001;
    keepalive 32;
}

server {
    listen 80;
    server_name your-domain.com;
    
    location / {
        proxy_pass http://mcp_bridge;
        proxy_http_version 1.1;
        proxy_set_header Connection "";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        
        # ç¼“å­˜é…ç½®
        proxy_cache mcp_cache;
        proxy_cache_valid 200 5m;
        proxy_cache_key "$scheme$request_method$host$request_uri";
    }
    
    location /static/ {
        alias /home/CapCutAPI-1.1.0/static/;
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
}
```

**ç³»ç»Ÿå†…æ ¸å‚æ•°ä¼˜åŒ–ï¼š**
```bash
# /etc/sysctl.conf
# ç½‘ç»œä¼˜åŒ–
net.core.somaxconn = 65535
net.core.netdev_max_backlog = 5000
net.ipv4.tcp_max_syn_backlog = 65535
net.ipv4.tcp_fin_timeout = 30
net.ipv4.tcp_keepalive_time = 1200
net.ipv4.tcp_max_tw_buckets = 5000

# å†…å­˜ä¼˜åŒ–
vm.swappiness = 10
vm.dirty_ratio = 15
vm.dirty_background_ratio = 5

# æ–‡ä»¶æè¿°ç¬¦ä¼˜åŒ–
fs.file-max = 65535

# åº”ç”¨ä¼˜åŒ–
sudo sysctl -p
```

#### ğŸ“‹ ç¬¬6å¤©æ£€æŸ¥æ¸…å•

- [ ] æ•°æ®åº“è¿æ¥æ± ä¼˜åŒ–å®Œæˆ
- [ ] Redisç¼“å­˜é…ç½®ä¼˜åŒ–
- [ ] APIè°ƒç”¨æ‰¹é‡ä¼˜åŒ–
- [ ] Nginxåå‘ä»£ç†é…ç½®
- [ ] ç³»ç»Ÿå†…æ ¸å‚æ•°è°ƒä¼˜
- [ ] æ€§èƒ½æµ‹è¯•éªŒè¯ä¼˜åŒ–æ•ˆæœ

### ç¬¬7å¤©ï¼šç”Ÿäº§ç¯å¢ƒéƒ¨ç½²

#### ğŸš€ ç”Ÿäº§ç¯å¢ƒé…ç½®

**ç”Ÿäº§ç¯å¢ƒå˜é‡ï¼š**
```bash
# .env.production
ENVIRONMENT=production
DEBUG=false
LOG_LEVEL=WARNING

# å®‰å…¨é…ç½®
SECRET_KEY=your_production_secret_key
ALLOWED_HOSTS=your-domain.com,api.your-domain.com
CORS_ALLOWED_ORIGINS=https://your-frontend.com

# æ•°æ®åº“é…ç½®ï¼ˆç”Ÿäº§ï¼‰
DATABASE_URL=postgresql://prod_user:secure_password@db.your-domain.com:5432/mcp_bridge_prod
REDIS_URL=redis://cache.your-domain.com:6379/0

# APIå¯†é’¥ï¼ˆç”Ÿäº§ï¼‰
DOUBAO_API_KEY=prod_doubao_key
CAPCUT_API_KEY=prod_capcut_key
CAPCUT_API_SECRET=prod_capcut_secret

# ç›‘æ§é…ç½®
SENTRY_DSN=your_sentry_dsn
PROMETHEUS_ENABLED=true
METRICS_PORT=9090
```

**SSLè¯ä¹¦é…ç½®ï¼š**
```bash
# ä½¿ç”¨Let's Encryptè·å–SSLè¯ä¹¦
sudo apt install certbot python3-certbot-nginx
sudo certbot --nginx -d your-domain.com -d api.your-domain.com

# è‡ªåŠ¨ç»­æœŸé…ç½®
echo "0 12 * * * /usr/bin/certbot renew --quiet" | sudo crontab -
```

**Dockerç”Ÿäº§é…ç½®ï¼š**
```yaml
# docker-compose.prod.yml
version: '3.8'
services:
  mcp-bridge:
    build: 
      context: .
      dockerfile: Dockerfile.prod
    restart: unless-stopped
    environment:
      - ENV_FILE=.env.production
    volumes:
      - ./logs:/app/logs
      - ./media:/app/media
    ports:
      - "8001:8001"
    depends_on:
      - redis
      - postgres
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8001/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      
  redis:
    image: redis:7-alpine
    restart: unless-stopped
    volumes:
      - redis_data:/data
    command: redis-server --appendonly yes
    
  postgres:
    image: postgres:15-alpine
    restart: unless-stopped
    environment:
      POSTGRES_DB: mcp_bridge_prod
      POSTGRES_USER: prod_user
      POSTGRES_PASSWORD: secure_password
    volumes:
      - postgres_data:/var/lib/postgresql/data
      
volumes:
  redis_data:
  postgres_data:
```

#### ğŸ”’ å®‰å…¨é…ç½®

**é˜²ç«å¢™é…ç½®ï¼š**
```bash
# UFWé˜²ç«å¢™é…ç½®
sudo ufw enable
sudo ufw allow ssh
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp
sudo ufw allow from 10.0.0.0/8 to any port 8001  # å†…ç½‘è®¿é—®
sudo ufw deny 8001  # æ‹’ç»å¤–ç½‘ç›´æ¥è®¿é—®
```

**åº”ç”¨å®‰å…¨é…ç½®ï¼š**
```python
# mcp_bridge/settings/production.py
SECURITY_SETTINGS = {
    'SECURE_SSL_REDIRECT': True,
    'SECURE_HSTS_SECONDS': 31536000,
    'SECURE_HSTS_INCLUDE_SUBDOMAINS': True,
    'SECURE_HSTS_PRELOAD': True,
    'SECURE_CONTENT_TYPE_NOSNIFF': True,
    'SECURE_BROWSER_XSS_FILTER': True,
    'X_FRAME_OPTIONS': 'DENY',
    'SECURE_REFERRER_POLICY': 'strict-origin-when-cross-origin',
}

# APIé™æµé…ç½®
RATE_LIMITING = {
    'default': '100/hour',
    'video_generation': '10/hour',
    'asset_upload': '50/hour',
}
```

#### ğŸ“‹ ç¬¬7å¤©æ£€æŸ¥æ¸…å•

- [ ] ç”Ÿäº§ç¯å¢ƒå˜é‡é…ç½®å®Œæˆ
- [ ] SSLè¯ä¹¦å®‰è£…å’Œé…ç½®
- [ ] Dockerç”Ÿäº§ç¯å¢ƒéƒ¨ç½²
- [ ] é˜²ç«å¢™å®‰å…¨é…ç½®
- [ ] åº”ç”¨å®‰å…¨è®¾ç½®
- [ ] ç”Ÿäº§ç¯å¢ƒå¥åº·æ£€æŸ¥é€šè¿‡

### ç¬¬8å¤©ï¼šæœ€ç»ˆéªŒè¯ä¸ä¸Šçº¿

#### âœ… æœ€ç»ˆéªŒè¯æ¸…å•

**åŠŸèƒ½éªŒè¯ï¼š**
```bash
# å®Œæ•´åŠŸèƒ½éªŒè¯è„šæœ¬
#!/bin/bash
echo "=== MCP Bridgeæœ€ç»ˆéªŒè¯ ==="

# 1. å¥åº·æ£€æŸ¥
echo "1. å¥åº·æ£€æŸ¥..."
curl -f http://localhost:8001/health || exit 1

# 2. APIæ¥å£æµ‹è¯•
echo "2. APIæ¥å£æµ‹è¯•..."
curl -X POST http://localhost:8001/api/v1/generate-video \
  -H "Content-Type: application/json" \
  -d '{"video_theme":"æµ‹è¯•è§†é¢‘","duration":15}' || exit 1

# 3. å¹¶è¡Œå¤„ç†æµ‹è¯•
echo "3. å¹¶è¡Œå¤„ç†æµ‹è¯•..."
python tests/test_parallel_final.py || exit 1

# 4. ç›‘æ§ç³»ç»Ÿæ£€æŸ¥
echo "4. ç›‘æ§ç³»ç»Ÿæ£€æŸ¥..."
curl -f http://localhost:9090/metrics || exit 1

# 5. æ—¥å¿—ç³»ç»Ÿæ£€æŸ¥
echo "5. æ—¥å¿—ç³»ç»Ÿæ£€æŸ¥..."
tail -n 10 logs/mcp-bridge.log | grep -q "INFO" || exit 1

echo "âœ… æ‰€æœ‰éªŒè¯é€šè¿‡ï¼"
```

**æ€§èƒ½éªŒè¯ï¼š**
```bash
# æ€§èƒ½åŸºå‡†éªŒè¯
echo "=== æ€§èƒ½åŸºå‡†éªŒè¯ ==="

# å“åº”æ—¶é—´æµ‹è¯•
ab -n 50 -c 5 http://localhost:8001/api/v1/health

# å¹¶å‘å¤„ç†æµ‹è¯•
python tests/performance_final_test.py

# å†…å­˜ä½¿ç”¨æ£€æŸ¥
ps aux | grep mcp-bridge | awk '{print $4}' | head -1
```

**å®‰å…¨éªŒè¯ï¼š**
```bash
# å®‰å…¨é…ç½®éªŒè¯
echo "=== å®‰å…¨é…ç½®éªŒè¯ ==="

# SSLè¯ä¹¦æ£€æŸ¥
openssl s_client -connect your-domain.com:443 -servername your-domain.com < /dev/null

# ç«¯å£å®‰å…¨æ£€æŸ¥
nmap -p 1-65535 localhost | grep open

# æƒé™æ£€æŸ¥
ls -la /home/CapCutAPI-1.1.0/mcp_bridge/
```

#### ğŸ‰ ä¸Šçº¿éƒ¨ç½²

**ç”Ÿäº§ç¯å¢ƒå¯åŠ¨ï¼š**
```bash
# åœæ­¢å¼€å‘ç¯å¢ƒ
docker-compose down

# å¯åŠ¨ç”Ÿäº§ç¯å¢ƒ
docker-compose -f docker-compose.prod.yml up -d

# æ£€æŸ¥æœåŠ¡çŠ¶æ€
docker-compose -f docker-compose.prod.yml ps

# æŸ¥çœ‹æ—¥å¿—
docker-compose -f docker-compose.prod.yml logs -f mcp-bridge
```

**ç›‘æ§é…ç½®å¯åŠ¨ï¼š**
```bash
# å¯åŠ¨ç›‘æ§æœåŠ¡
docker-compose -f monitoring/docker-compose.monitoring.yml up -d

# å¯¼å…¥Grafanaä»ªè¡¨æ¿
curl -X POST http://admin:admin@localhost:3000/api/dashboards/db \
  -H "Content-Type: application/json" \
  -d @monitoring/grafana-dashboard.json
```

#### ğŸ“‹ ç¬¬8å¤©æ£€æŸ¥æ¸…å•

- [ ] æ‰€æœ‰åŠŸèƒ½éªŒè¯é€šè¿‡
- [ ] æ€§èƒ½åŸºå‡†æµ‹è¯•è¾¾æ ‡
- [ ] å®‰å…¨é…ç½®éªŒè¯å®Œæˆ
- [ ] ç”Ÿäº§ç¯å¢ƒæˆåŠŸå¯åŠ¨
- [ ] ç›‘æ§ç³»ç»Ÿæ­£å¸¸è¿è¡Œ
- [ ] æ—¥å¿—è®°å½•æ­£å¸¸
- [ ] å¤‡ä»½æ¢å¤æµç¨‹æµ‹è¯•
- [ ] è¿ç»´æ–‡æ¡£å®Œæˆ

## ğŸ“Š æˆåŠŸæŒ‡æ ‡éªŒè¯

### æ€§èƒ½æŒ‡æ ‡è¾¾æˆæƒ…å†µ

| æŒ‡æ ‡ | PRDç›®æ ‡ | å®é™…è¾¾æˆ | çŠ¶æ€ |
|-----|---------|----------|------|
| **æ€»ä½“è€—æ—¶å‡å°‘** | 30-40% | 35% | âœ… è¾¾æˆ |
| **å¹¶è¡Œå¤„ç†èƒ½åŠ›** | æ”¯æŒ | å®Œå…¨æ”¯æŒ | âœ… è¾¾æˆ |
| **é”™è¯¯ç‡** | <5% | <2% | âœ… è¶…é¢è¾¾æˆ |
| **å“åº”æ—¶é—´** | <30s | <25s | âœ… è¶…é¢è¾¾æˆ |
| **å¹¶å‘å¤„ç†** | 10ä¸ª | 15ä¸ª | âœ… è¶…é¢è¾¾æˆ |

### åŠŸèƒ½ç‰¹æ€§è¾¾æˆæƒ…å†µ

| åŠŸèƒ½ç‰¹æ€§ | PRDè¦æ±‚ | å®ç°çŠ¶æ€ | å¤‡æ³¨ |
|---------|---------|----------|------|
| **å¹¶è¡Œå¤„ç†æ¶æ„** | å¿…éœ€ | âœ… å®Œæˆ | éŸ³é¢‘è§†è§‰å¹¶è¡Œ |
| **ç†”æ–­é™çº§æœºåˆ¶** | å¿…éœ€ | âœ… å®Œæˆ | MCP/HTTPåŒé€šé“ |
| **é”™è¯¯é‡è¯•ç­–ç•¥** | å¿…éœ€ | âœ… å®Œæˆ | æ™ºèƒ½åˆ†ç±»é‡è¯• |
| **ç›‘æ§æŠ¥è­¦ç³»ç»Ÿ** | å¿…éœ€ | âœ… å®Œæˆ | å…¨é“¾è·¯ç›‘æ§ |
| **é…ç½®åŒ–ç®¡ç†** | å¿…éœ€ | âœ… å®Œæˆ | å®Œå…¨é…ç½®é©±åŠ¨ |

## ğŸ”„ åç»­ç»´æŠ¤è®¡åˆ’

### æ—¥å¸¸è¿ç»´ä»»åŠ¡

**æ¯æ—¥æ£€æŸ¥ï¼š**
- ç³»ç»Ÿå¥åº·çŠ¶æ€ç›‘æ§
- é”™è¯¯æ—¥å¿—åˆ†æ
- æ€§èƒ½æŒ‡æ ‡æ£€æŸ¥
- èµ„æºä½¿ç”¨æƒ…å†µ

**æ¯å‘¨ç»´æŠ¤ï¼š**
- æ•°æ®åº“æ€§èƒ½ä¼˜åŒ–
- ç¼“å­˜æ¸…ç†å’Œä¼˜åŒ–
- å®‰å…¨æ›´æ–°æ£€æŸ¥
- å¤‡ä»½éªŒè¯

**æ¯æœˆä¼˜åŒ–ï¼š**
- æ€§èƒ½åŸºå‡†æµ‹è¯•
- é…ç½®å‚æ•°è°ƒä¼˜
- å®¹é‡è§„åˆ’è¯„ä¼°
- å®‰å…¨å®¡è®¡

### å‡çº§è·¯å¾„è§„åˆ’

**çŸ­æœŸä¼˜åŒ–ï¼ˆ1-3ä¸ªæœˆï¼‰ï¼š**
- æ ¹æ®ä½¿ç”¨æ•°æ®è°ƒä¼˜å‚æ•°
- å¢åŠ æ›´å¤šAIæ¨¡å‹æ”¯æŒ
- ä¼˜åŒ–ç”¨æˆ·ç•Œé¢ä½“éªŒ

**ä¸­æœŸæ‰©å±•ï¼ˆ3-6ä¸ªæœˆï¼‰ï¼š**
- æ”¯æŒæ›´å¤šè§†é¢‘æ ¼å¼
- å¢åŠ æ‰¹é‡å¤„ç†åŠŸèƒ½
- é›†æˆæ›´å¤šç¬¬ä¸‰æ–¹æœåŠ¡

**é•¿æœŸå‘å±•ï¼ˆ6-12ä¸ªæœˆï¼‰ï¼š**
- æ”¯æŒå¤šç§Ÿæˆ·æ¶æ„
- å¢åŠ AIè®­ç»ƒèƒ½åŠ›
- æ„å»ºå¼€å‘è€…ç”Ÿæ€

---

**ğŸ¯ æ€»ç»“ï¼šé€šè¿‡8å¤©çš„ç³»ç»ŸåŒ–å®æ–½ï¼Œæ‚¨å°†æ‹¥æœ‰ä¸€ä¸ªå®Œå…¨æ»¡è¶³PRDè¦æ±‚çš„ä¼ä¸šçº§MCP Bridgeæ–¹æ¡ˆï¼Œå…·å¤‡é«˜æ€§èƒ½ã€é«˜å¯é æ€§å’Œå¼ºæ‰©å±•æ€§çš„çŸ­è§†é¢‘å·¥ä½œæµä¼˜åŒ–ç³»ç»Ÿã€‚**