# 自定义下载功能修复测试指南

## 📅 修复完成日期
2025-11-01

## ✅ 已完成的修复

### 1. 修复代理URL参数传递问题 ✓
**文件**: `capcut_server.py` (第3293-3299行)

**修复内容**:
- 在代理下载URL中添加了 `client_os` 和 `draft_folder` 查询参数
- 使用 `urllib.parse.urlencode` 确保参数正确编码

**修复代码**:
```python
from urllib.parse import urlencode
params = urlencode({
    'client_os': client_os,
    'draft_folder': draft_folder
})
proxy_download_url = f"/api/draft/download/proxy/{draft_id}?{params}"
```

---

### 2. 在前端下载请求中添加client_os参数 ✓
**文件**: `templates/preview.html` (第1872-1886行)

**修复内容**:
- 在 `startCustomDownload()` 函数中添加了客户端操作系统检测
- 将 `client_os` 参数传递给后端API

**修复代码**:
```javascript
// 检测客户端操作系统
const clientOS = detectClientOS();

// 调用自定义下载API
return fetch('/api/draft/download', {
    method: 'POST',
    headers: {
        'Content-Type': 'application/json'
    },
    body: JSON.stringify({
        draft_id: draftId,
        use_custom_path: true,
        draft_folder: customPath,
        client_os: clientOS  // ✅ 新添加
    })
});
```

---

### 3. 在前端路径配置中添加client_os参数 ✓
**文件**: `templates/preview.html` (第1698-1710行)

**修复内容**:
- 在 `savePathConfig()` 函数中添加了客户端操作系统检测
- 配置路径时将 `client_os` 发送给后端，用于跨平台验证

**修复代码**:
```javascript
// 检测客户端操作系统
const clientOS = detectClientOS();

fetch('/api/draft/path/config', {
    method: 'POST',
    headers: {
        'Content-Type': 'application/json'
    },
    body: JSON.stringify({
        custom_path: newPath,
        client_os: clientOS  // ✅ 新添加
    })
})
```

---

### 4. 改进跨平台路径验证逻辑 ✓
**文件**: `capcut_server.py` (第3197-3221行)

**修复内容**:
- 添加了跨平台路径检测逻辑
- Windows路径（如 `F:\jianying\...`）在Linux服务器上不再进行物理验证
- 只对本地路径进行 `os.makedirs()` 验证

**修复代码**:
```python
client_os = data.get('client_os', 'unknown')

# 路径验证逻辑
if custom_path:
    # 检查是否为跨平台路径
    import re
    is_cross_platform = False
    
    # 检测Windows路径特征（盘符开头，如 C:\, D:\, F:\）
    if client_os == 'windows' and re.match(r'^[A-Za-z]:\\', custom_path):
        is_cross_platform = True
        print(f"检测到跨平台路径配置: Windows路径 '{custom_path}' 在 Linux 服务器上")
    
    # 如果不是跨平台路径，才进行物理验证
    if not is_cross_platform:
        try:
            os.makedirs(custom_path, exist_ok=True)
        except Exception as e:
            return jsonify({
                'success': False,
                'error': f'无法创建或访问路径: {str(e)}'
            }), 400
    else:
        # 跨平台路径只做格式验证，不进行物理验证
        print(f"跳过跨平台路径的物理验证: {custom_path}")
```

---

### 5. 清理未使用的代码 ✓
**文件**: `templates/preview.html`

**修复内容**:
- 删除了未使用的 `customPathDownload()` 函数（原第1561-1627行）
- 减少代码冗余，避免维护混淆

---

## 🧪 测试步骤

### 测试场景1: Windows用户配置路径并下载

#### 步骤:
1. 在Windows浏览器中打开草稿预览页面
   ```
   http://localhost:9000/preview/<draft_id>
   ```

2. 点击 "⚙️ 配置路径" 按钮

3. 输入Windows路径（例如）：
   ```
   F:\jianying\cgwz\JianyingPro Drafts
   ```

4. 点击 "确定" 保存配置

5. 点击 "📥 自定义下载" 按钮

6. 等待下载完成

#### 预期结果:
- ✅ 路径配置成功（不报错）
- ✅ 下载开始（浏览器提示下载ZIP文件）
- ✅ 下载的文件名为: `<draft_id>.zip`
- ✅ 解压ZIP后，`draft_info.json` 中包含Windows格式路径
  ```json
  {
    "replace_path": "F:\\jianying\\cgwz\\JianyingPro Drafts\\<draft_id>\\assets\\..."
  }
  ```

#### 验证方法:
```bash
# 解压下载的ZIP文件
unzip <draft_id>.zip -d test_extract

# 查看draft_info.json中的路径
cat test_extract/draft_info.json | grep "replace_path" | head -3

# 应该看到类似：
# "replace_path": "F:\\jianying\\cgwz\\JianyingPro Drafts\\dfd_xxx\\assets\\image\\xxx.png"
```

---

### 测试场景2: Linux用户配置路径并下载

#### 步骤:
1. 在Linux浏览器中打开草稿预览页面

2. 点击 "⚙️ 配置路径" 按钮

3. 输入Linux路径（例如）：
   ```
   /home/user/JianyingPro Drafts
   ```

4. 点击 "确定" 保存配置

5. 点击 "📥 自定义下载" 按钮

6. 等待下载完成

#### 预期结果:
- ✅ 路径配置成功
- ✅ 下载成功
- ✅ `draft_info.json` 中包含Linux格式路径
  ```json
  {
    "replace_path": "/home/user/JianyingPro Drafts/<draft_id>/assets/..."
  }
  ```

---

### 测试场景3: 检查代理URL参数

#### 步骤:
1. 配置自定义路径后，打开浏览器开发者工具（F12）

2. 切换到 "Network" (网络) 标签

3. 点击 "📥 自定义下载" 按钮

4. 查找对 `/api/draft/download` 的POST请求

5. 查看响应中的 `download_url` 字段

#### 预期结果:
代理URL应包含查询参数：
```
/api/draft/download/proxy/<draft_id>?client_os=windows&draft_folder=F%3A%5Cjianying%5Ccgwz%5CJianyingPro+Drafts
```

或者（Linux）：
```
/api/draft/download/proxy/<draft_id>?client_os=linux&draft_folder=%2Fhome%2Fuser%2FJianyingPro+Drafts
```

---

### 测试场景4: 验证跨平台路径配置

#### 在Linux服务器上测试Windows路径配置:

```bash
# 启动Python测试
cd /home/CapCutAPI-1.1.0

# 测试配置Windows路径
curl -X POST http://localhost:9000/api/draft/path/config \
  -H "Content-Type: application/json" \
  -d '{
    "custom_path": "F:\\jianying\\cgwz\\JianyingPro Drafts",
    "client_os": "windows"
  }'

# 预期响应：
# {
#   "success": true,
#   "message": "路径配置已更新",
#   "custom_path": "F:\\jianying\\cgwz\\JianyingPro Drafts"
# }
```

#### 查看服务器日志:
```bash
tail -f logs/capcutapi.log

# 应该看到：
# 检测到跨平台路径配置: Windows路径 'F:\jianying\cgwz\JianyingPro Drafts' 在 Linux 服务器上
# 跳过跨平台路径的物理验证: F:\jianying\cgwz\JianyingPro Drafts
```

---

## 🔍 检查点清单

### 前端检查
- [ ] `detectClientOS()` 函数正确识别操作系统
- [ ] 下载请求包含 `client_os` 参数
- [ ] 路径配置请求包含 `client_os` 参数
- [ ] 浏览器控制台无JavaScript错误

### 后端检查
- [ ] 代理URL包含 `client_os` 和 `draft_folder` 参数
- [ ] Windows路径在Linux服务器上不报"无法创建目录"错误
- [ ] 自定义ZIP正确生成（基于client_os和draft_folder哈希）
- [ ] 服务器日志显示跨平台路径检测信息

### 下载文件检查
- [ ] ZIP文件成功下载到浏览器下载文件夹
- [ ] 文件名格式正确: `<draft_id>.zip`
- [ ] 解压后包含 `draft_info.json`
- [ ] `draft_info.json` 中的路径格式与配置的操作系统匹配

---

## 🐛 可能的问题和解决方案

### 问题1: 下载时提示"请先配置下载路径"
**原因**: 未配置路径或配置未保存

**解决**:
1. 先点击"⚙️ 配置路径"
2. 输入有效路径
3. 确保看到"路径配置成功"提示
4. 再点击"📥 自定义下载"

---

### 问题2: 代理下载返回404
**原因**: OSS上不存在基础ZIP文件

**解决**:
1. 检查草稿是否已成功生成
2. 确认OSS上存在 `<draft_id>.zip`
3. 查看服务器日志获取详细错误信息

---

### 问题3: 下载的ZIP路径格式不正确
**原因**: 可能是client_os参数传递错误

**检查**:
1. 打开浏览器开发者工具
2. 查看Network请求中的 `client_os` 值
3. 确认与实际操作系统匹配

**修复**:
- 清除浏览器缓存重新加载页面
- 检查 `detectClientOS()` 函数是否正常工作

---

## 📊 性能和缓存优化

### OSS自定义ZIP缓存机制

系统会根据以下信息生成唯一的缓存键：
```python
key_suffix = _hash_str(f"{client_os}|{draft_folder}")
custom_key = f"{draft_id}__{client_os}__{key_suffix}.zip"
```

**示例**:
- 基础ZIP: `dfd_cat_1761981498_f549b6e1.zip`
- Windows自定义: `dfd_cat_1761981498_f549b6e1__windows__a1b2c3d4e5f6.zip`
- Linux自定义: `dfd_cat_1761981498_f549b6e1__linux__x7y8z9a0b1c2.zip`

**优势**:
- 相同配置的下载会复用已生成的自定义ZIP
- 避免重复生成，提高响应速度
- 节省OSS存储空间（相同配置不会重复存储）

---

## 📝 回归测试

在修复完成后，还应该测试原有功能是否正常：

### 测试原有的"直接下载"功能
1. 点击 "📥 直接下载" 按钮（不是自定义下载）
2. 确认下载正常工作

### 测试草稿预览功能
1. 确认素材列表正常显示
2. 时间轴正常渲染
3. 素材详情可以查看

---

## ✅ 测试完成确认

完成所有测试后，请确认：

- [ ] Windows路径配置和下载正常
- [ ] Linux路径配置和下载正常
- [ ] 跨平台路径验证正常（不报错）
- [ ] 代理URL包含正确参数
- [ ] 下载的ZIP文件路径格式正确
- [ ] 原有功能未受影响
- [ ] 无控制台错误或警告
- [ ] 服务器日志无异常

---

## 🎯 总结

本次修复解决了自定义下载功能的5个主要问题：

1. ✅ 代理URL参数传递
2. ✅ 前端client_os参数添加（下载）
3. ✅ 前端client_os参数添加（配置）
4. ✅ 跨平台路径验证
5. ✅ 代码清理

**预期效果**:
- 用户可以在任何操作系统的浏览器中配置目标客户端的路径
- 下载的ZIP包含正确的客户端路径格式
- 剪映能够自动识别所有素材，无需手动重新链接

**下一步建议**:
- 在生产环境进行完整测试
- 收集用户反馈
- 考虑添加更多操作系统支持（macOS等）


