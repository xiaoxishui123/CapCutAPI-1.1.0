# è‡ªå®šä¹‰ä¸‹è½½åŠŸèƒ½ä¿®å¤æµ‹è¯•æŒ‡å—

## ğŸ“… ä¿®å¤å®Œæˆæ—¥æœŸ
2025-11-01

## âœ… å·²å®Œæˆçš„ä¿®å¤

### 1. ä¿®å¤ä»£ç†URLå‚æ•°ä¼ é€’é—®é¢˜ âœ“
**æ–‡ä»¶**: `capcut_server.py` (ç¬¬3293-3299è¡Œ)

**ä¿®å¤å†…å®¹**:
- åœ¨ä»£ç†ä¸‹è½½URLä¸­æ·»åŠ äº† `client_os` å’Œ `draft_folder` æŸ¥è¯¢å‚æ•°
- ä½¿ç”¨ `urllib.parse.urlencode` ç¡®ä¿å‚æ•°æ­£ç¡®ç¼–ç 

**ä¿®å¤ä»£ç **:
```python
from urllib.parse import urlencode
params = urlencode({
    'client_os': client_os,
    'draft_folder': draft_folder
})
proxy_download_url = f"/api/draft/download/proxy/{draft_id}?{params}"
```

---

### 2. åœ¨å‰ç«¯ä¸‹è½½è¯·æ±‚ä¸­æ·»åŠ client_oså‚æ•° âœ“
**æ–‡ä»¶**: `templates/preview.html` (ç¬¬1872-1886è¡Œ)

**ä¿®å¤å†…å®¹**:
- åœ¨ `startCustomDownload()` å‡½æ•°ä¸­æ·»åŠ äº†å®¢æˆ·ç«¯æ“ä½œç³»ç»Ÿæ£€æµ‹
- å°† `client_os` å‚æ•°ä¼ é€’ç»™åç«¯API

**ä¿®å¤ä»£ç **:
```javascript
// æ£€æµ‹å®¢æˆ·ç«¯æ“ä½œç³»ç»Ÿ
const clientOS = detectClientOS();

// è°ƒç”¨è‡ªå®šä¹‰ä¸‹è½½API
return fetch('/api/draft/download', {
    method: 'POST',
    headers: {
        'Content-Type': 'application/json'
    },
    body: JSON.stringify({
        draft_id: draftId,
        use_custom_path: true,
        draft_folder: customPath,
        client_os: clientOS  // âœ… æ–°æ·»åŠ 
    })
});
```

---

### 3. åœ¨å‰ç«¯è·¯å¾„é…ç½®ä¸­æ·»åŠ client_oså‚æ•° âœ“
**æ–‡ä»¶**: `templates/preview.html` (ç¬¬1698-1710è¡Œ)

**ä¿®å¤å†…å®¹**:
- åœ¨ `savePathConfig()` å‡½æ•°ä¸­æ·»åŠ äº†å®¢æˆ·ç«¯æ“ä½œç³»ç»Ÿæ£€æµ‹
- é…ç½®è·¯å¾„æ—¶å°† `client_os` å‘é€ç»™åç«¯ï¼Œç”¨äºè·¨å¹³å°éªŒè¯

**ä¿®å¤ä»£ç **:
```javascript
// æ£€æµ‹å®¢æˆ·ç«¯æ“ä½œç³»ç»Ÿ
const clientOS = detectClientOS();

fetch('/api/draft/path/config', {
    method: 'POST',
    headers: {
        'Content-Type': 'application/json'
    },
    body: JSON.stringify({
        custom_path: newPath,
        client_os: clientOS  // âœ… æ–°æ·»åŠ 
    })
})
```

---

### 4. æ”¹è¿›è·¨å¹³å°è·¯å¾„éªŒè¯é€»è¾‘ âœ“
**æ–‡ä»¶**: `capcut_server.py` (ç¬¬3197-3221è¡Œ)

**ä¿®å¤å†…å®¹**:
- æ·»åŠ äº†è·¨å¹³å°è·¯å¾„æ£€æµ‹é€»è¾‘
- Windowsè·¯å¾„ï¼ˆå¦‚ `F:\jianying\...`ï¼‰åœ¨LinuxæœåŠ¡å™¨ä¸Šä¸å†è¿›è¡Œç‰©ç†éªŒè¯
- åªå¯¹æœ¬åœ°è·¯å¾„è¿›è¡Œ `os.makedirs()` éªŒè¯

**ä¿®å¤ä»£ç **:
```python
client_os = data.get('client_os', 'unknown')

# è·¯å¾„éªŒè¯é€»è¾‘
if custom_path:
    # æ£€æŸ¥æ˜¯å¦ä¸ºè·¨å¹³å°è·¯å¾„
    import re
    is_cross_platform = False
    
    # æ£€æµ‹Windowsè·¯å¾„ç‰¹å¾ï¼ˆç›˜ç¬¦å¼€å¤´ï¼Œå¦‚ C:\, D:\, F:\ï¼‰
    if client_os == 'windows' and re.match(r'^[A-Za-z]:\\', custom_path):
        is_cross_platform = True
        print(f"æ£€æµ‹åˆ°è·¨å¹³å°è·¯å¾„é…ç½®: Windowsè·¯å¾„ '{custom_path}' åœ¨ Linux æœåŠ¡å™¨ä¸Š")
    
    # å¦‚æœä¸æ˜¯è·¨å¹³å°è·¯å¾„ï¼Œæ‰è¿›è¡Œç‰©ç†éªŒè¯
    if not is_cross_platform:
        try:
            os.makedirs(custom_path, exist_ok=True)
        except Exception as e:
            return jsonify({
                'success': False,
                'error': f'æ— æ³•åˆ›å»ºæˆ–è®¿é—®è·¯å¾„: {str(e)}'
            }), 400
    else:
        # è·¨å¹³å°è·¯å¾„åªåšæ ¼å¼éªŒè¯ï¼Œä¸è¿›è¡Œç‰©ç†éªŒè¯
        print(f"è·³è¿‡è·¨å¹³å°è·¯å¾„çš„ç‰©ç†éªŒè¯: {custom_path}")
```

---

### 5. æ¸…ç†æœªä½¿ç”¨çš„ä»£ç  âœ“
**æ–‡ä»¶**: `templates/preview.html`

**ä¿®å¤å†…å®¹**:
- åˆ é™¤äº†æœªä½¿ç”¨çš„ `customPathDownload()` å‡½æ•°ï¼ˆåŸç¬¬1561-1627è¡Œï¼‰
- å‡å°‘ä»£ç å†—ä½™ï¼Œé¿å…ç»´æŠ¤æ··æ·†

---

## ğŸ§ª æµ‹è¯•æ­¥éª¤

### æµ‹è¯•åœºæ™¯1: Windowsç”¨æˆ·é…ç½®è·¯å¾„å¹¶ä¸‹è½½

#### æ­¥éª¤:
1. åœ¨Windowsæµè§ˆå™¨ä¸­æ‰“å¼€è‰ç¨¿é¢„è§ˆé¡µé¢
   ```
   http://localhost:9000/preview/<draft_id>
   ```

2. ç‚¹å‡» "âš™ï¸ é…ç½®è·¯å¾„" æŒ‰é’®

3. è¾“å…¥Windowsè·¯å¾„ï¼ˆä¾‹å¦‚ï¼‰ï¼š
   ```
   F:\jianying\cgwz\JianyingPro Drafts
   ```

4. ç‚¹å‡» "ç¡®å®š" ä¿å­˜é…ç½®

5. ç‚¹å‡» "ğŸ“¥ è‡ªå®šä¹‰ä¸‹è½½" æŒ‰é’®

6. ç­‰å¾…ä¸‹è½½å®Œæˆ

#### é¢„æœŸç»“æœ:
- âœ… è·¯å¾„é…ç½®æˆåŠŸï¼ˆä¸æŠ¥é”™ï¼‰
- âœ… ä¸‹è½½å¼€å§‹ï¼ˆæµè§ˆå™¨æç¤ºä¸‹è½½ZIPæ–‡ä»¶ï¼‰
- âœ… ä¸‹è½½çš„æ–‡ä»¶åä¸º: `<draft_id>.zip`
- âœ… è§£å‹ZIPåï¼Œ`draft_info.json` ä¸­åŒ…å«Windowsæ ¼å¼è·¯å¾„
  ```json
  {
    "replace_path": "F:\\jianying\\cgwz\\JianyingPro Drafts\\<draft_id>\\assets\\..."
  }
  ```

#### éªŒè¯æ–¹æ³•:
```bash
# è§£å‹ä¸‹è½½çš„ZIPæ–‡ä»¶
unzip <draft_id>.zip -d test_extract

# æŸ¥çœ‹draft_info.jsonä¸­çš„è·¯å¾„
cat test_extract/draft_info.json | grep "replace_path" | head -3

# åº”è¯¥çœ‹åˆ°ç±»ä¼¼ï¼š
# "replace_path": "F:\\jianying\\cgwz\\JianyingPro Drafts\\dfd_xxx\\assets\\image\\xxx.png"
```

---

### æµ‹è¯•åœºæ™¯2: Linuxç”¨æˆ·é…ç½®è·¯å¾„å¹¶ä¸‹è½½

#### æ­¥éª¤:
1. åœ¨Linuxæµè§ˆå™¨ä¸­æ‰“å¼€è‰ç¨¿é¢„è§ˆé¡µé¢

2. ç‚¹å‡» "âš™ï¸ é…ç½®è·¯å¾„" æŒ‰é’®

3. è¾“å…¥Linuxè·¯å¾„ï¼ˆä¾‹å¦‚ï¼‰ï¼š
   ```
   /home/user/JianyingPro Drafts
   ```

4. ç‚¹å‡» "ç¡®å®š" ä¿å­˜é…ç½®

5. ç‚¹å‡» "ğŸ“¥ è‡ªå®šä¹‰ä¸‹è½½" æŒ‰é’®

6. ç­‰å¾…ä¸‹è½½å®Œæˆ

#### é¢„æœŸç»“æœ:
- âœ… è·¯å¾„é…ç½®æˆåŠŸ
- âœ… ä¸‹è½½æˆåŠŸ
- âœ… `draft_info.json` ä¸­åŒ…å«Linuxæ ¼å¼è·¯å¾„
  ```json
  {
    "replace_path": "/home/user/JianyingPro Drafts/<draft_id>/assets/..."
  }
  ```

---

### æµ‹è¯•åœºæ™¯3: æ£€æŸ¥ä»£ç†URLå‚æ•°

#### æ­¥éª¤:
1. é…ç½®è‡ªå®šä¹‰è·¯å¾„åï¼Œæ‰“å¼€æµè§ˆå™¨å¼€å‘è€…å·¥å…·ï¼ˆF12ï¼‰

2. åˆ‡æ¢åˆ° "Network" (ç½‘ç»œ) æ ‡ç­¾

3. ç‚¹å‡» "ğŸ“¥ è‡ªå®šä¹‰ä¸‹è½½" æŒ‰é’®

4. æŸ¥æ‰¾å¯¹ `/api/draft/download` çš„POSTè¯·æ±‚

5. æŸ¥çœ‹å“åº”ä¸­çš„ `download_url` å­—æ®µ

#### é¢„æœŸç»“æœ:
ä»£ç†URLåº”åŒ…å«æŸ¥è¯¢å‚æ•°ï¼š
```
/api/draft/download/proxy/<draft_id>?client_os=windows&draft_folder=F%3A%5Cjianying%5Ccgwz%5CJianyingPro+Drafts
```

æˆ–è€…ï¼ˆLinuxï¼‰ï¼š
```
/api/draft/download/proxy/<draft_id>?client_os=linux&draft_folder=%2Fhome%2Fuser%2FJianyingPro+Drafts
```

---

### æµ‹è¯•åœºæ™¯4: éªŒè¯è·¨å¹³å°è·¯å¾„é…ç½®

#### åœ¨LinuxæœåŠ¡å™¨ä¸Šæµ‹è¯•Windowsè·¯å¾„é…ç½®:

```bash
# å¯åŠ¨Pythonæµ‹è¯•
cd /home/CapCutAPI-1.1.0

# æµ‹è¯•é…ç½®Windowsè·¯å¾„
curl -X POST http://localhost:9000/api/draft/path/config \
  -H "Content-Type: application/json" \
  -d '{
    "custom_path": "F:\\jianying\\cgwz\\JianyingPro Drafts",
    "client_os": "windows"
  }'

# é¢„æœŸå“åº”ï¼š
# {
#   "success": true,
#   "message": "è·¯å¾„é…ç½®å·²æ›´æ–°",
#   "custom_path": "F:\\jianying\\cgwz\\JianyingPro Drafts"
# }
```

#### æŸ¥çœ‹æœåŠ¡å™¨æ—¥å¿—:
```bash
tail -f logs/capcutapi.log

# åº”è¯¥çœ‹åˆ°ï¼š
# æ£€æµ‹åˆ°è·¨å¹³å°è·¯å¾„é…ç½®: Windowsè·¯å¾„ 'F:\jianying\cgwz\JianyingPro Drafts' åœ¨ Linux æœåŠ¡å™¨ä¸Š
# è·³è¿‡è·¨å¹³å°è·¯å¾„çš„ç‰©ç†éªŒè¯: F:\jianying\cgwz\JianyingPro Drafts
```

---

## ğŸ” æ£€æŸ¥ç‚¹æ¸…å•

### å‰ç«¯æ£€æŸ¥
- [ ] `detectClientOS()` å‡½æ•°æ­£ç¡®è¯†åˆ«æ“ä½œç³»ç»Ÿ
- [ ] ä¸‹è½½è¯·æ±‚åŒ…å« `client_os` å‚æ•°
- [ ] è·¯å¾„é…ç½®è¯·æ±‚åŒ…å« `client_os` å‚æ•°
- [ ] æµè§ˆå™¨æ§åˆ¶å°æ— JavaScripté”™è¯¯

### åç«¯æ£€æŸ¥
- [ ] ä»£ç†URLåŒ…å« `client_os` å’Œ `draft_folder` å‚æ•°
- [ ] Windowsè·¯å¾„åœ¨LinuxæœåŠ¡å™¨ä¸Šä¸æŠ¥"æ— æ³•åˆ›å»ºç›®å½•"é”™è¯¯
- [ ] è‡ªå®šä¹‰ZIPæ­£ç¡®ç”Ÿæˆï¼ˆåŸºäºclient_oså’Œdraft_folderå“ˆå¸Œï¼‰
- [ ] æœåŠ¡å™¨æ—¥å¿—æ˜¾ç¤ºè·¨å¹³å°è·¯å¾„æ£€æµ‹ä¿¡æ¯

### ä¸‹è½½æ–‡ä»¶æ£€æŸ¥
- [ ] ZIPæ–‡ä»¶æˆåŠŸä¸‹è½½åˆ°æµè§ˆå™¨ä¸‹è½½æ–‡ä»¶å¤¹
- [ ] æ–‡ä»¶åæ ¼å¼æ­£ç¡®: `<draft_id>.zip`
- [ ] è§£å‹ååŒ…å« `draft_info.json`
- [ ] `draft_info.json` ä¸­çš„è·¯å¾„æ ¼å¼ä¸é…ç½®çš„æ“ä½œç³»ç»ŸåŒ¹é…

---

## ğŸ› å¯èƒ½çš„é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆ

### é—®é¢˜1: ä¸‹è½½æ—¶æç¤º"è¯·å…ˆé…ç½®ä¸‹è½½è·¯å¾„"
**åŸå› **: æœªé…ç½®è·¯å¾„æˆ–é…ç½®æœªä¿å­˜

**è§£å†³**:
1. å…ˆç‚¹å‡»"âš™ï¸ é…ç½®è·¯å¾„"
2. è¾“å…¥æœ‰æ•ˆè·¯å¾„
3. ç¡®ä¿çœ‹åˆ°"è·¯å¾„é…ç½®æˆåŠŸ"æç¤º
4. å†ç‚¹å‡»"ğŸ“¥ è‡ªå®šä¹‰ä¸‹è½½"

---

### é—®é¢˜2: ä»£ç†ä¸‹è½½è¿”å›404
**åŸå› **: OSSä¸Šä¸å­˜åœ¨åŸºç¡€ZIPæ–‡ä»¶

**è§£å†³**:
1. æ£€æŸ¥è‰ç¨¿æ˜¯å¦å·²æˆåŠŸç”Ÿæˆ
2. ç¡®è®¤OSSä¸Šå­˜åœ¨ `<draft_id>.zip`
3. æŸ¥çœ‹æœåŠ¡å™¨æ—¥å¿—è·å–è¯¦ç»†é”™è¯¯ä¿¡æ¯

---

### é—®é¢˜3: ä¸‹è½½çš„ZIPè·¯å¾„æ ¼å¼ä¸æ­£ç¡®
**åŸå› **: å¯èƒ½æ˜¯client_oså‚æ•°ä¼ é€’é”™è¯¯

**æ£€æŸ¥**:
1. æ‰“å¼€æµè§ˆå™¨å¼€å‘è€…å·¥å…·
2. æŸ¥çœ‹Networkè¯·æ±‚ä¸­çš„ `client_os` å€¼
3. ç¡®è®¤ä¸å®é™…æ“ä½œç³»ç»ŸåŒ¹é…

**ä¿®å¤**:
- æ¸…é™¤æµè§ˆå™¨ç¼“å­˜é‡æ–°åŠ è½½é¡µé¢
- æ£€æŸ¥ `detectClientOS()` å‡½æ•°æ˜¯å¦æ­£å¸¸å·¥ä½œ

---

## ğŸ“Š æ€§èƒ½å’Œç¼“å­˜ä¼˜åŒ–

### OSSè‡ªå®šä¹‰ZIPç¼“å­˜æœºåˆ¶

ç³»ç»Ÿä¼šæ ¹æ®ä»¥ä¸‹ä¿¡æ¯ç”Ÿæˆå”¯ä¸€çš„ç¼“å­˜é”®ï¼š
```python
key_suffix = _hash_str(f"{client_os}|{draft_folder}")
custom_key = f"{draft_id}__{client_os}__{key_suffix}.zip"
```

**ç¤ºä¾‹**:
- åŸºç¡€ZIP: `dfd_cat_1761981498_f549b6e1.zip`
- Windowsè‡ªå®šä¹‰: `dfd_cat_1761981498_f549b6e1__windows__a1b2c3d4e5f6.zip`
- Linuxè‡ªå®šä¹‰: `dfd_cat_1761981498_f549b6e1__linux__x7y8z9a0b1c2.zip`

**ä¼˜åŠ¿**:
- ç›¸åŒé…ç½®çš„ä¸‹è½½ä¼šå¤ç”¨å·²ç”Ÿæˆçš„è‡ªå®šä¹‰ZIP
- é¿å…é‡å¤ç”Ÿæˆï¼Œæé«˜å“åº”é€Ÿåº¦
- èŠ‚çœOSSå­˜å‚¨ç©ºé—´ï¼ˆç›¸åŒé…ç½®ä¸ä¼šé‡å¤å­˜å‚¨ï¼‰

---

## ğŸ“ å›å½’æµ‹è¯•

åœ¨ä¿®å¤å®Œæˆåï¼Œè¿˜åº”è¯¥æµ‹è¯•åŸæœ‰åŠŸèƒ½æ˜¯å¦æ­£å¸¸ï¼š

### æµ‹è¯•åŸæœ‰çš„"ç›´æ¥ä¸‹è½½"åŠŸèƒ½
1. ç‚¹å‡» "ğŸ“¥ ç›´æ¥ä¸‹è½½" æŒ‰é’®ï¼ˆä¸æ˜¯è‡ªå®šä¹‰ä¸‹è½½ï¼‰
2. ç¡®è®¤ä¸‹è½½æ­£å¸¸å·¥ä½œ

### æµ‹è¯•è‰ç¨¿é¢„è§ˆåŠŸèƒ½
1. ç¡®è®¤ç´ æåˆ—è¡¨æ­£å¸¸æ˜¾ç¤º
2. æ—¶é—´è½´æ­£å¸¸æ¸²æŸ“
3. ç´ æè¯¦æƒ…å¯ä»¥æŸ¥çœ‹

---

## âœ… æµ‹è¯•å®Œæˆç¡®è®¤

å®Œæˆæ‰€æœ‰æµ‹è¯•åï¼Œè¯·ç¡®è®¤ï¼š

- [ ] Windowsè·¯å¾„é…ç½®å’Œä¸‹è½½æ­£å¸¸
- [ ] Linuxè·¯å¾„é…ç½®å’Œä¸‹è½½æ­£å¸¸
- [ ] è·¨å¹³å°è·¯å¾„éªŒè¯æ­£å¸¸ï¼ˆä¸æŠ¥é”™ï¼‰
- [ ] ä»£ç†URLåŒ…å«æ­£ç¡®å‚æ•°
- [ ] ä¸‹è½½çš„ZIPæ–‡ä»¶è·¯å¾„æ ¼å¼æ­£ç¡®
- [ ] åŸæœ‰åŠŸèƒ½æœªå—å½±å“
- [ ] æ— æ§åˆ¶å°é”™è¯¯æˆ–è­¦å‘Š
- [ ] æœåŠ¡å™¨æ—¥å¿—æ— å¼‚å¸¸

---

## ğŸ¯ æ€»ç»“

æœ¬æ¬¡ä¿®å¤è§£å†³äº†è‡ªå®šä¹‰ä¸‹è½½åŠŸèƒ½çš„5ä¸ªä¸»è¦é—®é¢˜ï¼š

1. âœ… ä»£ç†URLå‚æ•°ä¼ é€’
2. âœ… å‰ç«¯client_oså‚æ•°æ·»åŠ ï¼ˆä¸‹è½½ï¼‰
3. âœ… å‰ç«¯client_oså‚æ•°æ·»åŠ ï¼ˆé…ç½®ï¼‰
4. âœ… è·¨å¹³å°è·¯å¾„éªŒè¯
5. âœ… ä»£ç æ¸…ç†

**é¢„æœŸæ•ˆæœ**:
- ç”¨æˆ·å¯ä»¥åœ¨ä»»ä½•æ“ä½œç³»ç»Ÿçš„æµè§ˆå™¨ä¸­é…ç½®ç›®æ ‡å®¢æˆ·ç«¯çš„è·¯å¾„
- ä¸‹è½½çš„ZIPåŒ…å«æ­£ç¡®çš„å®¢æˆ·ç«¯è·¯å¾„æ ¼å¼
- å‰ªæ˜ èƒ½å¤Ÿè‡ªåŠ¨è¯†åˆ«æ‰€æœ‰ç´ æï¼Œæ— éœ€æ‰‹åŠ¨é‡æ–°é“¾æ¥

**ä¸‹ä¸€æ­¥å»ºè®®**:
- åœ¨ç”Ÿäº§ç¯å¢ƒè¿›è¡Œå®Œæ•´æµ‹è¯•
- æ”¶é›†ç”¨æˆ·åé¦ˆ
- è€ƒè™‘æ·»åŠ æ›´å¤šæ“ä½œç³»ç»Ÿæ”¯æŒï¼ˆmacOSç­‰ï¼‰


