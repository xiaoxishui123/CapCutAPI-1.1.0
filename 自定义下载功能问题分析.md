# è‡ªå®šä¹‰ä¸‹è½½åŠŸèƒ½é€»è¾‘é—®é¢˜åˆ†ææŠ¥å‘Š

## ğŸ“‹ æ£€æŸ¥æ—¥æœŸ
2025-11-01

## ğŸ” åŠŸèƒ½æµç¨‹åˆ†æ

### å½“å‰å®ç°æµç¨‹

1. **å‰ç«¯è°ƒç”¨** (`preview.html`)
   - ç”¨æˆ·ç‚¹å‡» "ğŸ“¦ è‡ªå®šä¹‰ä¸‹è½½" æŒ‰é’®
   - è§¦å‘å‡½æ•°ï¼š`startCustomDownload(draftId)`
   - APIè°ƒç”¨ï¼š`POST /api/draft/download`
   - è¯·æ±‚å‚æ•°ï¼š
     ```javascript
     {
       draft_id: draftId,
       use_custom_path: true,
       draft_folder: customPath  // ä»é…ç½®ä¸­è·å–
     }
     ```

2. **åç«¯å¤„ç†** (`capcut_server.py`)
   - è·¯ç”±ï¼š`/api/draft/download` (ç¬¬3260è¡Œ)
   - å‡½æ•°ï¼š`draft_download_api()`
   - è°ƒç”¨ï¼š`get_customized_signed_url(draft_id, client_os, draft_folder)`
   - è¿”å›ï¼šä»£ç†ä¸‹è½½URL

3. **è‡ªå®šä¹‰ZIPç”Ÿæˆ** (`customize_zip.py`)
   - å‡½æ•°ï¼š`ensure_customized_zip()`
   - æµç¨‹ï¼š
     - æ£€æŸ¥OSSä¸Šæ˜¯å¦å­˜åœ¨è‡ªå®šä¹‰ç‰ˆæœ¬ï¼ˆåŸºäºclient_oså’Œdraft_folderçš„å“ˆå¸Œï¼‰
     - å¦‚ä¸å­˜åœ¨ï¼Œä¸‹è½½åŸºç¡€ZIP
     - ä¿®æ”¹`draft_info.json`ä¸­çš„è·¯å¾„
     - é‡æ–°æ‰“åŒ…å¹¶ä¸Šä¼ åˆ°OSS

## âŒ å‘ç°çš„é—®é¢˜

### é—®é¢˜1ï¼šä»£ç†URLç¼ºå°‘å¿…è¦å‚æ•° âš ï¸ **ä¸¥é‡**

**ä½ç½®**ï¼š`capcut_server.py` ç¬¬3293è¡Œ

**é—®é¢˜ä»£ç **ï¼š
```python
proxy_download_url = f"/api/draft/download/proxy/{draft_id}"
return jsonify({
    'success': True,
    'download_url': proxy_download_url,  # ç¼ºå°‘å‚æ•°ï¼
    'original_url': custom_download_url,
    ...
})
```

**é—®é¢˜æè¿°**ï¼š
- ä»£ç†URLæ²¡æœ‰åŒ…å« `client_os` å’Œ `draft_folder` å‚æ•°
- ä»£ç†å¤„ç†å™¨ï¼ˆç¬¬3730-3731è¡Œï¼‰æœŸæœ›ä»æŸ¥è¯¢å‚æ•°è·å–è¿™äº›å€¼ï¼š
  ```python
  client_os = request.args.get('client_os', 'windows')
  draft_folder = request.args.get('draft_folder', '')
  ```
- å¦‚æœç¼ºå°‘è¿™äº›å‚æ•°ï¼Œä»£ç†ä¼šä½¿ç”¨é»˜è®¤å€¼ï¼Œå¯èƒ½ç”Ÿæˆé”™è¯¯çš„è‡ªå®šä¹‰ZIP

**å½±å“**ï¼š
- å¦‚æœç”¨æˆ·é…ç½®çš„è·¯å¾„ä¸é…ç½®æ–‡ä»¶ä¸­ä¸åŒï¼Œä¼šä¸‹è½½åˆ°é”™è¯¯çš„è‡ªå®šä¹‰ç‰ˆæœ¬
- å¯èƒ½å¯¼è‡´è·¯å¾„ä¸åŒ¹é…ï¼Œå‰ªæ˜ æ— æ³•è¯†åˆ«ç´ æ

**ä¿®å¤æ–¹æ¡ˆ**ï¼š
```python
# åº”è¯¥æ”¹ä¸ºï¼š
from urllib.parse import urlencode
params = urlencode({
    'client_os': client_os,
    'draft_folder': draft_folder
})
proxy_download_url = f"/api/draft/download/proxy/{draft_id}?{params}"
```

---

### é—®é¢˜2ï¼šè·¯å¾„é…ç½®éªŒè¯ä¸å®Œæ•´ âš ï¸ **ä¸­ç­‰**

**ä½ç½®**ï¼š`capcut_server.py` ç¬¬3202è¡Œ

**é—®é¢˜ä»£ç **ï¼š
```python
try:
    os.makedirs(custom_path, exist_ok=True)
except Exception as e:
    return jsonify({
        'success': False,
        'error': f'æ— æ³•åˆ›å»ºæˆ–è®¿é—®è·¯å¾„: {str(e)}'
    }), 400
```

**é—®é¢˜æè¿°**ï¼š
- åœ¨LinuxæœåŠ¡å™¨ä¸ŠéªŒè¯Windowsè·¯å¾„ï¼ˆå¦‚ `F:\jianying\cgwz\JianyingPro Drafts`ï¼‰
- Linuxæ— æ³•åˆ›å»ºWindowsç›˜ç¬¦è·¯å¾„ï¼Œä¼šå¯¼è‡´é…ç½®å¤±è´¥
- ç”¨æˆ·æ— æ³•è®¾ç½®Windowsè·¯å¾„

**å½±å“**ï¼š
- ç”¨æˆ·åœ¨é…ç½®Windowsè·¯å¾„æ—¶ä¼šæ”¶åˆ°é”™è¯¯
- æ— æ³•æ­£ç¡®é…ç½®è·¨å¹³å°è·¯å¾„

**ä¿®å¤æ–¹æ¡ˆ**ï¼š
```python
# åº”è¯¥è·³è¿‡è·¨å¹³å°è·¯å¾„çš„ç‰©ç†éªŒè¯
def is_cross_platform_path(path, client_os):
    """æ£€æŸ¥æ˜¯å¦ä¸ºè·¨å¹³å°è·¯å¾„"""
    if client_os == 'windows':
        # Windowsè·¯å¾„ç‰¹å¾ï¼šç›˜ç¬¦å¼€å¤´
        return bool(re.match(r'^[A-Za-z]:\\', path))
    return False

# åœ¨éªŒè¯é€»è¾‘ä¸­ï¼š
if custom_path:
    # æ£€æµ‹å®¢æˆ·ç«¯æ“ä½œç³»ç»Ÿ
    client_os = data.get('client_os', 'windows')
    
    # å¦‚æœæ˜¯è·¨å¹³å°è·¯å¾„ï¼Œè·³è¿‡ç‰©ç†éªŒè¯
    if not is_cross_platform_path(custom_path, client_os):
        try:
            os.makedirs(custom_path, exist_ok=True)
        except Exception as e:
            return jsonify({
                'success': False,
                'error': f'æ— æ³•åˆ›å»ºæˆ–è®¿é—®è·¯å¾„: {str(e)}'
            }), 400
```

---

### é—®é¢˜3ï¼šå­˜åœ¨æœªä½¿ç”¨çš„é‡å¤å‡½æ•° âš ï¸ **ä½**

**ä½ç½®**ï¼š`preview.html` ç¬¬1561è¡Œ

**é—®é¢˜æè¿°**ï¼š
- å­˜åœ¨ä¸¤ä¸ªç±»ä¼¼çš„ä¸‹è½½å‡½æ•°ï¼š
  1. `customPathDownload()` - è°ƒç”¨ `/api/drafts/download/custom/<draft_id>`
  2. `startCustomDownload()` - è°ƒç”¨ `/api/draft/download` âœ… **å®é™…ä½¿ç”¨**
- `customPathDownload()` æœªè¢«HTMLæŒ‰é’®è°ƒç”¨ï¼Œå±äºæ­»ä»£ç 

**å½±å“**ï¼š
- ä»£ç å†—ä½™ï¼Œå¢åŠ ç»´æŠ¤æˆæœ¬
- å¯èƒ½å¼•èµ·æ··æ·†

**ä¿®å¤æ–¹æ¡ˆ**ï¼š
- åˆ é™¤æœªä½¿ç”¨çš„ `customPathDownload()` å‡½æ•°
- ä¿ç•™å¹¶ä¼˜åŒ– `startCustomDownload()` å‡½æ•°

---

### é—®é¢˜4ï¼šå‰ç«¯ç¼ºå°‘client_oså‚æ•°ä¼ é€’ âš ï¸ **ä¸­ç­‰**

**ä½ç½®**ï¼š`preview.html` ç¬¬1878-1882è¡Œ

**é—®é¢˜ä»£ç **ï¼š
```javascript
body: JSON.stringify({
    draft_id: draftId,
    use_custom_path: true,
    draft_folder: customPath
    // ç¼ºå°‘ client_osï¼
})
```

**é—®é¢˜æè¿°**ï¼š
- å‰ç«¯è°ƒç”¨ä¸‹è½½APIæ—¶ï¼Œæ²¡æœ‰ä¼ é€’ `client_os` å‚æ•°
- åç«¯ä½¿ç”¨é»˜è®¤å€¼ `'unknown'`ï¼ˆç¬¬3267è¡Œï¼‰
- å¯èƒ½å¯¼è‡´ç”Ÿæˆçš„è‡ªå®šä¹‰ZIPä¸åŒ…å«æ­£ç¡®çš„æ“ä½œç³»ç»Ÿè·¯å¾„æ ¼å¼

**ä¿®å¤æ–¹æ¡ˆ**ï¼š
```javascript
// åœ¨è¯·æ±‚ä½“ä¸­æ·»åŠ  client_os
const clientOS = detectClientOS();  // è¿™ä¸ªå‡½æ•°å·²å­˜åœ¨
body: JSON.stringify({
    draft_id: draftId,
    use_custom_path: true,
    draft_folder: customPath,
    client_os: clientOS  // æ·»åŠ æ­¤å‚æ•°
})
```

---

### é—®é¢˜5ï¼šå‰ç«¯è·¯å¾„é…ç½®ç¼ºå°‘client_os âš ï¸ **ä¸­ç­‰**

**ä½ç½®**ï¼š`preview.html` ç¬¬1698-1705è¡Œ

**é—®é¢˜ä»£ç **ï¼š
```javascript
fetch('/api/draft/path/config', {
    method: 'POST',
    headers: {
        'Content-Type': 'application/json'
    },
    body: JSON.stringify({
        custom_path: newPath
        // ç¼ºå°‘ client_osï¼
    })
})
```

**é—®é¢˜æè¿°**ï¼š
- é…ç½®è·¯å¾„æ—¶æ²¡æœ‰å‘ŠçŸ¥æœåŠ¡å™¨å®¢æˆ·ç«¯æ“ä½œç³»ç»Ÿ
- æœåŠ¡å™¨æ— æ³•è¿›è¡Œæ­£ç¡®çš„è·¯å¾„æ ¼å¼éªŒè¯
- åç«¯ç¬¬3202è¡Œçš„è·¯å¾„éªŒè¯ä¼šå¤±è´¥ï¼ˆè§é—®é¢˜2ï¼‰

**ä¿®å¤æ–¹æ¡ˆ**ï¼š
```javascript
const clientOS = detectClientOS();
body: JSON.stringify({
    custom_path: newPath,
    client_os: clientOS  // æ·»åŠ æ­¤å‚æ•°
})
```

---

## âœ… æ­£ç¡®è¿è¡Œçš„éƒ¨åˆ†

### 1. è‡ªå®šä¹‰ZIPç”Ÿæˆé€»è¾‘ âœ“
- `customize_zip.py` çš„è·¯å¾„é‡å†™é€»è¾‘æ­£ç¡®
- `_rewrite_paths_in_json()` å‡½æ•°èƒ½æ­£ç¡®å¤„ç†åµŒå¥—è·¯å¾„
- `normalize_path_by_os()` èƒ½æ­£ç¡®è½¬æ¢è·¯å¾„æ ¼å¼

### 2. OSSç¼“å­˜æœºåˆ¶ âœ“
- ä½¿ç”¨å“ˆå¸Œå€¼é¿å…é‡å¤ç”Ÿæˆç›¸åŒé…ç½®çš„ZIP
- `ensure_customized_zip()` æ£€æŸ¥å·²å­˜åœ¨çš„è‡ªå®šä¹‰ç‰ˆæœ¬

### 3. å‰ç«¯è·¯å¾„æ˜¾ç¤ºå’Œæ›´æ–° âœ“
- `loadCurrentPathConfig()` æ­£ç¡®åŠ è½½é…ç½®
- `updatePathDisplay()` æ­£ç¡®æ›´æ–°æ˜¾ç¤º

---

## ğŸ”§ æ¨èçš„ä¿®å¤ä¼˜å…ˆçº§

### é«˜ä¼˜å…ˆçº§ï¼ˆå¿…é¡»ä¿®å¤ï¼‰
1. **ä¿®å¤ä»£ç†URLå‚æ•°ä¼ é€’**ï¼ˆé—®é¢˜1ï¼‰
2. **æ·»åŠ client_oså‚æ•°åˆ°å‰ç«¯è¯·æ±‚**ï¼ˆé—®é¢˜4ã€5ï¼‰

### ä¸­ä¼˜å…ˆçº§ï¼ˆå»ºè®®ä¿®å¤ï¼‰
3. **æ”¹è¿›è·¨å¹³å°è·¯å¾„éªŒè¯**ï¼ˆé—®é¢˜2ï¼‰
4. **æ¸…ç†æœªä½¿ç”¨çš„ä»£ç **ï¼ˆé—®é¢˜3ï¼‰

### ä½ä¼˜å…ˆçº§ï¼ˆä¼˜åŒ–ï¼‰
5. æ·»åŠ æ›´è¯¦ç»†çš„é”™è¯¯æ—¥å¿—
6. æ·»åŠ ä¸‹è½½è¿›åº¦è·Ÿè¸ª
7. å¢å¼ºç”¨æˆ·ä½“éªŒæç¤º

---

## ğŸ“ æµ‹è¯•å»ºè®®

### æµ‹è¯•åœºæ™¯1ï¼šWindowsç”¨æˆ·é…ç½®è·¯å¾„
1. åœ¨Windowsæµè§ˆå™¨ä¸­æ‰“å¼€é¢„è§ˆé¡µé¢
2. é…ç½®è·¯å¾„ï¼š`F:\jianying\cgwz\JianyingPro Drafts`
3. ç‚¹å‡»"è‡ªå®šä¹‰ä¸‹è½½"
4. éªŒè¯ä¸‹è½½çš„ZIPåŒ…å«æ­£ç¡®çš„Windowsè·¯å¾„

### æµ‹è¯•åœºæ™¯2ï¼šLinuxç”¨æˆ·é…ç½®è·¯å¾„
1. åœ¨Linuxæµè§ˆå™¨ä¸­æ‰“å¼€é¢„è§ˆé¡µé¢
2. é…ç½®è·¯å¾„ï¼š`/home/user/JianyingPro Drafts`
3. ç‚¹å‡»"è‡ªå®šä¹‰ä¸‹è½½"
4. éªŒè¯ä¸‹è½½çš„ZIPåŒ…å«æ­£ç¡®çš„Linuxè·¯å¾„

### æµ‹è¯•åœºæ™¯3ï¼šè·¯å¾„åˆ‡æ¢
1. å…ˆé…ç½®è·¯å¾„Aå¹¶ä¸‹è½½
2. ä¿®æ”¹ä¸ºè·¯å¾„Bå¹¶ä¸‹è½½
3. éªŒè¯ä¸¤æ¬¡ä¸‹è½½ä½¿ç”¨äº†ä¸åŒçš„è‡ªå®šä¹‰ZIP

---

## ğŸ’¡ æ€»ç»“

**æ€»ä½“è¯„ä»·**ï¼šåŠŸèƒ½è®¾è®¡æ€è·¯æ­£ç¡®ï¼Œä½†åœ¨å‚æ•°ä¼ é€’å’Œè·¨å¹³å°æ”¯æŒæ–¹é¢å­˜åœ¨ç¼ºé™·ã€‚

**æ ¸å¿ƒé—®é¢˜**ï¼š
- å‚æ•°ä¼ é€’é“¾ä¸å®Œæ•´ï¼ˆå‰ç«¯â†’åç«¯â†’ä»£ç†ï¼‰
- è·¨å¹³å°è·¯å¾„éªŒè¯é€»è¾‘ä¸åˆç†

**ä¿®å¤åçš„é¢„æœŸæ•ˆæœ**ï¼š
- ç”¨æˆ·å¯ä»¥åœ¨ä»»ä½•æ“ä½œç³»ç»Ÿçš„æµè§ˆå™¨ä¸­é…ç½®ç›®æ ‡è·¯å¾„
- ä¸‹è½½çš„ZIPåŒ…å«æ­£ç¡®çš„å®¢æˆ·ç«¯è·¯å¾„æ ¼å¼
- å‰ªæ˜ èƒ½å¤Ÿè‡ªåŠ¨è¯†åˆ«æ‰€æœ‰ç´ æï¼Œæ— éœ€æ‰‹åŠ¨é‡æ–°é“¾æ¥

