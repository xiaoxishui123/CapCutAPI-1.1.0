import requests
from flask import Flask, request, jsonify, Response
from datetime import datetime
import os
import pyJianYingDraft as draft
from pyJianYingDraft.metadata.animation_meta import Intro_type, Outro_type, Group_animation_type
from pyJianYingDraft.metadata.capcut_animation_meta import CapCut_Intro_type, CapCut_Outro_type, CapCut_Group_animation_type
from pyJianYingDraft.metadata.transition_meta import Transition_type
from pyJianYingDraft.metadata.capcut_transition_meta import CapCut_Transition_type
from pyJianYingDraft.metadata.mask_meta import Mask_type
from pyJianYingDraft.metadata.capcut_mask_meta import CapCut_Mask_type
from pyJianYingDraft.metadata.audio_effect_meta import Tone_effect_type, Audio_scene_effect_type, Speech_to_song_type
from pyJianYingDraft.metadata.capcut_audio_effect_meta import CapCut_Voice_filters_effect_type, CapCut_Voice_characters_effect_type, CapCut_Speech_to_song_effect_type
from pyJianYingDraft.metadata.font_meta import Font_type
from pyJianYingDraft.metadata.animation_meta import Text_intro, Text_outro, Text_loop_anim
from pyJianYingDraft.metadata.capcut_text_animation_meta import CapCut_Text_intro, CapCut_Text_outro, CapCut_Text_loop_anim
from pyJianYingDraft.metadata.video_effect_meta import Video_scene_effect_type, Video_character_effect_type
from pyJianYingDraft.metadata.capcut_effect_meta import CapCut_Video_scene_effect_type, CapCut_Video_character_effect_type
import random
import uuid
import json
import codecs
import time
import sqlite3
import html
from add_audio_track import add_audio_track
from add_video_track import add_video_track
from add_text_impl import add_text_impl
from add_subtitle_impl import add_subtitle_impl
from add_image_impl import add_image_impl
from add_video_keyframe_impl import add_video_keyframe_impl
from save_draft_impl import save_draft_impl, query_task_status, query_script_impl
from os_path_config import get_os_path_config
from add_effect_impl import add_effect_impl
from add_sticker_impl import add_sticker_impl
from create_draft import create_draft, get_or_create_draft
from util import generate_draft_url as utilgenerate_draft_url, hex_to_rgb, normalize_path_by_os
from pyJianYingDraft.text_segment import TextStyleRange, Text_style, Text_border
from urllib.parse import quote

from settings.local import IS_CAPCUT_ENV, DRAFT_DOMAIN, PREVIEW_ROUTER, PORT, IS_UPLOAD_DRAFT
from oss import get_signed_draft_url_if_exists
from customize_zip import get_customized_signed_url

# OSS mirror support
import uuid as _uuid
import oss2 as _oss2
from settings.local import OSS_CONFIG as _OSS_CONFIG

def _ensure_bucket_v4():
    auth = _oss2.AuthV4(_OSS_CONFIG['access_key_id'], _OSS_CONFIG['access_key_secret'])
    endpoint = _OSS_CONFIG['endpoint']
    if not str(endpoint).startswith('http'):
        endpoint = 'https://' + endpoint
    return _oss2.Bucket(auth, endpoint, _OSS_CONFIG['bucket_name'], region=_OSS_CONFIG['region'])

from database import init_db

app = Flask(__name__, template_folder='templates')

init_db()

# 全局草稿素材信息缓存
draft_materials_cache = {}

def add_material_to_cache(draft_id, material_info):
    """添加素材信息到数据库"""
    try:
        material_id = str(uuid.uuid4())
        add_material_to_db(draft_id, material_id, material_info)
        # Also update in-memory cache for now for compatibility
        if draft_id not in draft_materials_cache:
            draft_materials_cache[draft_id] = []
        material_info['id'] = material_id
        draft_materials_cache[draft_id].append(material_info)
    except Exception as _e:
        print('持久化素材到数据库失败:', _e)

from database import get_draft_materials as get_draft_materials_from_db, add_material_to_db, get_all_drafts

def get_draft_materials(draft_id):
    """获取草稿素材信息 - 优先从缓存获取，然后从数据库获取，最后扫描文件系统"""
    # 首先检查内存缓存
    if draft_id in draft_materials_cache:
        return draft_materials_cache[draft_id]
    
    # 如果缓存中没有，从数据库获取
    db_materials = get_draft_materials_from_db(draft_id)
    if db_materials:
        # 将数据库中的数据加载到缓存中
        draft_materials_cache[draft_id] = db_materials
        return db_materials
    
    # 如果数据库中也没有，扫描草稿目录中的实际文件
    draft_path = f"drafts/{draft_id}"
    if os.path.exists(draft_path):
        materials = []
        
        # 扫描目录中的文件
        for filename in os.listdir(draft_path):
            file_path = os.path.join(draft_path, filename)
            if os.path.isfile(file_path):
                # 跳过draft_info.json文件
                if filename == 'draft_info.json':
                    continue
                    
                # 根据文件扩展名确定类型
                file_ext = filename.lower().split('.')[-1]
                material_type = 'unknown'
                
                if file_ext in ['mp4', 'mov', 'avi', 'mkv', 'wmv', 'flv', 'webm']:
                    material_type = 'video'
                elif file_ext in ['mp3', 'wav', 'aac', 'flac', 'ogg', 'm4a']:
                    material_type = 'audio'
                elif file_ext in ['jpg', 'jpeg', 'png', 'gif', 'bmp', 'webp', 'svg']:
                    material_type = 'image'
                elif file_ext in ['txt', 'srt', 'vtt', 'ass']:
                    material_type = 'text'
                
                # 获取文件大小
                file_size = os.path.getsize(file_path)
                
                # 创建素材信息
                material_info = {
                    'id': f"{draft_id}_{filename}",
                    'name': filename,
                    'type': material_type,
                    'path': file_path,
                    'size': file_size,
                    'duration': '未知',  # 需要额外工具来获取媒体文件时长
                    'created_at': datetime.now().isoformat()
                }
                
                materials.append(material_info)
        
        # 将扫描到的素材信息缓存起来
        if materials:
            draft_materials_cache[draft_id] = materials
            # 可选：将素材信息保存到数据库
            for material in materials:
                try:
                    add_material_to_db(draft_id, material)
                except Exception as e:
                    print(f"保存素材到数据库失败: {e}")
        
        return materials
    
    # 都没有则返回空列表
    return []

@app.route('/', methods=['GET'])
def index():
    """根路径处理器，显示API服务信息"""
    # 检查请求头，如果是API调用则返回JSON
    if request.headers.get('Accept') == 'application/json':
        return jsonify({
            "success": True,
            "message": "CapCutAPI 服务运行正常",
            "version": "1.1.0",
            "server": "http://8.148.70.18:9000",
            "available_endpoints": [
                "GET / - 服务信息",
                "GET /get_intro_animation_types - 获取入场动画类型",
                "GET /get_outro_animation_types - 获取出场动画类型", 
                "GET /get_transition_types - 获取转场类型",
                "GET /get_mask_types - 获取遮罩类型",
                "GET /get_font_types - 获取字体类型",
                "POST /create_draft - 创建草稿",
                "POST /add_video - 添加视频",
                "POST /add_audio - 添加音频",
                "POST /add_text - 添加文本",
                "POST /add_subtitle - 添加字幕",
                "POST /add_image - 添加图片",
                "POST /add_effect - 添加特效",
                "POST /add_sticker - 添加贴纸",
                "POST /save_draft - 保存草稿"
            ],
            "documentation": "查看 API_USAGE_EXAMPLES.md 获取详细使用说明"
        })
    
    # 返回HTML欢迎页面
    html_content = """
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CapCutAPI 服务</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            padding: 40px;
            max-width: 800px;
            width: 90%;
            text-align: center;
        }
        .logo {
            font-size: 3em;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 20px;
        }
        .status {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            font-size: 1.1em;
        }
        .endpoints {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            text-align: left;
        }
        .endpoint {
            margin: 8px 0;
            padding: 8px;
            background: white;
            border-radius: 5px;
            border-left: 4px solid #667eea;
        }
        .method {
            font-weight: bold;
            color: #667eea;
        }
        .url {
            color: #495057;
            font-family: monospace;
        }
        .description {
            color: #6c757d;
            font-size: 0.9em;
        }
        .info {
            background: #e7f3ff;
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
        }
        .test-button {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1em;
            margin: 10px;
            transition: background 0.3s;
        }
        .test-button:hover {
            background: #5a6fd8;
        }
        .footer {
            margin-top: 30px;
            color: #6c757d;
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="logo">🎬 CapCutAPI</div>
        <div class="status">✅ 服务运行正常</div>
        
        <div class="info">
            <h3>服务器信息</h3>
            <p><strong>地址:</strong> http://8.148.70.18:9000</p>
            <p><strong>版本:</strong> 1.1.0</p>
            <p><strong>状态:</strong> 在线</p>
        </div>
        
        <div class="endpoints">
            <h3>可用的API端点</h3>
            <div class="endpoint">
                <span class="method">GET</span> <span class="url">/get_intro_animation_types</span>
                <div class="description">获取入场动画类型</div>
            </div>
            <div class="endpoint">
                <span class="method">GET</span> <span class="url">/get_outro_animation_types</span>
                <div class="description">获取出场动画类型</div>
            </div>
            <div class="endpoint">
                <span class="method">GET</span> <span class="url">/get_transition_types</span>
                <div class="description">获取转场类型</div>
            </div>
            <div class="endpoint">
                <span class="method">GET</span> <span class="url">/get_mask_types</span>
                <div class="description">获取遮罩类型</div>
            </div>
            <div class="endpoint">
                <span class="method">GET</span> <span class="url">/get_font_types</span>
                <div class="description">获取字体类型</div>
            </div>
            <div class="endpoint">
                <span class="method">POST</span> <span class="url">/create_draft</span>
                <div class="description">创建草稿</div>
            </div>
            <div class="endpoint">
                <span class="method">POST</span> <span class="url">/add_video</span>
                <div class="description">添加视频</div>
            </div>
            <div class="endpoint">
                <span class="method">POST</span> <span class="url">/add_text</span>
                <div class="description">添加文本</div>
            </div>
            <div class="endpoint">
                <span class="method">POST</span> <span class="url">/add_subtitle</span>
                <div class="description">添加字幕</div>
            </div>
            <div class="endpoint">
                <span class="method">POST</span> <span class="url">/save_draft</span>
                <div class="description">保存草稿</div>
            </div>
        </div>
        
        <div>
            <button class="test-button" onclick="testAPI()">测试API</button>
            <button class="test-button" onclick="showJSON()">显示JSON</button>
            <button class="test-button" onclick="openDashboard()">📊 草稿管理</button>
            <button class="test-button" onclick="openPreview()">🎬 预览演示</button>
        </div>
        
        <div class="footer">
            <p>📖 详细使用说明请查看 API_USAGE_EXAMPLES.md</p>
            <p>🔧 服务管理请使用 ./service_manager.sh</p>
        </div>
    </div>
    
    <script>
        function testAPI() {
            fetch('/get_intro_animation_types')
                .then(response => response.json())
                .then(data => {{
                    alert('API测试成功！\n获取到 ' + data.output.length + ' 个动画类型');
                })
                .catch(error => {{
                    alert('API测试失败：' + error);
                }}}});
        }
        
        function showJSON() {
            fetch('/', {
                headers: {
                    'Accept': 'application/json'
                }
            })
                .then(response => response.json())
                .then(data => {
                    alert(JSON.stringify(data, null, 2));
                })
                .catch(error => {
                    alert('获取JSON失败：' + error);
                }});
        }
        
        function openDashboard() {
            window.open('/api/drafts/dashboard', '_blank');
        }
        
        function openPreview() {
            window.open('/draft/preview/sample_draft', '_blank');
        }
    </script>
</body>
</html>
    """
    return html_content

@app.route('/add_video', methods=['POST'])
def add_video():
    data = request.get_json()
    # Get required parameters
    draft_folder = data.get('draft_folder')
    video_url = data.get('video_url')
    
    # Guard: reject unresolved placeholders to避免生成坏草稿
    if isinstance(video_url, str) and ('{{' in video_url or '}}' in video_url):
        return jsonify({"success": False, "error": "video_url 是占位符，未替换为真实地址。请在调用前先生成实际URL。", "hint": video_url})
    start = data.get('start', 0)
    end = data.get('end', 0)
    width = data.get('width', 1080)
    height = data.get('height', 1920)
    draft_id = data.get('draft_id')
    transform_y = data.get('transform_y', 0)
    scale_x = data.get('scale_x', 1)
    scale_y = data.get('scale_y', 1)
    transform_x = data.get('transform_x', 0)
    speed = data.get('speed', 1.0)  # New speed parameter
    target_start = data.get('target_start', 0)  # New target start time parameter
    track_name = data.get('track_name', "video_main")  # New track name parameter
    relative_index = data.get('relative_index', 0)  # New relative index parameter
    duration = data.get('duration')  # New duration parameter
    transition = data.get('transition')  # New transition type parameter
    transition_duration = data.get('transition_duration', 0.5)  # New transition duration parameter, default 0.5 seconds
    volume = data.get('volume', 1.0)  # New volume parameter, default 1.0 
    
    # Get mask related parameters
    mask_type = data.get('mask_type')  # Mask type
    mask_center_x = data.get('mask_center_x', 0.5)  # Mask center X coordinate
    mask_center_y = data.get('mask_center_y', 0.5)  # Mask center Y coordinate
    mask_size = data.get('mask_size', 1.0)  # Mask size, relative to screen height
    mask_rotation = data.get('mask_rotation', 0.0)  # Mask rotation angle
    mask_feather = data.get('mask_feather', 0.0)  # Mask feather degree
    mask_invert = data.get('mask_invert', False)  # Whether to invert mask
    mask_rect_width = data.get('mask_rect_width')  # Rectangle mask width
    mask_round_corner = data.get('mask_round_corner')  # Rectangle mask rounded corner

    background_blur = data.get('background_blur')  # Background blur level, optional values: 1 (light), 2 (medium), 3 (strong), 4 (maximum), default None (no background blur)

    result = {
        "success": False,
        "output": "",
        "error": ""
    }

    # Validate required parameters
    if not video_url:
        error_message = "Hi, the required parameters 'video_url' are missing."
        result["error"] = error_message
        return jsonify(result)

    try:
        draft_result = add_video_track(
            draft_folder=draft_folder,
            video_url=video_url,
            width=width,
            height=height,
            start=start,
            end=end,
            target_start=target_start,
            draft_id=draft_id,
            transform_y=transform_y,
            scale_x=scale_x,
            scale_y=scale_y,
            transform_x=transform_x,
            speed=speed,
            track_name=track_name,
            relative_index=relative_index,
            duration=duration,
            transition=transition,  # Pass transition type parameter
            transition_duration=transition_duration,  # Pass transition duration parameter
            volume=volume,  # Pass volume parameter
            # Pass mask related parameters
            mask_type=mask_type,
            mask_center_x=mask_center_x,
            mask_center_y=mask_center_y,
            mask_size=mask_size,
            mask_rotation=mask_rotation,
            mask_feather=mask_feather,
            mask_invert=mask_invert,
            mask_rect_width=mask_rect_width,
            mask_round_corner=mask_round_corner,
            background_blur=background_blur
        )
        
        result["success"] = True
        result["output"] = draft_result
        
        # 记录素材信息到缓存
        material_info = {
            "type": "video",
            "url": video_url,
            "start": start,
            "end": end,
            "duration": end - start if end > start else None,
            "track_name": track_name,
            "added_at": datetime.now().isoformat()
        }
        add_material_to_cache(draft_id, material_info)
        
        return jsonify(result)

    except Exception as e:
        error_message = f"Error occurred while processing video: {str(e)}."
        result["error"] = error_message
        return jsonify(result)

@app.route('/add_audio', methods=['POST'])
def add_audio():
    data = request.get_json()
    
    # Get required parameters
    draft_folder = data.get('draft_folder')
    audio_url = data.get('audio_url')
    
    # Guard: reject unresolved placeholders
    if isinstance(audio_url, str) and ('{{' in audio_url or '}}' in audio_url):
        return jsonify({"success": False, "error": "audio_url 是占位符，未替换为真实地址。请在调用前先生成实际URL。", "hint": audio_url})
    start = data.get('start', 0)
    end = data.get('end', None)
    draft_id = data.get('draft_id')
    volume = data.get('volume', 1.0)  # Default volume 1.0
    target_start = data.get('target_start', 0)  # New target start time parameter
    speed = data.get('speed', 1.0)  # New speed parameter
    track_name = data.get('track_name', 'audio_main')  # New track name parameter
    duration = data.get('duration', None)  # New duration parameter
    # Get audio effect parameters separately
    effect_type = data.get('effect_type', None)  # Audio effect type name
    effect_params = data.get('effect_params', None)  # Audio effect parameter list
    width = data.get('width', 1080)
    height = data.get('height', 1920)
    
    # # If there are audio effect parameters, combine them into sound_effects format
    sound_effects = None
    if effect_type is not None:
        sound_effects = [(effect_type, effect_params)]

    result = {
        "success": False,
        "output": "",
        "error": ""
    }

    # Validate required parameters
    if not audio_url:
        error_message = "Hi, the required parameters 'audio_url' are missing."
        result["error"] = error_message
        return jsonify(result)

    try:
        # Call the modified add_audio_track method
        draft_result = add_audio_track(
            draft_folder=draft_folder,
            audio_url=audio_url,
            start=start,
            end=end,
            target_start=target_start,
            draft_id=draft_id,
            volume=volume,
            track_name=track_name,
            speed=speed,
            sound_effects=sound_effects,  # Add audio effect parameters
            width=width,
            height=height,
            duration=duration  # Add duration parameter
        )
        
        result["success"] = True
        result["output"] = draft_result
        
        # 记录素材信息到缓存
        material_info = {
            "type": "audio",
            "url": audio_url,
            "start": start,
            "end": end,
            "duration": end - start if end and end > start else None,
            "track_name": track_name,
            "volume": volume,
            "added_at": datetime.now().isoformat()
        }
        add_material_to_cache(draft_id, material_info)
        
        return jsonify(result)

    except Exception as e:
        error_message = f"Error occurred while processing audio: {str(e)}."
        result["error"] = error_message
        return jsonify(result)

@app.route('/create_draft', methods=['POST'])
def create_draft_service():
    data = request.get_json()
    
    # Get parameters
    draft_id = data.get('draft_id')  # User specified draft ID
    width = data.get('width', 1080)
    height = data.get('height', 1920)
    
    result = {
        "success": False,
        "output": "",
        "error": ""
    }
    
    try:
        # Create new draft with user specified ID or generate one
        draft_id, script = get_or_create_draft(draft_id=draft_id, width=width, height=height)
        
        # 初始化草稿缓存，确保预览功能能够识别草稿存在
        if draft_id not in draft_materials_cache:
            draft_materials_cache[draft_id] = []
            # 添加基本草稿信息到缓存
            basic_info = {
                "type": "draft_info",
                "name": data.get('name', '未命名草稿'),
                "width": width,
                "height": height,
                "created_at": datetime.now().isoformat(),
                "status": "created"
            }
            draft_materials_cache[draft_id].append(basic_info)
        
        result["success"] = True
        result["output"] = {
            "draft_id": draft_id,
            "draft_url": utilgenerate_draft_url(draft_id)
        }
        result["error"] = ""
        return jsonify(result)
        
    except Exception as e:
        error_message = f"Error occurred while creating draft: {str(e)}."
        result["error"] = error_message
        return jsonify(result)
        
@app.route('/add_subtitle', methods=['POST'])
def add_subtitle():
    data = request.get_json()
    
    # Get required parameters
    srt = data.get('srt')  # Subtitle content or URL
    draft_id = data.get('draft_id')
    time_offset = data.get('time_offset', 0.0)  # Default 0 seconds
    
    # Font style parameters
    font = data.get('font', None)
    font_size = data.get('font_size', 5.0)  # Default size 5.0
    bold = data.get('bold', False)  # Default not bold
    italic = data.get('italic', False)  # Default not italic
    underline = data.get('underline', False)  # Default no underline
    font_color = data.get('font_color', '#FFFFFF')  # Default white
    vertical = data.get('vertical', False)  # New: whether to display vertically, default False
    alpha = data.get('alpha', 1)  # New: transparency, default 1
    # Border parameters
    border_alpha = data.get('border_alpha', 1.0)
    border_color = data.get('border_color', '#000000')
    border_width = data.get('border_width', 0.0)
    
    # Background parameters
    background_color = data.get('background_color', '#000000')
    background_style = data.get('background_style', 0)
    background_alpha = data.get('background_alpha', 0.0)
        
    # Image adjustment parameters
    transform_x = data.get('transform_x', 0.0)  # Default 0
    transform_y = data.get('transform_y', -0.8)  # Default -0.8
    scale_x = data.get('scale_x', 1.0)  # Default 1.0
    scale_y = data.get('scale_y', 1.0)  # Default 1.0
    rotation = data.get('rotation', 0.0)  # Default 0.0
    track_name = data.get('track_name', 'subtitle')  # Default track name is 'subtitle'
    width = data.get('width', 1080)
    height = data.get('height', 1920)

    result = {
        "success": False,
        "output": "",
        "error": ""
    }

    # Validate required parameters
    if not srt:
        error_message = "Hi, the required parameters 'srt' are missing."
        result["error"] = error_message
        return jsonify(result)

    try:
        # Call add_subtitle_impl method
        draft_result = add_subtitle_impl(
            srt_path=srt,
            draft_id=draft_id,
            track_name=track_name,
            time_offset=time_offset,
            # Font style parameters
            font = font,
            font_size=font_size,
            bold=bold,
            italic=italic,
            underline=underline,
            font_color=font_color,
            vertical=vertical,  # New: pass vertical parameter
            alpha=alpha,  # New: pass alpha parameter
            border_alpha=border_alpha,
            border_color=border_color,
            border_width=border_width,
            background_color=background_color,
            background_style=background_style,
            background_alpha=background_alpha,
            # Image adjustment parameters
            transform_x=transform_x,
            transform_y=transform_y,
            scale_x=scale_x,
            scale_y=scale_y,
            rotation=rotation,
            width=width,
            height=height
        )
        
        result["success"] = True
        result["output"] = draft_result
        return jsonify(result)

    except Exception as e:
        error_message = f"Error occurred while processing subtitle: {str(e)}."
        result["error"] = error_message
        return jsonify(result)

@app.route('/add_text', methods=['POST'])
def add_text():
    data = request.get_json()
    
    # Get required parameters
    text = data.get('text')
    start = data.get('start', 0)
    end = data.get('end', 5)
    draft_id = data.get('draft_id')
    transform_y = data.get('transform_y', 0)
    transform_x = data.get('transform_x', 0)
    font = data.get('font', "文轩体")
    font_color = data.get('color', data.get('font_color', "#FF0000"))  # Support both 'color' and 'font_color'
    font_size = data.get('size', data.get('font_size', 8.0))  # Support both 'size' and 'font_size'
    track_name = data.get('track_name', "text_main")
    vertical = data.get('vertical', False)
    font_alpha = data.get('alpha', data.get('font_alpha', 1.0))  # Support both 'alpha' and 'font_alpha'  
    outro_animation = data.get('outro_animation', None)
    outro_duration = data.get('outro_duration', 0.5)
    width = data.get('width', 1080)
    height = data.get('height', 1920)
    
    # New fixed width and height parameters 
    fixed_width = data.get('fixed_width', -1)
    fixed_height = data.get('fixed_height', -1)
    
    # Border parameters
    border_alpha = data.get('border_alpha', 1.0)
    border_color = data.get('border_color', "#000000")
    border_width = data.get('border_width', 0.0)
    
    # Background parameters
    background_color = data.get('background_color', "#000000")
    background_style = data.get('background_style', 0)
    background_alpha = data.get('background_alpha', 0.0)
    background_round_radius = data.get('background_round_radius', 0.0)
    background_height = data.get('background_height', 0.14)  # Background height, range 0.0-1.0
    background_width = data.get('background_width', 0.14)  # Background width, range 0.0-1.0
    background_horizontal_offset = data.get('background_horizontal_offset', 0.5)  # Background horizontal offset, range 0.0-1.0
    background_vertical_offset = data.get('background_vertical_offset', 0.5)  # Background vertical offset, range 0.0-1.0

    # Shadow parameters
    shadow_enabled = data.get('shadow_enabled', False)  # Whether to enable shadow
    shadow_alpha = data.get('shadow_alpha', 0.9)  # Shadow transparency, range 0.0-1.0
    shadow_angle = data.get('shadow_angle', -45.0)  # Shadow angle, range -180.0-180.0
    shadow_color = data.get('shadow_color', "#000000")  # Shadow color
    shadow_distance = data.get('shadow_distance', 5.0)  # Shadow distance
    shadow_smoothing = data.get('shadow_smoothing', 0.15)  # Shadow smoothing, range 0.0-1.0
    
    # Bubble and decorative text effects
    bubble_effect_id = data.get('bubble_effect_id')
    bubble_resource_id = data.get('bubble_resource_id')
    effect_effect_id = data.get('effect_effect_id')
    
    # Entrance animation
    intro_animation = data.get('intro_animation')
    intro_duration = data.get('intro_duration', 0.5)
    
    # Exit animation
    outro_animation = data.get('outro_animation')
    outro_duration = data.get('outro_duration', 0.5)

    # Multi-style text parameters
    text_styles_data = data.get('text_styles', [])
    text_styles = None
    if text_styles_data:
        text_styles = []
        for style_data in text_styles_data:
            # Get style range
            start_pos = style_data.get('start', 0)
            end_pos = style_data.get('end', 0)
            
            # Create text style
            style = Text_style(
                size=style_data.get('style',{}).get('size', font_size),
                bold=style_data.get('style',{}).get('bold', False),
                italic=style_data.get('style',{}).get('italic', False),
                underline=style_data.get('style',{}).get('underline', False),
                color=hex_to_rgb(style_data.get('style',{}).get('color', font_color)),
                alpha=style_data.get('style',{}).get('alpha', font_alpha),
                align=style_data.get('style',{}).get('align', 1),
                vertical=style_data.get('style',{}).get('vertical', vertical),
                letter_spacing=style_data.get('style',{}).get('letter_spacing', 0),
                line_spacing=style_data.get('style',{}).get('line_spacing', 0)
            )
            
            # Create border (if any)
            border = None
            if style_data.get('border',{}).get('width', 0) > 0:
                border = Text_border(
                    alpha=style_data.get('border',{}).get('alpha', border_alpha),
                    color=hex_to_rgb(style_data.get('border',{}).get('color', border_color)),
                    width=style_data.get('border',{}).get('width', border_width)
                )
            
            # Create style range object
            style_range = TextStyleRange(
                start=start_pos,
                end=end_pos,
                style=style,
                border=border,
                font_str=style_data.get('font', font)
            )
            
            text_styles.append(style_range)

    result = {
        "success": False,
        "output": "",
        "error": ""
    }

    # Validate required parameters
    if not text or start is None or end is None:
        error_message = "Hi, the required parameters 'text', 'start' or 'end' are missing. "
        result["error"] = error_message
        return jsonify(result)

    try:
        
        # Call add_text_impl method
        draft_result = add_text_impl(
            text=text,
            start=start,
            end=end,
            draft_id=draft_id,
            transform_y=transform_y,
            transform_x=transform_x,
            font=font,
            font_color=font_color,
            font_size=font_size,
            track_name=track_name,
            vertical=vertical,
            font_alpha=font_alpha,
            border_alpha=border_alpha,
            border_color=border_color,
            border_width=border_width,
            background_color=background_color,
            background_style=background_style,
            background_alpha=background_alpha,
            background_round_radius=background_round_radius,
            background_height=background_height,
            background_width=background_width,
            background_horizontal_offset=background_horizontal_offset,
            background_vertical_offset=background_vertical_offset,
            shadow_enabled=shadow_enabled,
            shadow_alpha=shadow_alpha,
            shadow_angle=shadow_angle,
            shadow_color=shadow_color,
            shadow_distance=shadow_distance,
            shadow_smoothing=shadow_smoothing,
            bubble_effect_id=bubble_effect_id,
            bubble_resource_id=bubble_resource_id,
            effect_effect_id=effect_effect_id,
            intro_animation=intro_animation,
            intro_duration=intro_duration,
            outro_animation=outro_animation,
            outro_duration=outro_duration,
            width=width,
            height=height,
            fixed_width=fixed_width,
            fixed_height=fixed_height,
            text_styles=text_styles
        )
        
        result["success"] = True
        result["output"] = draft_result
        
        # 记录素材信息到缓存
        material_info = {
            "type": "text",
            "content": text,
            "start": start,
            "end": end,
            "duration": end - start if end > start else None,
            "track_name": track_name,
            "font": font,
            "font_size": font_size,
            "added_at": datetime.now().isoformat()
        }
        add_material_to_cache(draft_id, material_info)
        
        return jsonify(result)

    except Exception as e:
        error_message = f"Error occurred while processing text: {str(e)}. You can click the link below for help: "
        result["error"] = error_message
        return jsonify(result)

@app.route('/add_image', methods=['POST'])
def add_image():
    data = request.get_json()
    
    # Get required parameters
    draft_folder = data.get('draft_folder')
    image_url = data.get('image_url')
    
    # Guard: reject unresolved placeholders
    if isinstance(image_url, str) and ('{{' in image_url or '}}' in image_url):
        return jsonify({"success": False, "error": "image_url 是占位符，未替换为真实地址。请在调用前先生成实际URL。", "hint": image_url})
    width = data.get('width', 1080)
    height = data.get('height', 1920)
    start = data.get('start', 0)
    end = data.get('end', 3.0)  # Default display 3 seconds
    draft_id = data.get('draft_id')
    transform_y = data.get('transform_y', 0)
    scale_x = data.get('scale_x', 1)
    scale_y = data.get('scale_y', 1)
    transform_x = data.get('transform_x', 0)
    track_name = data.get('track_name', "image_main")  # Default track name
    relative_index = data.get('relative_index', 0)  # New track rendering order index parameter 
    animation = data.get('animation')  # Entrance animation parameter (backward compatibility)
    animation_duration = data.get('animation_duration', 0.5)  # Entrance animation duration
    intro_animation = data.get('intro_animation')  # New entrance animation parameter, higher priority than animation
    intro_animation_duration = data.get('intro_animation_duration', 0.5)
    outro_animation = data.get('outro_animation')  # New exit animation parameter
    outro_animation_duration = data.get('outro_animation_duration', 0.5)  # New exit animation duration
    combo_animation = data.get('combo_animation')  # New combo animation parameter
    combo_animation_duration = data.get('combo_animation_duration', 0.5)  # New combo animation duration
    transition = data.get('transition')  # Transition type parameter
    transition_duration = data.get('transition_duration', 0.5)  # Transition duration parameter, default 0.5 seconds
    
    # New mask related parameters 
    mask_type = data.get('mask_type')  # Mask type
    mask_center_x = data.get('mask_center_x', 0.0)  # Mask center X coordinate
    mask_center_y = data.get('mask_center_y', 0.0)  # Mask center Y coordinate
    mask_size = data.get('mask_size', 0.5)  # Mask main size, relative to canvas height
    mask_rotation = data.get('mask_rotation', 0.0)  # Mask rotation angle
    mask_feather = data.get('mask_feather', 0.0)  # Mask feather parameter
    mask_invert = data.get('mask_invert', False)  # Whether to invert mask
    mask_rect_width = data.get('mask_rect_width')  # Rectangle mask width
    mask_round_corner = data.get('mask_round_corner')  # Rectangle mask rounded corner

    background_blur = data.get('background_blur')  # Background blur level, optional values: 1 (light), 2 (medium), 3 (strong), 4 (maximum), default None (no background blur)

    result = {
        "success": False,
        "output": "",
        "error": ""
    }

    # Validate required parameters
    if not image_url:
        error_message = "Hi, the required parameters 'image_url' are missing."
        result["error"] = error_message
        return jsonify(result)

    try:
        draft_result = add_image_impl(
            draft_folder=draft_folder,
            image_url=image_url,
            width=width,
            height=height,
            start=start,
            end=end,
            draft_id=draft_id,
            transform_y=transform_y,
            scale_x=scale_x,
            scale_y=scale_y,
            transform_x=transform_x,
            track_name=track_name,
            relative_index=relative_index,  # Pass track rendering order index parameter
            animation=animation,  # Pass entrance animation parameter (backward compatibility)
            animation_duration=animation_duration,  # Pass entrance animation duration
            intro_animation=intro_animation,  # Pass new entrance animation parameter
            intro_animation_duration=intro_animation_duration,
            outro_animation=outro_animation,  # Pass exit animation parameter
            outro_animation_duration=outro_animation_duration,  # Pass exit animation duration
            combo_animation=combo_animation,  # Pass combo animation parameter
            combo_animation_duration=combo_animation_duration,  # Pass combo animation duration
            transition=transition,  # Pass transition type parameter
            transition_duration=transition_duration,  # Pass transition duration parameter (seconds)
            # Pass mask related parameters
            mask_type=mask_type,
            mask_center_x=mask_center_x,
            mask_center_y=mask_center_y,
            mask_size=mask_size,
            mask_rotation=mask_rotation,
            mask_feather=mask_feather,
            mask_invert=mask_invert,
            mask_rect_width=mask_rect_width,
            mask_round_corner=mask_round_corner,
            background_blur=background_blur
        )
        
        result["success"] = True
        result["output"] = draft_result
        
        # 记录素材信息到缓存
        material_info = {
            "type": "image",
            "url": image_url,
            "start": start,
            "end": end,
            "duration": end - start if end > start else None,
            "track_name": track_name,
            "added_at": datetime.now().isoformat()
        }
        add_material_to_cache(draft_id, material_info)
        
        return jsonify(result)

    except Exception as e:
        error_message = f"Error occurred while processing image: {str(e)}."
        result["error"] = error_message
        return jsonify(result)

@app.route('/add_video_keyframe', methods=['POST'])
def add_video_keyframe():
    data = request.get_json()
    
    # Get required parameters
    draft_id = data.get('draft_id')
    track_name = data.get('track_name', 'video_main')  # Default main track
    
    # Single keyframe parameters (backward compatibility)
    property_type = data.get('property_type', 'alpha')  # Default opacity
    time = data.get('time', 0.0)  # Default 0 seconds
    value = data.get('value', '1.0')  # Default value 1.0
    
    # Batch keyframe parameters (new)
    property_types = data.get('property_types')  # Property type list
    times = data.get('times')  # Time list
    values = data.get('values')  # Value list

    result = {
        "success": False,
        "output": "",
        "error": ""
    }

    try:
        # Call add_video_keyframe_impl method
        draft_result = add_video_keyframe_impl(
            draft_id=draft_id,
            track_name=track_name,
            property_type=property_type,
            time=time,
            value=value,
            property_types=property_types,
            times=times,
            values=values
        )
        
        result["success"] = True
        result["output"] = draft_result
        return jsonify(result)

    except Exception as e:
        error_message = f"Error occurred while adding keyframe: {str(e)}."
        result["error"] = error_message
        return jsonify(result)

@app.route('/add_effect', methods=['POST'])
def add_effect():
    data = request.get_json()
    
    # Get required parameters
    effect_type = data.get('effect_type')  # Effect type name, will match from Video_scene_effect_type or Video_character_effect_type
    start = data.get('start', 0)  # Start time (seconds), default 0
    end = data.get('end', 3.0)  # End time (seconds), default 3 seconds
    draft_id = data.get('draft_id')  # Draft ID, if None or corresponding zip file not found, create new draft
    track_name = data.get('track_name', "effect_01")  # Track name, can be omitted when there is only one effect track
    params = data.get('params')  # Effect parameter list, items not provided or None in parameter list use default values
    width = data.get('width', 1080)
    height = data.get('height', 1920)

    result = {
        "success": False,
        "output": "",
        "error": ""
    }

    # Validate required parameters
    if not effect_type:
        error_message = "Hi, the required parameters 'effect_type' are missing. Please add them and try again."
        result["error"] = error_message
        return jsonify(result)

    try:
        # Call add_effect_impl method
        draft_result = add_effect_impl(
            effect_type=effect_type,
            start=start,
            end=end,
            draft_id=draft_id,
            track_name=track_name,
            params=params,
            width=width,
            height=height
        )
        
        result["success"] = True
        result["output"] = draft_result
        return jsonify(result)

    except Exception as e:
        error_message = f"Error occurred while adding effect: {str(e)}. "
        result["error"] = error_message
        return jsonify(result)

@app.route('/query_script', methods=['POST'])
def query_script():
    data = request.get_json()

    # Get required parameters
    draft_id = data.get('draft_id')
    force_update = data.get('force_update', True)
    
    result = {
        "success": False,
        "output": "",
        "error": ""
    }

    # Validate required parameters
    if not draft_id:
        error_message = "Hi, the required parameter 'draft_id' is missing. Please add it and try again."
        result["error"] = error_message
        return jsonify(result)

    try:
        # Call query_script_impl method
        script = query_script_impl(draft_id=draft_id, force_update=force_update)
        
        if script is None:
            error_message = f"Draft {draft_id} does not exist in cache."
            result["error"] = error_message
            return jsonify(result)
        
        # Convert script object to JSON serializable dictionary
        script_str = script.dumps()
        
        result["success"] = True
        result["output"] = script_str
        return jsonify(result)

    except Exception as e:
        error_message = f"Error occurred while querying script: {str(e)}. "
        result["error"] = error_message
        return jsonify(result)

@app.route('/save_draft', methods=['POST'])
def save_draft():
    data = request.get_json()
    
    # Get required parameters
    draft_id = (data.get('draft_id') or '').strip()
    draft_folder = data.get('draft_folder')  # Draft folder parameter
    
    result = {
        "success": False,
        "output": "",
        "error": ""
    }
    
    # Validate required parameters
    if not draft_id:
        error_message = "Hi, the required parameter 'draft_id' is missing. Please add it and try again."
        result["error"] = error_message
        return jsonify(result)
    
    try:
        # Call save_draft_impl method, start background task
        draft_result = save_draft_impl(draft_id, draft_folder)
        
        # Return the result from save_draft_impl directly
        return jsonify(draft_result)
        
    except Exception as e:
        error_message = f"Error occurred while saving draft: {str(e)}. "
        result["error"] = error_message
        return jsonify(result)

# Add new query status interface
@app.route('/query_draft_status', methods=['POST'])
def query_draft_status():
    data = request.get_json()
    
    # Get required parameters
    task_id = data.get('task_id')
    
    result = {
        "success": False,
        "output": "",
        "error": ""
    }
    
    # Validate required parameters
    if not task_id:
        error_message = "Hi, the required parameter 'task_id' is missing. Please add it and try again."
        result["error"] = error_message
        return jsonify(result)
    
    try:
        # Get task status
        task_status = query_task_status(task_id)
        
        if task_status["status"] == "not_found":
            error_message = f"Task with ID {task_id} not found. Please check if the task ID is correct."
            result["error"] = error_message
            return jsonify(result)
        
        # Return task status directly with success flag
        task_status["success"] = True
        return jsonify(task_status)
        
    except Exception as e:
        error_message = f"Error occurred while querying task status: {str(e)}."
        result["error"] = error_message
        return jsonify(result)

@app.route('/mirror_to_oss', methods=['POST'])
def mirror_to_oss():
    """Download an external URL (e.g., Dify file URL) and mirror it to our OSS bucket.
    Body: {"url": "http://...", "prefix": "capcut/images"}
    Return: {success, oss_url, object}
    """
    data = request.get_json(force=True, silent=True) or {}
    src_url = (data.get('url') or '').strip()
    prefix = (data.get('prefix') or 'capcut').strip().strip('/')
    if not src_url:
        return jsonify({"success": False, "error": "url required"}), 400
    try:
        # stream download
        r = requests.get(src_url, timeout=20, stream=True)
        r.raise_for_status()
        content_type = r.headers.get('Content-Type', '')
        ext = '.png'
        if 'jpeg' in content_type or 'jpg' in content_type:
            ext = '.jpg'
        elif 'webp' in content_type:
            ext = '.webp'
        elif 'gif' in content_type:
            ext = '.gif'
        object_name = f"{prefix}/{_uuid.uuid4().hex}{ext}" if prefix else f"{_uuid.uuid4().hex}{ext}"
        bucket = _ensure_bucket_v4()
        bucket.put_object(object_name, r.raw)
        signed = bucket.sign_url('GET', object_name, 24*60*60, slash_safe=True)
        return jsonify({"success": True, "oss_url": signed, "object": object_name})
    except Exception as e:
        return jsonify({"success": False, "error": str(e)}), 500

@app.route('/generate_draft_url', methods=['POST'])
def generate_draft_url():
    data = request.get_json(silent=True) or {}
    
    # Get required parameters
    draft_id = data.get('draft_id')
    draft_folder = data.get('draft_folder')  # Custom client base folder for local save use or display
    force_save = data.get('force_save')
    client_os = (data.get('client_os') or 'windows').lower()
    # Also accept query flag as compatibility
    if force_save is None:
        force_save = request.args.get('force_save', 'false').lower() in ['1', 'true', 'yes']
    
    result = {
        "success": False,
        "output": "",
        "error": ""
    }
    
    # Validate required parameters
    if not draft_id:
        error_message = "Hi, the required parameter 'draft_id' is missing. Please add it and try again."
        result["error"] = error_message
        return jsonify(result)
    
    try:
        # Sanitize and encode draft_id to avoid newline/space issues
        if isinstance(draft_id, str):
            draft_id = draft_id.strip()
        else:
            draft_id = str(draft_id).strip()
        safe_id = quote(draft_id, safe='-_.')

        # If upload-to-OSS mode is enabled and the draft zip already exists, return signed URL directly
        if IS_UPLOAD_DRAFT:
            signed_url, exists = get_signed_draft_url_if_exists(draft_id)
            if exists and signed_url:
                # If client provided customization info (os or draft_folder), generate derived zip
                if draft_folder or (client_os and client_os != 'windows'):
                    try:
                        if not draft_folder:
                            # If no explicit draft_folder, keep as-is but return base URL
                            pass
                        else:
                            custom_url = get_customized_signed_url(draft_id, client_os, draft_folder)
                            draft_result = {"draft_url": custom_url, "storage": "oss", "client_os": client_os, "draft_folder": draft_folder or ""}
                            result["success"] = True
                            result["output"] = draft_result
                            return jsonify(result)
                    except Exception as _:
                        # Fall back to base signed url on any failure
                        pass
                draft_result = {"draft_url": signed_url, "storage": "oss", "client_os": client_os, "draft_folder": draft_folder or ""}
                result["success"] = True
                result["output"] = draft_result
                return jsonify(result)

            # Not exists: if force_save requested, kick off background save now
            if force_save:
                task_info = save_draft_impl(draft_id, draft_folder)
                out = {
                    "status": "processing",
                    "task_id": task_info.get("task_id", draft_id),
                    "message": "Save task started. Please poll /query_draft_status until completed, then call /generate_draft_url again.",
                    "next": {
                        "query": "/query_draft_status",
                        "generate": "/generate_draft_url"
                    },
                    "client_os": client_os,
                    "draft_folder": draft_folder or ""
                }
                result["success"] = True
                result["output"] = out
                return jsonify(result)

        # Fallback to local preview router page
        draft_result = { "draft_url" : f"{DRAFT_DOMAIN}{PREVIEW_ROUTER}?draft_id={safe_id}", "storage": "local", "client_os": client_os, "draft_folder": draft_folder or ""}
        
        result["success"] = True
        result["output"] = draft_result
        return jsonify(result)
        
    except Exception as e:
        error_message = f"Error occurred while saving draft: {str(e)}."
        result["error"] = error_message
        return jsonify(result)

    
    import json as _json
    html_template = """
    <!DOCTYPE html>
    <html lang="zh-CN">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>草稿下载 - {draft_id}</title>
        <style>
            body { 
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', sans-serif; 
                padding: 0; 
                margin: 0;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                min-height: 100vh;
            }
            .header {
                background: rgba(255, 255, 255, 0.1);
                backdrop-filter: blur(10px);
                padding: 15px 20px;
                color: white;
                text-align: center;
                font-size: 20px;
                font-weight: 600;
            }
            .container { 
                max-width: 900px; 
                margin: 20px auto; 
                background: #fff; 
                border-radius: 15px; 
                box-shadow: 0 20px 40px rgba(0,0,0,0.1); 
                overflow: hidden;
            }
            .card-header {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                padding: 25px;
                text-align: center;
            }
            .card-body {
                padding: 30px;
            }
            .draft-info {
                background: #f8f9fa;
                border-radius: 10px;
                padding: 20px;
                margin-bottom: 25px;
                border-left: 4px solid #667eea;
            }
            .info-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: 15px;
                margin-top: 15px;
            }
            .info-item {
                background: white;
                padding: 15px;
                border-radius: 8px;
                text-align: center;
                box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            }
            .info-item .label {
                font-size: 12px;
                color: #6c757d;
                margin-bottom: 5px;
            }
            .info-item .value {
                font-size: 18px;
                font-weight: 600;
                color: #495057;
            }
            .controls-section {
                background: #f8f9fa;
                border-radius: 10px;
                padding: 20px;
                margin-bottom: 25px;
            }
            .section-title {
                font-size: 16px;
                font-weight: 600;
                color: #495057;
                margin-bottom: 15px;
                display: flex;
                align-items: center;
                gap: 8px;
            }
            .row { 
                display: flex; 
                align-items: center; 
                gap: 15px; 
                flex-wrap: wrap; 
                margin-bottom: 15px;
            }
            .form-group {
                flex: 1;
                min-width: 200px;
            }
            .form-group label {
                display: block;
                font-size: 14px;
                color: #495057;
                margin-bottom: 5px;
                font-weight: 500;
            }
            .id { 
                font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace; 
                color: #667eea; 
                background: rgba(102, 126, 234, 0.1);
                padding: 3px 8px;
                border-radius: 4px;
                font-weight: 600;
            }
            .path { 
                background: #e9ecef; 
                padding: 12px; 
                border-radius: 8px; 
                font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace; 
                font-size: 13px;
                overflow-x: auto;
                border: 1px solid #dee2e6;
                word-break: break-all;
            }
            .alert { 
                color: #155724;
                background: #d1ecf1;
                border: 1px solid #bee5eb;
                border-radius: 8px;
                padding: 15px;
                margin: 15px 0;
                font-size: 14px;
            }
            .alert-info {
                color: #0c5460;
                background: #d1ecf1;
                border-color: #bee5eb;
            }
            .alert-warning {
                color: #856404;
                background: #fff3cd;
                border-color: #ffeaa7;
            }
            .btn { 
                background: #667eea; 
                color: #fff; 
                border: none; 
                padding: 12px 20px; 
                border-radius: 8px; 
                cursor: pointer;
                font-size: 14px;
                font-weight: 500;
                transition: all 0.3s ease;
                display: inline-flex;
                align-items: center;
                gap: 8px;
                min-width: 120px;
                justify-content: center;
            }
            .btn:hover { 
                background: #5a6fd8;
                transform: translateY(-1px);
                box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
            }
            .btn:disabled { 
                opacity: 0.6; 
                cursor: not-allowed; 
                transform: none;
                box-shadow: none;
            }
            .btn-secondary {
                background: #6c757d;
            }
            .btn-secondary:hover {
                background: #5a6268;
            }
            .btn-success {
                background: #28a745;
            }
            .btn-success:hover {
                background: #218838;
            }
            .log { 
                margin-top: 15px; 
                background: #f8f9fa; 
                border-radius: 8px; 
                padding: 15px; 
                height: 200px; 
                overflow-y: auto; 
                font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace; 
                font-size: 12px;
                border: 1px solid #dee2e6;
                line-height: 1.5;
            }
            select, input[type="text"] { 
                padding: 10px 12px; 
                border-radius: 8px; 
                border: 1px solid #ced4da; 
                font-size: 14px;
                transition: border-color 0.3s ease, box-shadow 0.3s ease;
                width: 100%;
                box-sizing: border-box;
            }
            select:focus, input[type="text"]:focus {
                outline: none;
                border-color: #667eea;
                box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            }
            .action-buttons {
                display: flex;
                gap: 15px;
                flex-wrap: wrap;
                justify-content: center;
                margin-top: 20px;
            }
            .status-display {
                background: white;
                border-radius: 8px;
                padding: 15px;
                margin-top: 15px;
                border: 1px solid #dee2e6;
                text-align: center;
                font-weight: 500;
            }
            .loading {
                display: inline-block;
                width: 12px;
                height: 12px;
                border: 2px solid #f3f3f3;
                border-top: 2px solid #667eea;
                border-radius: 50%;
                animation: spin 1s linear infinite;
                margin-right: 8px;
            }
            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }
            .feature-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
                gap: 20px;
                margin-top: 20px;
            }
            .feature-card {
                background: white;
                border-radius: 10px;
                padding: 20px;
                box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                border: 1px solid #e9ecef;
            }
            .feature-icon {
                font-size: 24px;
                margin-bottom: 10px;
            }
            .feature-title {
                font-weight: 600;
                margin-bottom: 8px;
            }
            .feature-desc {
                font-size: 13px;
                color: #6c757d;
                line-height: 1.4;
            }
            @media (max-width: 768px) {
                .container {
                    margin: 10px;
                    border-radius: 10px;
                }
                .card-body {
                    padding: 20px;
                }
                .row {
                    flex-direction: column;
                    align-items: stretch;
                }
                .action-buttons {
                    flex-direction: column;
                }
                .btn {
                    width: 100%;
                }
            }
        </style>
    </head>
    <body>
        <div class="header">
            🎬 CapCutAPI - 草稿下载中心
        </div>
        
        <div class="container">
            <div class="card-header">
                <h2 style="margin: 0;">草稿下载管理</h2>
                <p style="margin: 10px 0 0; opacity: 0.9;">智能下载 · 多平台支持 · 云端同步</p>
            </div>
            
            <div class="card-body">
                <!-- 草稿信息展示 -->
                <div class="draft-info">
                    <div class="section-title">
                        📋 草稿信息
                    </div>
                    <p><strong>草稿 ID：</strong><span class="id">{draft_id}</span></p>
                    <div class="info-grid">
                        <div class="info-item">
                            <div class="label">素材数量</div>
                            <div class="value">{materials_count}</div>
                        </div>
                        <div class="info-item">
                            <div class="label">预计时长</div>
                            <div class="value">{total_duration}s</div>
                        </div>
                        <div class="info-item">
                            <div class="label">存储状态</div>
                            <div class="value">云端已保存</div>
                        </div>
                        <div class="info-item">
                            <div class="label">画面尺寸</div>
                            <div class="value">1080×1920</div>
                        </div>
                    </div>
                </div>
                
                <!-- 下载配置 -->
                <div class="controls-section">
                    <div class="section-title">
                        ⚙️ 下载配置
                    </div>
                    <div class="row">
                        <div class="form-group">
                            <label>目标系统:</label>
                            <select id="osSelect">
                                <option value="windows">Windows</option>
                                <option value="linux">Linux</option>
                                <option value="macos">macOS</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>自定义根路径 (可选):</label>
                            <input id="baseInput" type="text" placeholder="如: F:/MyDrafts 或 /data/drafts" />
                        </div>
                    </div>
                    
                    <div class="alert alert-info">
                        <strong>💡 提示：</strong>系统会根据你的选择自动生成适合的本地路径格式。OSS云下载模式下，文件会自动下载到指定位置。
                    </div>
                </div>
                
                <!-- 路径预览 -->
                <div class="controls-section">
                    <div class="section-title">
                        📁 本地路径预览
                    </div>
                    <div class="path" id="localPath">获取本地路径中...</div>
                </div>
                
                <!-- 功能特性展示 -->
                <div class="controls-section">
                    <div class="section-title">
                        ✨ 功能特性
                    </div>
                    <div class="feature-grid">
                        <div class="feature-card">
                            <div class="feature-icon">☁️</div>
                            <div class="feature-title">智能云下载</div>
                            <div class="feature-desc">自动检测云端文件，提供高速下载链接，支持断点续传</div>
                        </div>
                        <div class="feature-card">
                            <div class="feature-icon">🔄</div>
                            <div class="feature-title">实时同步</div>
                            <div class="feature-desc">草稿状态实时更新，支持后台处理进度监控</div>
                        </div>
                        <div class="feature-card">
                            <div class="feature-icon">🎯</div>
                            <div class="feature-title">精准适配</div>
                            <div class="feature-desc">根据系统类型自动调整路径格式，无缝集成到剪映</div>
                        </div>
                        <div class="feature-card">
                            <div class="feature-icon">📱</div>
                            <div class="feature-title">多平台支持</div>
                            <div class="feature-desc">支持Windows、Linux、macOS等多种操作系统</div>
                        </div>
                    </div>
                </div>
                
                <!-- 操作按钮 -->
                <div class="action-buttons">
                    <button id="previewBtn" class="btn btn-secondary" onclick="openPreview()">
                        🔍 预览草稿
                    </button>
                    <button id="saveUploadBtn" class="btn">
                        ☁️ 智能下载
                    </button>
                    <button id="copyPathBtn" class="btn btn-success" onclick="copyLocalPath()">
                        📋 复制路径
                    </button>
                </div>
                
                <!-- 状态显示 -->
                <div id="status" class="status-display">准备就绪</div>
                
                <!-- 日志显示 -->
                <div id="log" class="log" style="display: none;"></div>
            </div>
        </div>
        
        <script>
            const draftId = "{draft_id}";
            const btn = document.getElementById('saveUploadBtn');
            const statusEl = document.getElementById('status');
            const logEl = document.getElementById('log');
            const osSelect = document.getElementById('osSelect');
            const baseInput = document.getElementById('baseInput');
            
            // 设置初始系统类型
            osSelect.value = "{client_os}";
            try { 
                baseInput.value = new URL(window.location.href).searchParams.get('base') || ''; 
            } catch(e) {}
            
            // 监听系统选择变化
            osSelect.addEventListener('change', () => {
                updateLocalPath();
                updateURL();
            });
            
            // 监听路径输入变化
            baseInput.addEventListener('input', () => {
                updateLocalPath();
                updateURL();
            });
            
            // 更新URL参数
            function updateURL() {
                const url = new URL(window.location.href);
                url.searchParams.set('draft_id', draftId);
                url.searchParams.set('os', osSelect.value);
                if (baseInput.value) {
                    url.searchParams.set('base', baseInput.value);
                } else {
                    url.searchParams.delete('base');
                }
                window.history.replaceState({}, '', url.toString());
            }
            
            // 更新本地路径显示
            function updateLocalPath() {
                const localPathEl = document.getElementById('localPath');
                const clientOs = osSelect.value;
                const customBase = baseInput.value;
                
                let localPath = '';
                if (clientOs === 'windows') {
                    const base = customBase || 'F:\\\\jianyin\\\\cgwz\\\\JianyingPro Drafts';
                    localPath = base + '\\\\' + draftId;
                } else if (clientOs === 'macos') {
                    const base = customBase || '/Users/' + (window.navigator.userAgent.includes('Mac') ? 'YourUsername' : 'username') + '/Documents/JianyingPro Drafts';
                    localPath = base + '/' + draftId;
                } else {
                    const base = customBase || '/data/drafts';
                    localPath = base + '/' + draftId;
                }
                
                localPathEl.textContent = localPath;
            }
            
            // 日志记录函数
            function log(msg) {
                const t = new Date().toLocaleTimeString();
                logEl.textContent += `[${t}] ${msg}\\n`;
                logEl.scrollTop = logEl.scrollHeight;
                logEl.style.display = 'block';
            }
            
            // 复制本地路径
            function copyLocalPath() {
                const localPath = document.getElementById('localPath').textContent;
                navigator.clipboard.writeText(localPath).then(() => {
                    statusEl.innerHTML = '✅ 本地路径已复制到剪贴板';
                    setTimeout(() => {
                        statusEl.textContent = '准备就绪';
                    }, 3000);
                }).catch(() => {
                    statusEl.innerHTML = '❌ 复制失败，请手动复制：' + localPath;
                });
            }
            
            // 打开预览页面
            function openPreview() {
                const previewUrl = `/draft/preview/${draftId}`;
                window.open(previewUrl, '_blank');
            }
            
            // 发送JSON请求
            async function postJSON(url, body) {
                const res = await fetch(url, { 
                    method: 'POST', 
                    headers: {'Content-Type':'application/json'}, 
                    body: JSON.stringify(body) 
                });
                return await res.json();
            }
            
            // 轮询状态
            async function pollStatus(taskId) {
                while (true) {
                    const s = await postJSON('/query_draft_status', { task_id: taskId });
                    if (s && s.status) {
                        statusEl.innerHTML = `<div class="loading"></div>任务状态: ${s.status}，进度: ${s.progress||0}% ${s.message||''}`;
                        log(`status=${s.status}, progress=${s.progress}`);
                        if (s.status === 'completed') break;
                        if (s.status === 'failed') throw new Error(s.message || '任务失败');
                    }
                    await new Promise(r => setTimeout(r, 2000));
                }
            }
            
            // 最终跳转
            async function finalizeRedirect() {
                const r = await postJSON('/generate_draft_url', { 
                    draft_id: draftId, 
                    client_os: osSelect.value, 
                    draft_folder: baseInput.value || undefined 
                });
                if (r && r.success && r.output && r.output.draft_url) {
                    log('🎉 获取下载链接成功，即将跳转');
                    statusEl.innerHTML = '🎉 下载链接获取成功！即将跳转...';
                    setTimeout(() => {
                        window.open(r.output.draft_url, '_blank');
                    }, 1000);
                } else {
                    throw new Error('未获取到下载链接');
                }
            }
            
            // 自动运行
            async function autoRun() {
                try {
                    btn.disabled = true;
                    statusEl.innerHTML = '<div class="loading"></div>正在检测云端文件...';
                    log('🔍 检测是否已存在 OSS 直链');
                    
                    const first = await postJSON('/generate_draft_url', { 
                        draft_id: draftId, 
                        client_os: osSelect.value, 
                        draft_folder: baseInput.value || undefined 
                    }});
                    
                    if (first && first.success && first.output) {
                        if (first.output.storage === 'oss' && first.output.draft_url) {
                            log('✅ 发现已存在的云端文件，直接跳转');
                            statusEl.innerHTML = '✅ 发现云端文件！即将跳转下载...';
                            setTimeout(() => {{
                                window.open(first.output.draft_url, '_blank');
                            }, 1000);
                            return;
                        }
                    }
                    
                    log('📤 未发现直链，自动触发保存并上传');
                    statusEl.innerHTML = '<div class="loading"></div>正在提交保存任务...';
                    
                    const start = await postJSON('/generate_draft_url?force_save=true', { 
                        draft_id: draftId, 
                        client_os: osSelect.value, 
                        draft_folder: baseInput.value || undefined 
                    }});
                    
                    if (start && start.success && start.output) {
                        if (start.output.storage === 'oss' && start.output.draft_url) {
                            log('⚡ 快速保存完成，直接跳转');
                            window.open(start.output.draft_url, '_blank');
                            return;
                        }
                        if (start.output.status === 'processing' && start.output.task_id) {
                            log('⏳ 任务已提交，等待处理完成...');
                            await pollStatus(start.output.task_id);
                            await finalizeRedirect();
                            return;
                        }
                    }
                    throw new Error('自动流程接口返回异常');
                } catch (e) {
                    log('❌ 自动流程失败: ' + e.message);
                    statusEl.innerHTML = '❌ 自动下载失败，请点击按钮重试';
                } finally {
                    btn.disabled = false;
                }
            }
            
            // 页面加载完成后初始化
            document.addEventListener('DOMContentLoaded', () => {
                updateLocalPath();
                // 延迟启动自动下载，给用户时间看到页面
                setTimeout(autoRun, 1000);
            });
            
            // 手动下载按钮事件
            btn.addEventListener('click', async () => {
                btn.disabled = true; 
                statusEl.innerHTML = '<div class="loading"></div>正在提交任务...'; 
                log('🚀 手动触发 force_save 请求');
                try {
                    const r = await postJSON('/generate_draft_url?force_save=true', { 
                        draft_id: draftId, 
                        client_os: osSelect.value, 
                        draft_folder: baseInput.value || undefined 
                    }});
                    if (r && r.success && r.output) {
                        if (r.output.storage === 'oss' && r.output.draft_url) {
                            window.open(r.output.draft_url, '_blank');
                            return;
                        }
                        if (r.output.status === 'processing' && r.output.task_id) {
                            await pollStatus(r.output.task_id);
                            await finalizeRedirect();
                            return;
                        }
                    }
                    throw new Error('接口返回异常');
                } catch (e) {
                    statusEl.innerHTML = '❌ 操作失败: ' + e.message;
                    log('❌ 失败: ' + e.message);
                } finally {
                    btn.disabled = false;
                }
            });
        </script>
    </body>
    </html>
    """.format(
        draft_id=draft_id,
        client_os=client_os,
        materials_count=materials_count,
        total_duration=total_duration
    )
    
    return html_template

@app.route('/add_sticker', methods=['POST'])
def add_sticker():
    data = request.get_json()
    # Get required parameters
    resource_id = data.get('sticker_id')
    start = data.get('start', 0)
    end = data.get('end', 5.0)  # Default display 5 seconds
    draft_id = data.get('draft_id')
    transform_y = data.get('transform_y', 0)
    transform_x = data.get('transform_x', 0)
    alpha = data.get('alpha', 1.0)
    flip_horizontal = data.get('flip_horizontal', False)
    flip_vertical = data.get('flip_vertical', False)
    rotation = data.get('rotation', 0.0)
    scale_x = data.get('scale_x', 1.0)
    scale_y = data.get('scale_y', 1.0)
    track_name = data.get('track_name', 'sticker_main')
    relative_index = data.get('relative_index', 0)
    width = data.get('width', 1080)
    height = data.get('height', 1920)

    result = {
        "success": False,
        "output": "",
        "error": ""
    }

    # Validate required parameters
    if not resource_id:
        error_message = "Hi, the required parameter 'sticker_id' is missing. Please add it and try again. "
        result["error"] = error_message
        return jsonify(result)

    try:
        # Call add_sticker_impl method
        draft_result = add_sticker_impl(
            resource_id=resource_id,
            start=start,
            end=end,
            draft_id=draft_id,
            transform_y=transform_y,
            transform_x=transform_x,
            alpha=alpha,
            flip_horizontal=flip_horizontal,
            flip_vertical=flip_vertical,
            rotation=rotation,
            scale_x=scale_x,
            scale_y=scale_y,
            track_name=track_name,
            relative_index=relative_index,
            width=width,
            height=height
        )

        result["success"] = True
        result["output"] = draft_result
        return jsonify(result)

    except Exception as e:
        error_message = f"Error occurred while adding sticker: {str(e)}. "
        result["error"] = error_message
        return jsonify(result)

@app.route('/get_intro_animation_types', methods=['GET'])
def get_intro_animation_types():
    """Return supported entrance animation type list
    
    If IS_CAPCUT_ENV is True, return entrance animation types in CapCut environment
    Otherwise return entrance animation types in JianYing environment
    """
    result = {
        "success": True,
        "output": "",
        "error": ""
    }
    
    try:
        animation_types = []
        
        if IS_CAPCUT_ENV:
            # Return entrance animation types in CapCut environment
            for name, member in CapCut_Intro_type.__members__.items():
                animation_types.append({
                    "name": name
                })
        else:
            # Return entrance animation types in JianYing environment
            for name, member in Intro_type.__members__.items():
                animation_types.append({
                    "name": name
                })
        
        result["output"] = animation_types
        return jsonify(result)
    
    except Exception as e:
        result["success"] = False
        result["error"] = f"Error occurred while getting entrance animation types: {str(e)}"
        return jsonify(result)
        
@app.route('/get_outro_animation_types', methods=['GET'])
def get_outro_animation_types():
    """Return supported exit animation type list
    
    If IS_CAPCUT_ENV is True, return exit animation types in CapCut environment
    Otherwise return exit animation types in JianYing environment
    """
    result = {
        "success": True,
        "output": "",
        "error": ""
    }
    
    try:
        animation_types = []
        
        if IS_CAPCUT_ENV:
            # Return exit animation types in CapCut environment
            for name, member in CapCut_Outro_type.__members__.items():
                animation_types.append({
                    "name": name
                })
        else:
            # Return exit animation types in JianYing environment
            for name, member in Outro_type.__members__.items():
                animation_types.append({
                    "name": name
                })
        
        result["output"] = animation_types
        return jsonify(result)
    
    except Exception as e:
        result["success"] = False
        result["error"] = f"Error occurred while getting exit animation types: {str(e)}"
        return jsonify(result)


@app.route('/get_combo_animation_types', methods=['GET'])
def get_combo_animation_types():
    """Return supported combo animation type list
    
    If IS_CAPCUT_ENV is True, return combo animation types in CapCut environment
    Otherwise return combo animation types in JianYing environment
    """
    result = {
        "success": True,
        "output": "",
        "error": ""
    }
    
    try:
        animation_types = []
        
        if IS_CAPCUT_ENV:
            # Return combo animation types in CapCut environment
            for name, member in CapCut_Group_animation_type.__members__.items():
                animation_types.append({
                    "name": name
                })
        else:
            # Return combo animation types in JianYing environment
            for name, member in Group_animation_type.__members__.items():
                animation_types.append({
                    "name": name
                })
        
        result["output"] = animation_types
        return jsonify(result)
    
    except Exception as e:
        result["success"] = False
        result["error"] = f"Error occurred while getting combo animation types: {str(e)}"
        return jsonify(result)


@app.route('/get_transition_types', methods=['GET'])
def get_transition_types():
    """Return supported transition animation type list
    
    If IS_CAPCUT_ENV is True, return transition animation types in CapCut environment
    Otherwise return transition animation types in JianYing environment
    """
    result = {
        "success": True,
        "output": "",
        "error": ""
    }
    
    try:
        transition_types = []
        
        if IS_CAPCUT_ENV:
            # Return transition animation types in CapCut environment
            for name, member in CapCut_Transition_type.__members__.items():
                transition_types.append({
                    "name": name
                })
        else:
            # Return transition animation types in JianYing environment
            for name, member in Transition_type.__members__.items():
                transition_types.append({
                    "name": name
                })
        
        result["output"] = transition_types
        return jsonify(result)
    
    except Exception as e:
        result["success"] = False
        result["error"] = f"Error occurred while getting transition animation types: {str(e)}"
        return jsonify(result)


@app.route('/get_mask_types', methods=['GET'])
def get_mask_types():
    """Return supported mask type list
    
    If IS_CAPCUT_ENV is True, return mask types in CapCut environment
    Otherwise return mask types in JianYing environment
    """
    result = {
        "success": True,
        "output": "",
        "error": ""
    }
    
    try:
        mask_types = []
        
        if IS_CAPCUT_ENV:
            # Return mask types in CapCut environment
            for name, member in CapCut_Mask_type.__members__.items():
                mask_types.append({
                    "name": name
                })
        else:
            # Return mask types in JianYing environment
            for name, member in Mask_type.__members__.items():
                mask_types.append({
                    "name": name
                })
        
        result["output"] = mask_types
        return jsonify(result)
    
    except Exception as e:
        result["success"] = False
        result["error"] = f"Error occurred while getting mask types: {str(e)}"
        return jsonify(result)


@app.route('/get_audio_effect_types', methods=['GET'])
def get_audio_effect_types():
    """Return supported audio effect type list
    
    If IS_CAPCUT_ENV is True, return audio effect types in CapCut environment
    Otherwise return audio effect types in JianYing environment
    
    The returned structure includes name, type and Effect_param information
    """
    result = {
        "success": True,
        "output": "",
        "error": ""
    }
    
    try:
        audio_effect_types = []
        
        if IS_CAPCUT_ENV:
            # Return audio effect types in CapCut environment
            # 1. Voice filters effect types
            for name, member in CapCut_Voice_filters_effect_type.__members__.items():
                params_info = []
                for param in member.value.params:
                    params_info.append({
                        "name": param.name,
                        "default_value": param.default_value * 100,
                        "min_value": param.min_value * 100,
                        "max_value": param.max_value * 100
                    })
                
                audio_effect_types.append({
                    "name": name,
                    "type": "Voice_filters",
                    "params": params_info
                })
            
            # 2. Voice characters effect types
            for name, member in CapCut_Voice_characters_effect_type.__members__.items():
                params_info = []
                for param in member.value.params:
                    params_info.append({
                        "name": param.name,
                        "default_value": param.default_value * 100,
                        "min_value": param.min_value * 100,
                        "max_value": param.max_value * 100
                    })
                
                audio_effect_types.append({
                    "name": name,
                    "type": "Voice_characters",
                    "params": params_info
                })
            
            # 3. Speech to song effect types
            for name, member in CapCut_Speech_to_song_effect_type.__members__.items():
                params_info = []
                for param in member.value.params:
                    params_info.append({
                        "name": param.name,
                        "default_value": param.default_value * 100,
                        "min_value": param.min_value * 100,
                        "max_value": param.max_value * 100
                    })
                
                audio_effect_types.append({
                    "name": name,
                    "type": "Speech_to_song",
                    "params": params_info
                })
        else:
            # Return audio effect types in JianYing environment
            # 1. Tone effect types
            for name, member in Tone_effect_type.__members__.items():
                params_info = []
                for param in member.value.params:
                    params_info.append({
                        "name": param.name,
                        "default_value": param.default_value * 100,
                        "min_value": param.min_value * 100,
                        "max_value": param.max_value * 100
                    })
                
                audio_effect_types.append({
                    "name": name,
                    "type": "Tone",
                    "params": params_info
                })
            
            # 2. Audio scene effect types
            for name, member in Audio_scene_effect_type.__members__.items():
                params_info = []
                for param in member.value.params:
                    params_info.append({
                        "name": param.name,
                        "default_value": param.default_value * 100,
                        "min_value": param.min_value * 100,
                        "max_value": param.max_value * 100
                    })
                
                audio_effect_types.append({
                    "name": name,
                    "type": "Audio_scene",
                    "params": params_info
                })
            
            # 3. Speech to song effect types
            for name, member in Speech_to_song_type.__members__.items():
                params_info = []
                for param in member.value.params:
                    params_info.append({
                        "name": param.name,
                        "default_value": param.default_value * 100,
                        "min_value": param.min_value * 100,
                        "max_value": param.max_value * 100
                    })
                
                audio_effect_types.append({
                    "name": name,
                    "type": "Speech_to_song",
                    "params": params_info
                })
        
        result["output"] = audio_effect_types
        return jsonify(result)
    
    except Exception as e:
        result["success"] = False
        result["error"] = f"Error occurred while getting audio effect types: {str(e)}"
        return jsonify(result)


@app.route('/get_font_types', methods=['GET'])
def get_font_types():
    """Return supported font type list
    
    Return font types in JianYing environment
    """
    result = {
        "success": True,
        "output": "",
        "error": ""
    }
    
    try:
        font_types = []
        
        # Return font types in JianYing environment
        for name, member in Font_type.__members__.items():
            font_types.append({
                "name": name
            })
        
        result["output"] = font_types
        return jsonify(result)
    
    except Exception as e:
        result["success"] = False
        result["error"] = f"Error occurred while getting font types: {str(e)}"
        return jsonify(result)


@app.route('/get_text_intro_types', methods=['GET'])
def get_text_intro_types():
    """Return supported text entrance animation type list
    
    If IS_CAPCUT_ENV is True, return text entrance animation types in CapCut environment
    Otherwise return text entrance animation types in JianYing environment
    """
    result = {
        "success": True,
        "output": "",
        "error": ""
    }
    
    try:
        text_intro_types = []
        
        if IS_CAPCUT_ENV:
            # Return text entrance animation types in CapCut environment
            for name, member in CapCut_Text_intro.__members__.items():
                text_intro_types.append({
                    "name": name
                })
        else:
            # Return text entrance animation types in JianYing environment
            for name, member in Text_intro.__members__.items():
                text_intro_types.append({
                    "name": name
                })
        
        result["output"] = text_intro_types
        return jsonify(result)
    
    except Exception as e:
        result["success"] = False
        result["error"] = f"Error occurred while getting text entrance animation types: {str(e)}"
        return jsonify(result)

@app.route('/get_text_outro_types', methods=['GET'])
def get_text_outro_types():
    """Return supported text exit animation type list
    
    If IS_CAPCUT_ENV is True, return text exit animation types in CapCut environment
    Otherwise return text exit animation types in JianYing environment
    """
    result = {
        "success": True,
        "output": "",
        "error": ""
    }
    
    try:
        text_outro_types = []
        
        if IS_CAPCUT_ENV:
            # Return text exit animation types in CapCut environment
            for name, member in CapCut_Text_outro.__members__.items():
                text_outro_types.append({
                    "name": name
                })
        else:
            # Return text exit animation types in JianYing environment
            for name, member in Text_outro.__members__.items():
                text_outro_types.append({
                    "name": name
                })
        
        result["output"] = text_outro_types
        return jsonify(result)
    
    except Exception as e:
        result["success"] = False
        result["error"] = f"Error occurred while getting text exit animation types: {str(e)}"
        return jsonify(result)

@app.route('/get_text_loop_anim_types', methods=['GET'])
def get_text_loop_anim_types():
    """Return supported text loop animation type list
    
    If IS_CAPCUT_ENV is True, return text loop animation types in CapCut environment
    Otherwise return text loop animation types in JianYing environment
    """
    result = {
        "success": True,
        "output": "",
        "error": ""
    }
    
    try:
        text_loop_anim_types = []
        
        if IS_CAPCUT_ENV:
            # Return text loop animation types in CapCut environment
            for name, member in CapCut_Text_loop_anim.__members__.items():
                text_loop_anim_types.append({
                    "name": name
                })
        else:
            # Return text loop animation types in JianYing environment
            for name, member in Text_loop_anim.__members__.items():
                text_loop_anim_types.append({
                    "name": name
                })
        
        result["output"] = text_loop_anim_types
        return jsonify(result)
    
    except Exception as e:
        result["success"] = False
        result["error"] = f"Error occurred while getting text loop animation types: {str(e)}"
        return jsonify(result)


@app.route('/get_video_scene_effect_types', methods=['GET'])
def get_video_scene_effect_types():
    """Return supported scene effect type list
    
    If IS_CAPCUT_ENV is True, return scene effect types in CapCut environment
    Otherwise return scene effect types in JianYing environment
    """
    result = {
        "success": True,
        "output": "",
        "error": ""
    }
    
    try:
        effect_types = []
        
        if IS_CAPCUT_ENV:
            # Return scene effect types in CapCut environment
            for name, member in CapCut_Video_scene_effect_type.__members__.items():
                effect_types.append({
                    "name": name
                })
        else:
            # Return scene effect types in JianYing environment
            for name, member in Video_scene_effect_type.__members__.items():
                effect_types.append({
                    "name": name
                })
        
        result["output"] = effect_types
        return jsonify(result)
    
    except Exception as e:
        result["success"] = False
        result["error"] = f"Error occurred while getting scene effect types: {str(e)}"
        return jsonify(result)


@app.route('/get_video_character_effect_types', methods=['GET'])
def get_video_character_effect_types():
    """Return supported character effect type list
    
    If IS_CAPCUT_ENV is True, return character effect types in CapCut environment
    Otherwise return character effect types in JianYing environment
    """
    result = {
        "success": True,
        "output": "",
        "error": ""
    }
    
    try:
        effect_types = []
        
        if IS_CAPCUT_ENV:
            # Return character effect types in CapCut environment
            for name, member in CapCut_Video_character_effect_type.__members__.items():
                effect_types.append({
                    "name": name
                })
        else:
            # Return character effect types in JianYing environment
            for name, member in Video_character_effect_type.__members__.items():
                effect_types.append({
                    "name": name
                })
        
        result["output"] = effect_types
        return jsonify(result)
    
    except Exception as e:
        result["success"] = False
        result["error"] = f"Error occurred while getting character effect types: {str(e)}"
        return jsonify(result)

@app.route('/upload_to_oss', methods=['POST'])
def upload_to_oss_route():
    """Upload binary content to OSS and return signed url.
    Accepts:
    - multipart/form-data: file=<binary>, prefix
    - application/json: {"filename":"a.png","data_base64":"...","prefix":"capcut/images"}
    Return: {success, oss_url, object}
    """
    try:
        prefix = (request.form.get('prefix') or request.args.get('prefix') or 'capcut').strip().strip('/')
        data = None
        filename = None
        if 'file' in request.files:
            f = request.files['file']
            data = f.read()
            filename = f.filename or 'upload.bin'
        else:
            js = request.get_json(silent=True) or {}
            filename = js.get('filename') or 'upload.bin'
            b64 = js.get('data_base64') or ''
            if b64:
                import base64
                try:
                    data = base64.b64decode(b64)
                except Exception:
                    return jsonify({"success": False, "error": "invalid base64"}), 400
        if not data:
            return jsonify({"success": False, "error": "no file provided"}), 400
        # guess extension
        ext = '.bin'
        lower = (filename or '').lower()
        if lower.endswith('.png'):
            ext = '.png'
        elif lower.endswith('.jpg') or lower.endswith('.jpeg'):
            ext = '.jpg'
        elif lower.endswith('.webp'):
            ext = '.webp'
        elif lower.endswith('.gif'):
            ext = '.gif'
        object_name = f"{prefix}/{_uuid.uuid4().hex}{ext}" if prefix else f"{_uuid.uuid4().hex}{ext}"
        bucket = _ensure_bucket_v4()
        bucket.put_object(object_name, data)
        signed = bucket.sign_url('GET', object_name, 24*60*60, slash_safe=True)
        return jsonify({"success": True, "oss_url": signed, "object": object_name})
    except Exception as e:
        return jsonify({"success": False, "error": str(e)}), 500

# 草稿管理相关路由已在文件后面定义

# 草稿预览路由
@app.route('/api/drafts/preview/<draft_id>', methods=['GET'])
def preview_draft(draft_id):
    """
    预览特定草稿，显示草稿信息和素材
    """
    try:
        # 获取草稿信息
        draft_info = get_draft_info(draft_id)
        if not draft_info:
            return f"<h1>草稿不存在</h1><p>草稿ID: {draft_id}</p>", 404
        
        # 获取草稿素材
        materials = get_draft_materials(draft_id)
        
        # 生成时间轴HTML
        timeline_html = generate_timeline_html(materials)
        
        # 渲染预览页面
        return render_preview_page(draft_id, draft_info, materials, timeline_html)
    except Exception as e:
        return f"""
        <html>
        <head>
            <title>错误</title>
        </head>
        <body>
            <h1>加载草稿时出错</h1>
            <p>错误信息: {str(e)}</p>
            <a href="/api/drafts/dashboard">返回仪表板</a>
        </body>
        </html>
        """
        # 使用简单的字符串替换，避免格式化问题
        # 生成SSR内容
        def html_escape(text: str) -> str:
                        return html.escape(text) if isinstance(text, str) else str(text)

        # Details 首屏渲染：展示第一个素材
        first = materials[0] if materials else {}
        startTime = float(first.get('start_time') or first.get('start') or 0)
        duration = float(first.get('duration') or ((first.get('end') or 0) - (first.get('start') or 0)) or 0)
        endTime = startTime + duration
        ssr_rows = [
            ('Type:', first.get('type') or 'video'),
            ('Source URL:', first.get('source_url') or first.get('url') or 'N/A'),
            ('Start Time:', f"{startTime:.2f}s"),
            ('End Time:', f"{endTime:.2f}s"),
            ('Duration:', f"{duration:.2f}s"),
            ('Track Name:', first.get('track_name') or 'N/A'),
        ]
        ssr_details_rows = ''.join([
            f"<tr><td>{html_escape(k)}</td><td>" + (f"<a class='url-link' target='_blank' href='{html_escape(v)}'>{html_escape(v)}</a>" if k=='Source URL:' and v!='N/A' else html_escape(v)) + "</td></tr>"
            for k, v in ssr_rows
        ])

        # Timeline 首屏渲染
        lane_order = {'video':0, 'image':1, 'text':2, 'audio_voice':3, 'audio_bgm':4, 'audio':4}
        def classify_audio(m):
            tn = (m.get('track_name') or '')
            if any(x in tn.lower() for x in ['voice', 'narrat']):
                return 'audio_voice'
            if any(x in tn.lower() for x in ['bgm', 'music']):
                return 'audio_bgm'
            return 'audio'
        lane_height, gap = 28, 4
        tl_width_pct = 100  # SSR 用百分比，前端接管后会重算像素
        ssr_blocks = []
        for idx, m in enumerate(materials):
            mtype = m.get('type') or 'video'
            if mtype == 'audio':
                mtype = classify_audio(m)
            s = float(m.get('start_time') or m.get('start') or 0)
            d = float(m.get('duration') or ((m.get('end') or 0) - (m.get('start') or 0)) or 0)
            left_pct = (s / max(total_duration, 1)) * tl_width_pct
            width_pct = max((d / max(total_duration, 1)) * tl_width_pct, 3)
            lane_idx = lane_order.get(mtype, 0)
            top_px = lane_idx * (lane_height + gap)
            name = m.get('name') or (m.get('source_url') or m.get('url') or '').split('/')[-1] or 'Material'
            short = (name[:22] + '...') if len(name) > 25 else name
            icon = '🎥' if m.get('type')=='video' else '🎵' if m.get('type')=='audio' else '📝' if m.get('type')=='text' else '🖼️' if m.get('type')=='image' else '📄'
            ssr_blocks.append(
                f"<div class='material-block {m.get('type','video')} lane-height' style='left:{left_pct}%;width:{width_pct}%;top:{top_px}px'><span class='material-icon'>{icon}</span><span style='font-size:11px'>{html_escape(short)}</span><span style='font-size:10px;opacity:.9;margin-left:6px'>{d:.1f}s</span></div>"
            )
        lanes_used = 0
        for m in materials:
            mt = m.get('type') or 'video'
            if mt == 'audio':
                mt = classify_audio(m)
            lanes_used = max(lanes_used, lane_order.get(mt, 0))
        ssr_timeline_blocks = ''.join(ssr_blocks)
        ssr_timeline_height = (lanes_used + 1) * (lane_height + gap)
        result = html_template.replace('{draft_id}', draft_id) \
                              .replace('{materials_json}', materials_json) \
                              .replace('{total_duration}', str(total_duration)) \
                              .replace('{ssr_details_rows}', ssr_details_rows) \
                                                             .replace('{ssr_timeline_blocks}', ssr_timeline_blocks) \
                              .replace('{ssr_timeline_height}', str(ssr_timeline_height))
        resp = Response(result)
        resp.headers['Content-Type'] = 'text/html; charset=utf-8'
        resp.headers['Cache-Control'] = 'no-store, no-cache, must-revalidate, max-age=0'
        resp.headers['Pragma'] = 'no-cache'
        resp.headers['Expires'] = '0'
        return resp
        
    except Exception as e:
        return f"预览页面生成失败: {str(e)}", 500
        
@app.route('/debug/cache/<draft_id>', methods=['GET'])
def debug_cache(draft_id: str):
    """调试：查看草稿缓存内容"""
    materials = get_draft_materials(draft_id)
    return jsonify({
        "success": True,
        "draft_id": draft_id,
        "materials_count": len(materials),
        "materials": materials,
        "cache_source": "test_materials.json" if draft_id in draft_materials_cache else "cache"
    })

@app.route('/api/drafts/list', methods=['GET'])
def list_drafts():
    """获取所有可用草稿列表 - 新增功能"""
    try:
        from datetime import datetime
        
        db_drafts = get_all_drafts()
        
        drafts_list = []
        for row in db_drafts:
            draft_id, last_modified, materials_count = row
            drafts_list.append({
                "draft_id": draft_id,
                "source": "database",
                "materials_count": materials_count,
                "status": "已保存",
                "last_modified": last_modified
            })

        return jsonify({
            "success": True,
            "drafts": drafts_list,
            "total": len(drafts_list),
            "error": ""
        })
        
    except Exception as e:
        return jsonify({
            "success": False,
            "drafts": [],
            "total": 0,
            "error": f"获取草稿列表失败: {str(e)}"
        })

from database import update_draft_status

@app.route('/api/draft/long_poll_status', methods=['GET'])
def long_poll_draft_status():
    draft_id = request.args.get('draft_id')
    last_status = request.args.get('last_status')
    timeout = int(request.args.get('timeout', 30))

    if not draft_id:
        return jsonify({"success": False, "error": "'draft_id' is required"}), 400

    start_time = time.time()
    while time.time() - start_time < timeout:
        conn = sqlite3.connect('capcut.db')
        c = conn.cursor()
        c.execute("SELECT status, progress, message FROM drafts WHERE id = ?", (draft_id,))
        result = c.fetchone()
        conn.close()
        
        current_status = result[0] if result else None

        if current_status and current_status != last_status:
            return jsonify({
                "success": True,
                "draft_id": draft_id,
                "status": current_status,
                "progress": result[1],
                "message": result[2]
            })
        
        time.sleep(1) # 1秒轮询一次

    return jsonify({"success": True, "status": "timeout", "message": "No status change"})

# 操作系统检测API
@app.route('/api/os/info', methods=['GET'])
# 操作系统检测API
@app.route('/api/os/info', methods=['GET'])
def get_os_info():
    """获取操作系统信息和默认路径配置"""
    try:
        os_config = get_os_path_config()
        # 使用get_os_info()方法获取可序列化的字典数据
        os_info = os_config.get_os_info()
        return jsonify({
            'success': True,
            'data': os_info
        })
    except Exception as e:
        return jsonify({
            'success': False,
            'error': str(e)
        }), 500

# 草稿路径配置API
@app.route('/api/draft/path/config', methods=['POST'])
def update_draft_path_config():
    """更新草稿路径配置"""
    try:
        data = request.get_json()
        custom_path = data.get('custom_path', '')
        
        # 这里可以添加路径验证逻辑
        if custom_path and not os.path.exists(custom_path):
            return jsonify({
                'success': False,
                'error': '指定的路径不存在'
            }), 400
            
        return jsonify({
            'success': True,
            'message': '路径配置已更新',
            'custom_path': custom_path
        })
    except Exception as e:
        return jsonify({
            'success': False,
            'error': str(e)
        }), 500

# 草稿下载进度API
@app.route('/api/draft/download/progress/<task_id>', methods=['GET'])
def get_download_progress(task_id):
    """获取草稿下载进度"""
    try:
        # 这里应该从实际的下载任务管理器中获取进度
        # 目前返回模拟数据
        progress_data = {
            'task_id': task_id,
            'progress': 75,  # 0-100
            'status': 'downloading',  # downloading, completed, failed
            'message': '正在下载草稿文件...',
            'downloaded_size': '15.2MB',
            'total_size': '20.3MB'
        }
        
        return jsonify({
            'success': True,
            'data': progress_data
        })
    except Exception as e:
        return jsonify({
            'success': False,
            'error': str(e)
        }), 500

# 草稿预览页面
@app.route('/draft/preview/<draft_id>', methods=['GET'])
def enhanced_draft_preview(draft_id):
    """增强版草稿详细预览页面 - 三栏布局优化版"""
    import os
    from draft_cache import DRAFT_CACHE, get_draft, draft_exists
    
    try:
        # 首先检查草稿目录是否存在
        draft_dir = f"drafts/{draft_id}"
        if not os.path.exists(draft_dir):
            return """
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>草稿不存在</title>
    <style>
        body {{
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0;
            color: white;
        }}
        .error-container {{
            text-align: center;
            background: rgba(255, 255, 255, 0.1);
            padding: 40px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }}
    </style>
</head>
<body>
    <div class="error-container">
        <h1>草稿不存在</h1>
        <p>草稿 {0} 不存在</p>
        <a href="/api/drafts/dashboard" style="color: #fff; text-decoration: underline;">返回仪表板</a>
    </div>
</body>
</html>
""".format(draft_id)
        
        # 获取草稿的素材信息
        materials = get_draft_materials(draft_id)
        
        # 如果数据库中没有素材信息，但草稿目录存在，则创建空的素材列表
        if not materials:
            materials = []
        
        # 计算总时长
        total_duration = sum(material.get('end', 30) - material.get('start', 0) for material in materials)
        
        # 生成素材详情表格行
        material_rows = ""
        for i, material in enumerate(materials):
            material_type = material.get('type', 'unknown')
            video_url = material.get('url', '-')
            start_time = material.get('start', 0)
            end_time = material.get('end', 30)
            duration = end_time - start_time
            
            # 格式化时间显示
            start_formatted = "{:02d}:{:02d}".format(int(start_time//60), int(start_time%60))
            end_formatted = "{:02d}:{:02d}".format(int(end_time//60), int(end_time%60))
            duration_formatted = "{:02d}:{:02d}".format(int(duration//60), int(duration%60))
            
            material_rows += f"""
                <tr class="material-row" data-material-id="{i}" onclick="selectMaterial({i})">
                    <td><span class="type-badge type-{material_type}">{material_type.upper()}</span></td>
                    <td class="url-cell" title="{video_url}">{video_url[:50]}{'...' if len(video_url) > 50 else ''}</td>
                    <td>{start_formatted}</td>
                    <td>{end_formatted}</td>
                    <td>{duration_formatted}</td>
                </tr>
            """
        
        # 生成时间轴素材块
        timeline_blocks = ""
        for i, material in enumerate(materials):
            material_type = material.get('type', 'unknown')
            start_time = material.get('start', 0)
            end_time = material.get('end', 30)
            duration = end_time - start_time
            
            # 计算在时间轴上的位置（假设总时长为最大结束时间）
            max_time = max(material.get('end', 30) for material in materials)
            left_percent = (start_time / max_time) * 100 if max_time > 0 else 0
            width_percent = (duration / max_time) * 100 if max_time > 0 else 10
            
            timeline_blocks += f"""
                <div class="material-block material-{material_type}" 
                     data-material-id="{i}"
                     style="left: {left_percent}%; width: {width_percent}%;"
                     onclick="selectMaterial({i})"
                     title="{material_type.upper()}: {start_time}s - {end_time}s">
                    <span class="material-label">{material_type[:3].upper()}</span>
                </div>
            """
        
        # 生成时间刻度
        max_time = max(material.get('end', 30) for material in materials) if materials else 30
        time_marks = ""
        for i in range(0, int(max_time) + 5, 5):
            if i <= max_time:
                left_percent = (i / max_time) * 100 if max_time > 0 else 0
                minutes = int(i // 60)
                seconds = int(i % 60)
                time_marks += """
                    <div class="time-mark" style="left: {}%">
                        <div class="time-tick"></div>
                        <div class="time-label">{:02d}:{:02d}</div>
                    </div>
                """.format(left_percent, minutes, seconds)
        # 定义草稿目录路径
        draft_dir = "drafts/{}".format(draft_id)
        
        draft_files = []
        if os.path.exists(draft_dir):
            for file in os.listdir(draft_dir):
                file_path = os.path.join(draft_dir, file)
                if os.path.isfile(file_path):
                    file_size = os.path.getsize(file_path)
                    draft_files.append({
                        'name': file,
                        'size': "{:.2f} MB".format(file_size / 1024 / 1024) if file_size > 1024*1024 else "{:.2f} KB".format(file_size / 1024)
                    })
        
        # 生成素材列表HTML
        materials_html = ""
        if materials:
            for i, material in enumerate(materials):
                material_type = material.get('type', 'unknown')
                material_name = material.get('name', f'{material_type}_{i+1}')
                material_duration = material.get('duration', 0)
                
                # 根据素材类型设置图标
                type_icon = {
                    'video': '🎬',
                    'audio': '🎵', 
                    'text': '📝',
                    'image': '🖼️'
                }.get(material_type, '📄')
                
                # 确保material_duration是数字类型
                try:
                    duration_float = float(material_duration) if material_duration else 0.0
                except (ValueError, TypeError):
                    duration_float = 0.0
                
                materials_html += """
                    <div class="material-item {}" onclick="selectMaterial({})">
                        <div class="material-icon">{0}</div>
                        <div class="material-info">
                            <div class="material-name">{1}</div>
                            <div class="material-meta">{2:.1f}s</div>
                        </div>
                    </div>
                """.format(material_type, i, type_icon, material_name, duration_float)
        else:
            materials_html = '<div class="empty-state">暂无素材</div>'
        
        # 生成各类型时间轴项目HTML
        video_materials = [m for m in materials if m.get('type') == 'video']
        audio_materials = [m for m in materials if m.get('type') == 'audio']
        text_materials = [m for m in materials if m.get('type') == 'text']
        image_materials = [m for m in materials if m.get('type') == 'image']
        
        # 生成视频时间轴项目
        video_timeline_items = ""
        if video_materials:
            for material in video_materials:
                # 确保数值类型转换
                try:
                    start_time = float(material.get('start', 0))
                    duration = float(material.get('duration', 5))
                    max_time_float = float(max_time) if max_time else 1.0
                except (ValueError, TypeError):
                    start_time = 0.0
                    duration = 5.0
                    max_time_float = 1.0
                
                name = material.get('name', '视频')[:10]
                left_percent = (start_time / max_time_float) * 100 if max_time_float > 0 else 0
                width_percent = (duration / max_time_float) * 100 if max_time_float > 0 else 10
                
                video_timeline_items += """
                    <div class="timeline-item video" style="left: {}%; width: {}%;" title="{}">
                        {}
                    </div>
                """.format(left_percent, width_percent, material.get('name', '视频'), name)
        
        # 生成音频时间轴项目
        audio_timeline_items = ""
        if audio_materials:
            for material in audio_materials:
                # 确保数值类型转换
                try:
                    start_time = float(material.get('start', 0))
                    duration = float(material.get('duration', 5))
                    max_time_float = float(max_time) if max_time else 1.0
                except (ValueError, TypeError):
                    start_time = 0.0
                    duration = 5.0
                    max_time_float = 1.0
                
                name = material.get('name', '音频')[:10]
                left_percent = (start_time / max_time_float) * 100 if max_time_float > 0 else 0
                width_percent = (duration / max_time_float) * 100 if max_time_float > 0 else 10
                
                audio_timeline_items += """
                    <div class="timeline-item audio" style="left: {0}%; width: {1}%;" title="{2}">
                        {3}
                    </div>
                """.format(left_percent, width_percent, material.get('name', '音频'), name)
        
        # 生成文本时间轴项目
        text_timeline_items = ""
        if text_materials:
            for material in text_materials:
                # 确保数值类型转换
                try:
                    start_time = float(material.get('start', 0))
                    duration = float(material.get('duration', 5))
                    max_time_float = float(max_time) if max_time else 1.0
                except (ValueError, TypeError):
                    start_time = 0.0
                    duration = 5.0
                    max_time_float = 1.0
                
                name = material.get('name', '文本')[:10]
                left_percent = (start_time / max_time_float) * 100 if max_time_float > 0 else 0
                width_percent = (duration / max_time_float) * 100 if max_time_float > 0 else 10
                
                text_timeline_items += """
                    <div class="timeline-item text" style="left: {0}%; width: {1}%;" title="{2}">
                        {3}
                    </div>
                """.format(left_percent, width_percent, material.get('name', '文本'), name)
        
        # 生成图片时间轴项目
        image_timeline_items = ""
        if image_materials:
            for material in image_materials:
                # 确保数值类型转换
                try:
                    start_time = float(material.get('start', 0))
                    duration = float(material.get('duration', 5))
                    max_time_float = float(max_time) if max_time else 1.0
                except (ValueError, TypeError):
                    start_time = 0.0
                    duration = 5.0
                    max_time_float = 1.0
                
                name = material.get('name', '图片')[:10]
                left_percent = (start_time / max_time_float) * 100 if max_time_float > 0 else 0
                width_percent = (duration / max_time_float) * 100 if max_time_float > 0 else 10
                
                image_timeline_items += """
                    <div class="timeline-item image" style="left: {0}%; width: {1}%;" title="{2}">
                        {3}
                    </div>
                """.format(left_percent, width_percent, material.get('name', '图片'), name)
        
        # 计算总时长
        total_duration = max_time if max_time > 0 else 0
        
        # 将素材数据转换为JSON格式供JavaScript使用
        materials_json = json.dumps(materials, ensure_ascii=False)
        
        # 生成时间轴HTML
        timeline_html = generate_timeline_html(materials)
        
        # 获取草稿信息
        draft_info_path = os.path.join(draft_dir, 'draft_info.json')
        draft_info = {}
        if os.path.exists(draft_info_path):
            with open(draft_info_path, 'r', encoding='utf-8') as f:
                draft_info = json.load(f)
        
        # 返回草稿预览页面HTML
        html_content = """
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>草稿预览 - {}</title>
    <style>
        * {{
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }}
        
        body {{
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', sans-serif;
            background: #1a1a1a;
            color: #ffffff;
            overflow: hidden;
        }}
        
        .header {{
            background: #2a2a2a;
            padding: 12px 20px;
            border-bottom: 1px solid #3a3a3a;
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 60px;
        }}
        
        .header h1 {{
            font-size: 18px;
            font-weight: 500;
        }}
        
        .back-btn {{
            background: #4a4a4a;
            border: none;
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            text-decoration: none;
            font-size: 14px;
        }}
        
        .back-btn:hover {{
            background: #5a5a5a;
        }}
        
        .main-container {{
            display: flex;
            height: calc(100vh - 60px);
        }}
        
        .left-panel {{
            width: 300px;
            background: #2a2a2a;
            border-right: 1px solid #3a3a3a;
            overflow-y: auto;
        }}
        
        .center-panel {{
            flex: 1;
            background: #1a1a1a;
            display: flex;
            flex-direction: column;
        }}
        
        .right-panel {{
            width: 350px;
            background: #2a2a2a;
            border-left: 1px solid #3a3a3a;
            overflow-y: auto;
        }}
        
        .panel-header {{
            padding: 16px 20px;
            border-bottom: 1px solid #3a3a3a;
            font-size: 16px;
            font-weight: 500;
        }}
        
        .materials-list {{
            padding: 16px;
        }}
        
        .material-item {{
            display: flex;
            align-items: center;
            padding: 12px;
            margin-bottom: 8px;
            background: #3a3a3a;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.2s;
        }}
        
        .material-item:hover {{
            background: #4a4a4a;
        }}
        
        .material-item.selected {{
            background: #0066cc;
        }}
        
        .material-icon {{
            width: 40px;
            height: 40px;
            background: #5a5a5a;
            border-radius: 6px;
            margin-right: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }}
        
        .material-info {{
            flex: 1;
        }}
        
        .material-name {{
            font-size: 14px;
            margin-bottom: 4px;
        }}
        
        .material-type {{
            font-size: 12px;
            color: #999;
        }}
        
        .preview-area {{
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #0a0a0a;
            position: relative;
        }}
        
        .preview-placeholder {{
            text-align: center;
            color: #666;
        }}
        
        .timeline-container {{
            height: 200px;
            background: #2a2a2a;
            border-top: 1px solid #3a3a3a;
        }}
        
        .timeline-header {{
            padding: 12px 20px;
            border-bottom: 1px solid #3a3a3a;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }}
        
        .timeline-controls {{
            display: flex;
            gap: 8px;
        }}
        
        .timeline-btn {{
            background: #4a4a4a;
            border: none;
            color: white;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }}
        
        .timeline-btn:hover {{
            background: #5a5a5a;
        }}
        
        .timeline-content {{
            padding: 16px 20px;
            height: calc(100% - 60px);
            overflow-x: auto;
        }}
        
        .timeline-tracks {{
            display: flex;
            flex-direction: column;
            gap: 8px;
        }}
        
        .timeline-track {{
            height: 40px;
            background: #3a3a3a;
            border-radius: 6px;
            position: relative;
            display: flex;
            align-items: center;
            padding: 0 12px;
        }}
        
        .track-label {{
            width: 80px;
            font-size: 12px;
            color: #999;
        }}
        
        .track-content {{
            flex: 1;
            height: 100%;
            position: relative;
        }}
        
        .timeline-item {{
            position: absolute;
            height: 32px;
            background: #0066cc;
            border-radius: 4px;
            top: 4px;
            display: flex;
            align-items: center;
            padding: 0 8px;
            font-size: 11px;
            cursor: pointer;
        }}
        
        .timeline-item:hover {{
            background: #0077dd;
        }}
        
        .details-content {{
            padding: 20px;
        }}
        
        .details-section {{
            margin-bottom: 24px;
        }}
        
        .details-title {{
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 12px;
            color: #ccc;
        }}
        
        .details-item {{
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #3a3a3a;
        }}
        
        .details-label {{
            font-size: 13px;
            color: #999;
        }}
        
        .details-value {{
            font-size: 13px;
            color: #fff;
        }}
        
        .download-section {{
            padding: 20px;
            border-top: 1px solid #3a3a3a;
        }}
        
        .download-btn {{
            width: 100%;
            background: #0066cc;
            color: white;
            border: none;
            padding: 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            margin-bottom: 8px;
        }}
        
        .download-btn:hover {{
            background: #0077dd;
        }}
        
        .progress-container {{
            margin-top: 12px;
            display: none;
        }}
        
        .progress-bar {{
            width: 100%;
            height: 6px;
            background: #3a3a3a;
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 8px;
        }}
        
        .progress-fill {{
            height: 100%;
            background: #0066cc;
            width: 0%;
            transition: width 0.3s ease;
        }}
        
        .progress-text {{
            font-size: 12px;
            color: #999;
            text-align: center;
        }}
        
        .download-section {{
            background: #f8f9fa;
            padding: 25px;
            border-radius: 10px;
            text-align: center;
        }}
        
        .download-btn {{
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
            margin: 10px;
        }}
        
        .download-btn:hover {{
            transform: translateY(-2px);
        }}
        
        .progress-container {{
            margin-top: 20px;
            display: none;
        }}
        
        .progress-bar {{
            width: 100%;
            height: 20px;
            background: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 10px;
        }}
        
        .progress-fill {{
            height: 100%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            width: 0%;
            transition: width 0.3s ease;
        }}
        
        .progress-text {{
            font-size: 14px;
            color: #666;
        }}
        
        .back-btn {{
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
        }}
    </style>
</head>
<body>
    <div class="header">
        <h1>草稿预览 - {draft_id}</h1>
        <a href="/api/drafts/dashboard" class="back-btn">← 返回</a>
    </div>
    
    <div class="main-container">
        <!-- 左侧素材面板 -->
        <div class="left-panel">
            <div class="panel-header">素材列表</div>
            <div class="materials-list">
                {materials_html}
            </div>
        </div>
        
        <!-- 中央预览和时间轴面板 -->
        <div class="center-panel">
            <div class="preview-area">
                <div class="preview-placeholder">
                    <div style="font-size: 48px; margin-bottom: 16px;">🎬</div>
                    <div>选择素材查看预览</div>
                </div>
            </div>
            
            <div class="timeline-container">
                <div class="timeline-header">
                    <span>时间轴 (总时长: {total_duration:.1f}s)</span>
                    <div class="timeline-controls">
                        <button class="timeline-btn">播放</button>
                        <button class="timeline-btn">暂停</button>
                        <button class="timeline-btn">重置</button>
                    </div>
                </div>
                
                <div class="timeline-content">
                    <div class="timeline-tracks">
                        <!-- 视频轨道 -->
                        <div class="timeline-track">
                            <div class="track-label">视频</div>
                            <div class="track-content">
                                {video_timeline_items}
                            </div>
                        </div>
                        
                        <!-- 音频轨道 -->
                        <div class="timeline-track">
                            <div class="track-label">音频</div>
                            <div class="track-content">
                                {audio_timeline_items}
                            </div>
                        </div>
                        
                        <!-- 文本轨道 -->
                        <div class="timeline-track">
                            <div class="track-label">文本</div>
                            <div class="track-content">
                                {text_timeline_items}
                            </div>
                        </div>
                        
                        <!-- 图片轨道 -->
                        <div class="timeline-track">
                            <div class="track-label">图片</div>
                            <div class="track-content">
                                {image_timeline_items}
                            </div>
                        </div>
                    </div>
                    
                    <!-- 时间刻度 -->
                    <div class="timeline-ruler">
                        {time_marks_html}
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 右侧详情面板 -->
        <div class="right-panel">
            <div class="panel-header">素材详情</div>
            <div class="details-content" id="material-details">
                <div style="text-align: center; color: #666; padding: 40px 20px;">
                    <div style="font-size: 32px; margin-bottom: 12px;">📋</div>
                    <div>选择素材查看详情</div>
                </div>
            </div>
            
            <div class="download-section">
                <button class="download-btn" onclick="startDownload()">📥 下载草稿</button>
                <button class="download-btn" onclick="configPath()" style="background: #666;">⚙️ 配置路径</button>
                
                <div class="progress-container" id="progress-container">
                    <div class="progress-bar">
                        <div class="progress-fill" id="progress-fill"></div>
                    </div>
                    <div class="progress-text" id="progress-text">准备下载...</div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // 素材数据
        const materials = {materials_json};
        let selectedMaterialId = null;
        
        // 素材选择功能
        function selectMaterial(materialId) {{
            // 移除之前的选中状态
            document.querySelectorAll('.material-item.selected, .timeline-item.selected').forEach(el => {{
                el.classList.remove('selected');
            }});
            
            // 添加新的选中状态
            document.querySelectorAll(`[data-material-id="${{materialId}}"]`).forEach(el => {{
                el.classList.add('selected');
            }});
            
            selectedMaterialId = materialId;
            updateMaterialDetails(materialId);
        }}
        
        // 更新素材详情面板
        function updateMaterialDetails(materialId) {{
            const material = materials[materialId];
            if (!material) return;
            
            const detailsContainer = document.getElementById('material-details');
            const startTime = material.start || 0;
            const endTime = material.end || 30;
            const duration = endTime - startTime;
            
            detailsContainer.innerHTML = `
                <div class="details-section">
                    <div class="details-title">基本信息</div>
                    <div class="details-item">
                        <span class="details-label">类型</span>
                        <span class="details-value">${{material.type?.toUpperCase() || 'UNKNOWN'}}</span>
                    </div>
                    <div class="details-item">
                        <span class="details-label">开始时间</span>
                        <span class="details-value">${{Math.floor(startTime/60).toString().padStart(2,'0')}}:${{Math.floor(startTime%60).toString().padStart(2,'0')}}</span>
                    </div>
                    <div class="details-item">
                        <span class="details-label">结束时间</span>
                        <span class="details-value">${{Math.floor(endTime/60).toString().padStart(2,'0')}}:${{Math.floor(endTime%60).toString().padStart(2,'0')}}</span>
                    </div>
                    <div class="details-item">
                        <span class="details-label">时长</span>
                        <span class="details-value">${{Math.floor(duration/60).toString().padStart(2,'0')}}:${{Math.floor(duration%60).toString().padStart(2,'0')}}</span>
                    </div>
                </div>
                
                <div class="details-section">
                    <div class="details-title">文件信息</div>
                    <div class="details-item">
                        <span class="details-label">文件路径</span>
                        <span class="details-value" style="word-break: break-all; font-size: 11px;">${{material.url || '-'}}</span>
                    </div>
                </div>
            `;
        }}
        
        // 键盘快捷键
        document.addEventListener('keydown', function(e) {{
            if (e.key === 'Escape') {{
                // ESC键取消选择
                document.querySelectorAll('.material-item.selected, .timeline-item.selected').forEach(el => {{
                    el.classList.remove('selected');
                }});
                selectedMaterialId = null;
                document.getElementById('material-details').innerHTML = `
                    <div style="text-align: center; color: #666; padding: 40px 20px;">
                        <div style="font-size: 32px; margin-bottom: 12px;">📋</div>
                        <div>选择素材查看详情</div>
                    </div>
                `;
            }}
        }});
        
        // 下载功能
        function startDownload() {{
            const progressContainer = document.getElementById('progress-container');
            const progressFill = document.getElementById('progress-fill');
            const progressText = document.getElementById('progress-text');
            
            progressContainer.style.display = 'block';
            progressText.textContent = '开始下载...';
            
            // 模拟下载进度
            let progress = 0;
            const interval = setInterval(() => {{
                progress += Math.random() * 10;
                if (progress >= 100) {{
                    progress = 100;
                    clearInterval(interval);
                    progressText.textContent = '下载完成！';
                }} else {{
                    progressText.textContent = `下载中... ${{Math.round(progress)}}%`;
                }}
                progressFill.style.width = progress + '%';
            }}}}, 200);
            
            // 实际下载API调用
            const downloadTaskId = 'task_' + Date.now();
            fetch('/api/draft/download/progress/' + downloadTaskId)
                .then(response => response.json())
                .then(data => {{
                    console.log('下载任务状态:', data);
                }})
                .catch(error => {{
                    console.error('下载失败:', error);
                    progressText.textContent = '下载失败，请重试';
                }});
        }}
        
        // 配置下载路径
        function configPath() {{
            const newPath = prompt('请输入新的下载路径:', '/home/downloads');
            if (newPath) {{
                fetch('/api/draft/path/config', {{{{
                    method: 'POST',
                    headers: {{{{
                        'Content-Type': 'application/json'
                    }}}},
                    body: JSON.stringify({{{{
                        path: newPath
                    }}}})
                }})
                .then(response => response.json())
                .then(data => {{{{
                    if (data.success) {{{{
                        alert('路径配置成功！');
                    }}}} else {{{{
                        alert('路径配置失败: ' + data.message);
                    }}}}
                }}}})
                .catch(error => {{{{
                    console.error('配置失败:', error);
                    alert('配置失败，请重试');
                }}}});
            }}
        }}
                        <button class="timeline-btn">播放</button>
                        <button class="timeline-btn">暂停</button>
                        <button class="timeline-btn">重置</button>
                    </div>
                </div>
                <div class="timeline-content">
                    <div class="timeline-tracks">
                        {timeline_html}
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 右侧详情面板 -->
        <div class="right-panel">
            <div class="panel-header">素材详情</div>
            <div class="details-content" id="detailsContent">
                <div class="details-section">
                    <div class="details-title">草稿信息</div>
                    <div class="details-item">
                        <span class="details-label">草稿ID</span>
                        <span class="details-value">{draft_id}</span>
                    </div>
                    <div class="details-item">
                        <span class="details-label">素材数量</span>
                        <span class="details-value">{materials_count} 个</span>
                    </div>
                    <div class="details-item">
                        <span class="details-label">创建时间</span>
                        <span class="details-value">{create_time}</span>
                    </div>
                    <div class="details-item">
                        <span class="details-label">修改时间</span>
                        <span class="details-value">{update_time}</span>
                    </div>
                </div>
                
                <div class="details-section" id="materialDetails" style="display: none;">
                    <div class="details-title">选中素材</div>
                    <div id="materialDetailsContent">
                        <!-- 动态内容 -->
                    </div>
                </div>
            </div>
            
            <div class="download-section">
                <button class="download-btn" onclick="startDownload('{draft_id}')">
                    📦 下载草稿
                </button>
                <button class="download-btn" onclick="configPath()">
                    ⚙️ 配置路径
                </button>
                
                <div class="progress-container" id="progressContainer">
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                    <div class="progress-text" id="progressText">准备下载...</div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        let downloadTaskId = null;
        let selectedMaterial = null;
        
        // 素材选择功能
        function selectMaterial(materialId, materialData) {{{{
            // 移除之前的选中状态
            document.querySelectorAll('.material-item').forEach(item => {{{{
                item.classList.remove('selected');
            }}}});
            
            // 添加新的选中状态
            const selectedItem = document.querySelector(`[data-material-id="${{{{materialId}}}}"]`);
            if (selectedItem) {{{{
                selectedItem.classList.add('selected');
            }}}}
            
            selectedMaterial = materialData;
            updateMaterialDetails(materialData);
        }}
        
        // 更新素材详情面板
        function updateMaterialDetails(material) {{{{
            const detailsSection = document.getElementById('materialDetails');
            const detailsContent = document.getElementById('materialDetailsContent');

            if (!material) {{{{
                detailsSection.style.display = 'none';
                return;
            }}}}
            
            detailsSection.style.display = 'block';
            
            const detailsHtml = `
                <div class="details-item">
                    <span class="details-label">文件名</span>
                    <span class="details-value">${{material.name || '未知'}}</span>
                </div>
                <div class="details-item">
                    <span class="details-label">类型</span>
                    <span class="details-value">${{material.type || '未知'}}</span>
                </div>
                <div class="details-item">
                    <span class="details-label">大小</span>
                    <span class="details-value">${{material.size || '未知'}}</span>
                </div>
                <div class="details-item">
                    <span class="details-label">时长</span>
                    <span class="details-value">${{material.duration || '未知'}}</span>
                </div>
                <div class="details-item">
                    <span class="details-label">路径</span>
                    <span class="details-value" style="word-break: break-all;">${{material.path || '未知'}}</span>
                </div>
            `;
            
            detailsContent.innerHTML = detailsHtml;
        }}
        
        // 下载功能
        function startDownload(draftId) {{
            const progressContainer = document.getElementById('progressContainer');
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            
            // 显示进度条
            progressContainer.style.display = 'block';
            progressText.textContent = '正在准备下载...';
            
            // 生成任务ID
            downloadTaskId = 'download_' + Date.now();
            
            // 模拟下载进度
            let progress = 0;
            const interval = setInterval(() => {{
                progress += Math.random() * 10;
                if (progress > 100) progress = 100;
                
                progressFill.style.width = progress + '%';
                progressText.textContent = `下载进度: ${{progress.toFixed(1)}}%`;
                
                if (progress >= 100) {{
                    clearInterval(interval);
                    progressText.textContent = '下载完成！';
                    setTimeout(() => {{
                        progressContainer.style.display = 'none';
                        progressFill.style.width = '0%';
                    }}, 2000);
                }}
            }}, 200);
            
            // 实际的下载API调用
            fetch('/api/draft/download/progress/' + downloadTaskId)
                .then(response => response.json())
                .then(data => {{
                    console.log('下载状态:', data);
                }})
                .catch(error => {{
                    console.error('下载失败:', error);
                    progressText.textContent = '下载失败，请重试';
                }});
        }}
        
        // 配置路径功能
        function configPath() {{
            const newPath = prompt('请输入下载路径:', '/home');
            if (newPath) {{
                fetch('/api/draft/path/config', {{
                    method: 'POST',
                    headers: {{
                        'Content-Type': 'application/json'
                    }},
                    body: JSON.stringify({{
                        custom_path: newPath
                    }})
                }})
                .then(response => response.json())
                .then(data => {{
                    if (data.success) {{
                        alert('路径配置成功: ' + data.custom_path);
                    }} else {{
                        alert('路径配置失败: ' + data.error);
                    }}
                }})
                .catch(error => {{
                    alert('配置失败: ' + error.message);
                }});
            }}
        }}
        
        // 键盘快捷键
        document.addEventListener('keydown', function(e) {{{{
            if (e.key === 'Escape') {{{{
                // ESC键取消选择
                document.querySelectorAll('.material-item').forEach(item => {{{{
                    item.classList.remove('selected');
                }}}});
                selectedMaterial = null;
                updateMaterialDetails(null);
            }}}}
        }}}});
        
        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {{{{
            console.log('草稿预览页面已加载');
        }}}});
    </script>
</body>
</html>
        """.format(
            draft_id=draft_id,
            materials_html=materials_html,
            video_timeline_items=video_timeline_items,
            audio_timeline_items=audio_timeline_items,
            text_timeline_items=text_timeline_items,
            image_timeline_items=image_timeline_items,
            time_marks_html=time_marks,
            materials_json=materials_json,
            total_duration=total_duration,
            materials_count=len(materials),
            create_time=draft_info.get('create_time', '未知'),
            update_time=draft_info.get('update_time', '未知')
        )
        
        return html_content
        
    except Exception as e:
        return """
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>错误</title>
</head>
<body>
    <h1>加载草稿时出错</h1>
    <p>错误信息: {0}</p>
    <a href="/api/drafts/dashboard">返回仪表板</a>
</body>
</html>
        """.format(str(e))



# 草稿管理相关路由
@app.route('/api/drafts/dashboard', methods=['GET'])
def drafts_dashboard():
    """草稿管理仪表板页面"""
    try:
        from flask import render_template
        # 获取所有草稿信息
        drafts = get_all_drafts()
        
        # 统计信息
        total_drafts = len(drafts)
        total_materials = sum(len(get_draft_materials(draft['id'])) for draft in drafts)
        
        return render_template('dashboard.html', 
                             drafts=drafts,
                             total_drafts=total_drafts,
                             total_materials=total_materials)
    except Exception as e:
        return f"<h1>加载仪表板失败</h1><p>错误: {str(e)}</p>"

@app.route('/api/drafts/preview/<draft_id>', methods=['GET'])
def draft_preview(draft_id):
    """草稿预览页面"""
    try:
        from flask import render_template
        import os
        
        # 获取草稿信息
        draft_path = f"drafts/{draft_id}"
        if not os.path.exists(draft_path):
            return f"<h1>草稿不存在</h1><p>草稿ID: {draft_id}</p>"
        
        # 读取草稿信息
        draft_info_path = os.path.join(draft_path, 'draft_info.json')
        draft_info = {}
        if os.path.exists(draft_info_path):
            with open(draft_info_path, 'r', encoding='utf-8') as f:
                draft_info = json.load(f)
        
        # 获取素材信息
        materials = get_draft_materials(draft_id)
        
        # 生成时间轴HTML
        timeline_html = generate_timeline_html(materials)
        
        return render_template('preview.html',
                             draft_id=draft_id,
                             draft_info=draft_info,
                             materials=materials,
                             timeline_html=timeline_html)
    except Exception as e:
        return f"<h1>加载草稿预览失败</h1><p>错误: {str(e)}</p>"

@app.route('/api/draft/download/<draft_id>', methods=['POST'])
def download_draft(draft_id):
    """下载草稿"""
    try:
        import shutil
        import tempfile
        from flask import send_file
        
        # 检查草稿是否存在
        draft_path = f"drafts/{draft_id}"
        if not os.path.exists(draft_path):
            return jsonify({
                "success": False,
                "message": "草稿不存在"
            })
        
        # 创建临时zip文件
        temp_dir = tempfile.mkdtemp()
        zip_path = os.path.join(temp_dir, f"{draft_id}.zip")
        
        # 压缩草稿文件夹
        shutil.make_archive(zip_path[:-4], 'zip', draft_path)
        
        return send_file(zip_path, as_attachment=True, download_name=f"{draft_id}.zip")
        
    except Exception as e:
        return jsonify({
            "success": False,
            "message": f"下载失败: {str(e)}"
        })

@app.route('/api/draft/download/progress/<task_id>', methods=['GET'])
def download_progress(task_id):
    """获取下载进度"""
    # 这里可以实现真实的下载进度跟踪
    # 目前返回模拟数据
    return jsonify({
        "success": True,
        "task_id": task_id,
        "progress": 100,
        "status": "completed",
        "message": "下载完成"
    })

@app.route('/api/draft/path/config', methods=['POST'])
def config_download_path():
    """配置下载路径"""
    try:
        data = request.get_json()
        custom_path = data.get('custom_path', '/home')
        
        # 验证路径是否存在
        if not os.path.exists(custom_path):
            return jsonify({
                "success": False,
                "error": "路径不存在"
            })
        
        # 这里可以保存路径配置到数据库或配置文件
        return jsonify({
            "success": True,
            "custom_path": custom_path,
            "message": "路径配置成功"
        })
        
    except Exception as e:
        return jsonify({
            "success": False,
            "error": str(e)
        })

def generate_timeline_html(materials):
    """生成时间轴HTML"""
    if not materials:
        return '<div class="timeline-track"><div class="track-label">视频轨道</div></div>'
    
    # 按类型分组素材
    video_materials = [m for m in materials if m.get('type') == 'video']
    audio_materials = [m for m in materials if m.get('type') == 'audio']
    text_materials = [m for m in materials if m.get('type') == 'text']
    image_materials = [m for m in materials if m.get('type') == 'image']
    
    timeline_html = ''
    
    # 视频轨道
    if video_materials:
        timeline_html += '<div class="timeline-track">'
        timeline_html += '<div class="track-label">视频轨道</div>'
        timeline_html += '<div class="track-content">'
        for material in video_materials:
            timeline_html += f'<div class="timeline-item video" title="{material.get("name", "视频")}">{material.get("name", "视频")[:10]}</div>'
        timeline_html += '</div></div>'
    
    # 音频轨道
    if audio_materials:
        timeline_html += '<div class="timeline-track">'
        timeline_html += '<div class="track-label">音频轨道</div>'
        timeline_html += '<div class="track-content">'
        for material in audio_materials:
            timeline_html += '<div class="timeline-item audio" title="{}">{}></div>'.format(material.get("name", "音频"), material.get("name", "音频")[:10])
        timeline_html += '</div></div>'
    
    # 文本轨道
    if text_materials:
        timeline_html += '<div class="timeline-track">'
        timeline_html += '<div class="track-label">文本轨道</div>'
        timeline_html += '<div class="track-content">'
        for material in text_materials:
            timeline_html += '<div class="timeline-item text" title="{}">{}></div>'.format(material.get("name", "文本"), material.get("name", "文本")[:10])
        timeline_html += '</div></div>'
    
    # 图片轨道
    if image_materials:
        timeline_html += '<div class="timeline-track">'
        timeline_html += '<div class="track-label">图片轨道</div>'
        timeline_html += '<div class="track-content">'
        for material in image_materials:
            timeline_html += '<div class="timeline-item image" title="{}">{}></div>'.format(material.get("name", "图片"), material.get("name", "图片")[:10])
        timeline_html += '</div></div>'
    
    return timeline_html if timeline_html else '<div class="timeline-track"><div class="track-label">空轨道</div></div>'

@app.route('/download_draft/<draft_id>', methods=['GET'])
def download_draft_json(draft_id):
    """
    下载特定草稿的功能
    """
    try:
        # 获取草稿信息
        draft_info = get_draft_info(draft_id)
        if not draft_info:
            return jsonify({'success': False, 'error': '草稿不存在'}), 404
        
        # 返回草稿信息作为下载
        response = jsonify(draft_info)
        response.headers['Content-Disposition'] = f'attachment; filename={draft_id}.json'
        return response
    except Exception as e:
        return jsonify({'success': False, 'error': str(e)}), 500

if __name__ == '__main__':
    app.run(host='0.0.0.0', port=PORT)

