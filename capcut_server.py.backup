import requests
from flask import Flask, request, jsonify, Response
from datetime import datetime
import pyJianYingDraft as draft
from pyJianYingDraft.metadata.animation_meta import Intro_type, Outro_type, Group_animation_type
from pyJianYingDraft.metadata.capcut_animation_meta import CapCut_Intro_type, CapCut_Outro_type, CapCut_Group_animation_type
from pyJianYingDraft.metadata.transition_meta import Transition_type
from pyJianYingDraft.metadata.capcut_transition_meta import CapCut_Transition_type
from pyJianYingDraft.metadata.mask_meta import Mask_type
from pyJianYingDraft.metadata.capcut_mask_meta import CapCut_Mask_type
from pyJianYingDraft.metadata.audio_effect_meta import Tone_effect_type, Audio_scene_effect_type, Speech_to_song_type
from pyJianYingDraft.metadata.capcut_audio_effect_meta import CapCut_Voice_filters_effect_type, CapCut_Voice_characters_effect_type, CapCut_Speech_to_song_effect_type
from pyJianYingDraft.metadata.font_meta import Font_type
from pyJianYingDraft.metadata.animation_meta import Text_intro, Text_outro, Text_loop_anim
from pyJianYingDraft.metadata.capcut_text_animation_meta import CapCut_Text_intro, CapCut_Text_outro, CapCut_Text_loop_anim
from pyJianYingDraft.metadata.video_effect_meta import Video_scene_effect_type, Video_character_effect_type
from pyJianYingDraft.metadata.capcut_effect_meta import CapCut_Video_scene_effect_type, CapCut_Video_character_effect_type
import random
import uuid
import json
import codecs
from add_audio_track import add_audio_track
from add_video_track import add_video_track
from add_text_impl import add_text_impl
from add_subtitle_impl import add_subtitle_impl
from add_image_impl import add_image_impl
from add_video_keyframe_impl import add_video_keyframe_impl
from save_draft_impl import save_draft_impl, query_task_status, query_script_impl
from add_effect_impl import add_effect_impl
from add_sticker_impl import add_sticker_impl
from create_draft import create_draft, get_or_create_draft
from util import generate_draft_url as utilgenerate_draft_url, hex_to_rgb, normalize_path_by_os
from pyJianYingDraft.text_segment import TextStyleRange, Text_style, Text_border
from urllib.parse import quote

from settings.local import IS_CAPCUT_ENV, DRAFT_DOMAIN, PREVIEW_ROUTER, PORT, IS_UPLOAD_DRAFT
from oss import get_signed_draft_url_if_exists
from customize_zip import get_customized_signed_url

# OSS mirror support
import uuid as _uuid
import oss2 as _oss2
from settings.local import OSS_CONFIG as _OSS_CONFIG

def _ensure_bucket_v4():
    auth = _oss2.AuthV4(_OSS_CONFIG['access_key_id'], _OSS_CONFIG['access_key_secret'])
    endpoint = _OSS_CONFIG['endpoint']
    if not str(endpoint).startswith('http'):
        endpoint = 'https://' + endpoint
    return _oss2.Bucket(auth, endpoint, _OSS_CONFIG['bucket_name'], region=_OSS_CONFIG['region'])

app = Flask(__name__)

# å…¨å±€è‰ç¨¿ç´ æä¿¡æ¯ç¼“å­˜
draft_materials_cache = {}

def add_material_to_cache(draft_id, material_info):
    """æ·»åŠ ç´ æä¿¡æ¯åˆ°ç¼“å­˜"""
    if draft_id not in draft_materials_cache:
        draft_materials_cache[draft_id] = []
    draft_materials_cache[draft_id].append(material_info)

def get_draft_materials(draft_id):
    """è·å–è‰ç¨¿çš„ç´ æåˆ—è¡¨"""
    # å…ˆä»ç¼“å­˜ä¸­è·å–
    cached_materials = draft_materials_cache.get(draft_id, [])
    if cached_materials:
        return cached_materials
    
    # å¦‚æœç¼“å­˜ä¸­æ²¡æœ‰ï¼Œå°è¯•ä»ç£ç›˜è¯»å–
    try:
        import os
        import json
        
        # æ£€æŸ¥è‰ç¨¿ç›®å½•æ˜¯å¦å­˜åœ¨
        draft_dir = f"/home/CapCutAPI-1.1.0/{draft_id}"
        if os.path.exists(draft_dir):
            # æ„é€ é»˜è®¤çš„ç´ æä¿¡æ¯
            materials = []
            
            # æŸ¥æ‰¾è§†é¢‘æ–‡ä»¶
            for file in os.listdir(draft_dir):
                if file.endswith(('.mp4', '.mov', '.avi')):
                    materials.append({
                        'type': 'video',
                        'url': f'{draft_dir}/{file}',
                        'start': 0,
                        'end': 30,
                        'materialType': 'video',
                        'material_type': 'video'
                    })
                elif file.endswith(('.jpg', '.jpeg', '.png', '.gif')):
                    materials.append({
                        'type': 'image', 
                        'url': f'{draft_dir}/{file}',
                        'start': 0,
                        'end': 5,
                        'materialType': 'image',
                        'material_type': 'image'
                    })
                elif file.endswith(('.mp3', '.wav', '.aac')):
                    materials.append({
                        'type': 'audio',
                        'url': f'{draft_dir}/{file}',
                        'start': 0,
                        'end': 30,
                        'materialType': 'audio',
                        'material_type': 'audio'
                    })
            
            # å¦‚æœæ²¡æœ‰è¶³å¤Ÿçš„ç´ æï¼Œä¸ºé¢„è§ˆé¡µé¢æ·»åŠ æ¼”ç¤ºç´ æ
            has_video = any(m['type'] == 'video' for m in materials)
            has_audio = any(m['type'] == 'audio' for m in materials) 
            has_text = any(m['type'] == 'text' for m in materials)
            
            # æ·»åŠ ä¸»è§†é¢‘è½¨é“ç´ æ
            if not has_video:
                materials.append({
                    'type': 'video',
                    'url': 'https://example.com/main_video.mp4',
                    'start': 0,
                    'end': 30,
                    'materialType': 'video',
                    'material_type': 'video',
                    'track_name': 'video_main'
                })
            
            # æ·»åŠ è¯­éŸ³æ—ç™½ç´ æ
            if not has_audio:
                materials.append({
                    'type': 'audio',
                    'url': 'https://example.com/voice_narration.mp3',
                    'start': 0,
                    'end': 30,
                    'materialType': 'audio',
                    'material_type': 'audio',
                    'track_name': 'audio_main'
                })
                
            # æ·»åŠ èƒŒæ™¯éŸ³ä¹ç´ æ
            materials.append({
                'type': 'audio',
                'url': 'https://example.com/background_music.mp3',
                'start': 0,
                'end': 30,
                'materialType': 'audio', 
                'material_type': 'audio',
                'track_name': 'bgm_main'
            })
            
            # æ·»åŠ æ–‡æœ¬ç´ æ
            if not has_text:
                materials.append({
                    'type': 'text',
                    'content': 'AIç”Ÿæˆçš„æ ‡é¢˜å†…å®¹',
                    'start': 0,
                    'end': 5,
                    'materialType': 'text',
                    'material_type': 'text',
                    'track_name': 'text_main'
                })
            
            # å¦‚æœè¿˜æ˜¯æ²¡æœ‰ä»»ä½•ç´ æï¼Œæ·»åŠ é»˜è®¤æ–‡æœ¬
            if not materials:
                materials.append({
                    'type': 'text',
                    'content': f'è‰ç¨¿ {draft_id}',
                    'start': 0,
                    'end': 5,
                    'materialType': 'text',
                    'material_type': 'text'
                })
            
            # æ›´æ–°ç¼“å­˜
            draft_materials_cache[draft_id] = materials
            return materials
            
    except Exception as e:
        print(f"è¯»å–è‰ç¨¿ {draft_id} å¤±è´¥: {e}")
    
    # å¦‚æœéƒ½å¤±è´¥äº†ï¼Œè¿”å›ç©ºåˆ—è¡¨
    return []

@app.route('/', methods=['GET'])
def index():
    """æ ¹è·¯å¾„å¤„ç†å™¨ï¼Œæ˜¾ç¤ºAPIæœåŠ¡ä¿¡æ¯"""
    # æ£€æŸ¥è¯·æ±‚å¤´ï¼Œå¦‚æœæ˜¯APIè°ƒç”¨åˆ™è¿”å›JSON
    if request.headers.get('Accept') == 'application/json':
        return jsonify({
            "success": True,
            "message": "CapCutAPI æœåŠ¡è¿è¡Œæ­£å¸¸",
            "version": "1.1.0",
            "server": "http://8.148.70.18:9000",
            "available_endpoints": [
                "GET / - æœåŠ¡ä¿¡æ¯",
                "GET /get_intro_animation_types - è·å–å…¥åœºåŠ¨ç”»ç±»å‹",
                "GET /get_outro_animation_types - è·å–å‡ºåœºåŠ¨ç”»ç±»å‹", 
                "GET /get_transition_types - è·å–è½¬åœºç±»å‹",
                "GET /get_mask_types - è·å–é®ç½©ç±»å‹",
                "GET /get_font_types - è·å–å­—ä½“ç±»å‹",
                "POST /create_draft - åˆ›å»ºè‰ç¨¿",
                "POST /add_video - æ·»åŠ è§†é¢‘",
                "POST /add_audio - æ·»åŠ éŸ³é¢‘",
                "POST /add_text - æ·»åŠ æ–‡æœ¬",
                "POST /add_subtitle - æ·»åŠ å­—å¹•",
                "POST /add_image - æ·»åŠ å›¾ç‰‡",
                "POST /add_effect - æ·»åŠ ç‰¹æ•ˆ",
                "POST /add_sticker - æ·»åŠ è´´çº¸",
                "POST /save_draft - ä¿å­˜è‰ç¨¿"
            ],
            "documentation": "æŸ¥çœ‹ API_USAGE_EXAMPLES.md è·å–è¯¦ç»†ä½¿ç”¨è¯´æ˜"
        })
    
    # è¿”å›HTMLæ¬¢è¿é¡µé¢
    html_content = """
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CapCutAPI æœåŠ¡</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            padding: 40px;
            max-width: 800px;
            width: 90%;
            text-align: center;
        }
        .logo {
            font-size: 3em;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 20px;
        }
        .status {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            font-size: 1.1em;
        }
        .endpoints {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            text-align: left;
        }
        .endpoint {
            margin: 8px 0;
            padding: 8px;
            background: white;
            border-radius: 5px;
            border-left: 4px solid #667eea;
        }
        .method {
            font-weight: bold;
            color: #667eea;
        }
        .url {
            color: #495057;
            font-family: monospace;
        }
        .description {
            color: #6c757d;
            font-size: 0.9em;
        }
        .info {
            background: #e7f3ff;
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
        }
        .test-button {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1em;
            margin: 10px;
            transition: background 0.3s;
        }
        .test-button:hover {
            background: #5a6fd8;
        }
        .footer {
            margin-top: 30px;
            color: #6c757d;
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="logo">ğŸ¬ CapCutAPI</div>
        <div class="status">âœ… æœåŠ¡è¿è¡Œæ­£å¸¸</div>
        
        <div class="info">
            <h3>æœåŠ¡å™¨ä¿¡æ¯</h3>
            <p><strong>åœ°å€:</strong> http://8.148.70.18:9000</p>
            <p><strong>ç‰ˆæœ¬:</strong> 1.1.0</p>
            <p><strong>çŠ¶æ€:</strong> åœ¨çº¿</p>
        </div>
        
        <div class="endpoints">
            <h3>å¯ç”¨çš„APIç«¯ç‚¹</h3>
            <div class="endpoint">
                <span class="method">GET</span> <span class="url">/get_intro_animation_types</span>
                <div class="description">è·å–å…¥åœºåŠ¨ç”»ç±»å‹</div>
            </div>
            <div class="endpoint">
                <span class="method">GET</span> <span class="url">/get_outro_animation_types</span>
                <div class="description">è·å–å‡ºåœºåŠ¨ç”»ç±»å‹</div>
            </div>
            <div class="endpoint">
                <span class="method">GET</span> <span class="url">/get_transition_types</span>
                <div class="description">è·å–è½¬åœºç±»å‹</div>
            </div>
            <div class="endpoint">
                <span class="method">GET</span> <span class="url">/get_mask_types</span>
                <div class="description">è·å–é®ç½©ç±»å‹</div>
            </div>
            <div class="endpoint">
                <span class="method">GET</span> <span class="url">/get_font_types</span>
                <div class="description">è·å–å­—ä½“ç±»å‹</div>
            </div>
            <div class="endpoint">
                <span class="method">POST</span> <span class="url">/create_draft</span>
                <div class="description">åˆ›å»ºè‰ç¨¿</div>
            </div>
            <div class="endpoint">
                <span class="method">POST</span> <span class="url">/add_video</span>
                <div class="description">æ·»åŠ è§†é¢‘</div>
            </div>
            <div class="endpoint">
                <span class="method">POST</span> <span class="url">/add_text</span>
                <div class="description">æ·»åŠ æ–‡æœ¬</div>
            </div>
            <div class="endpoint">
                <span class="method">POST</span> <span class="url">/add_subtitle</span>
                <div class="description">æ·»åŠ å­—å¹•</div>
            </div>
            <div class="endpoint">
                <span class="method">POST</span> <span class="url">/save_draft</span>
                <div class="description">ä¿å­˜è‰ç¨¿</div>
            </div>
        </div>
        
        <div>
            <button class="test-button" onclick="testAPI()">æµ‹è¯•API</button>
            <button class="test-button" onclick="showJSON()">æ˜¾ç¤ºJSON</button>
        </div>
        
        <div class="footer">
            <p>ğŸ“– è¯¦ç»†ä½¿ç”¨è¯´æ˜è¯·æŸ¥çœ‹ API_USAGE_EXAMPLES.md</p>
            <p>ğŸ”§ æœåŠ¡ç®¡ç†è¯·ä½¿ç”¨ ./service_manager.sh</p>
        </div>
    </div>
    
    <script>
        function testAPI() {
            fetch('/get_intro_animation_types')
                .then(response => response.json())
                .then(data => {
                    alert('APIæµ‹è¯•æˆåŠŸï¼\nè·å–åˆ° ' + data.output.length + ' ä¸ªåŠ¨ç”»ç±»å‹');
                })
                .catch(error => {
                    alert('APIæµ‹è¯•å¤±è´¥ï¼š' + error);
                });
        }
        
        function showJSON() {
            fetch('/')
                .then(response => response.json())
                .then(data => {
                    alert(JSON.stringify(data, null, 2));
                })
                .catch(error => {
                    alert('è·å–JSONå¤±è´¥ï¼š' + error);
                });
        }
    </script>
</body>
</html>
    """
    return html_content

@app.route('/add_video', methods=['POST'])
def add_video():
    data = request.get_json()
    # Get required parameters
    draft_folder = data.get('draft_folder')
    video_url = data.get('video_url')
    
    # Guard: reject unresolved placeholders toé¿å…ç”Ÿæˆåè‰ç¨¿
    if isinstance(video_url, str) and ('{{' in video_url or '}}' in video_url):
        return jsonify({"success": False, "error": "video_url æ˜¯å ä½ç¬¦ï¼Œæœªæ›¿æ¢ä¸ºçœŸå®åœ°å€ã€‚è¯·åœ¨è°ƒç”¨å‰å…ˆç”Ÿæˆå®é™…URLã€‚", "hint": video_url})
    start = data.get('start', 0)
    end = data.get('end', 0)
    width = data.get('width', 1080)
    height = data.get('height', 1920)
    draft_id = data.get('draft_id')
    transform_y = data.get('transform_y', 0)
    scale_x = data.get('scale_x', 1)
    scale_y = data.get('scale_y', 1)
    transform_x = data.get('transform_x', 0)
    speed = data.get('speed', 1.0)  # New speed parameter
    target_start = data.get('target_start', 0)  # New target start time parameter
    track_name = data.get('track_name', "video_main")  # New track name parameter
    relative_index = data.get('relative_index', 0)  # New relative index parameter
    duration = data.get('duration')  # New duration parameter
    transition = data.get('transition')  # New transition type parameter
    transition_duration = data.get('transition_duration', 0.5)  # New transition duration parameter, default 0.5 seconds
    volume = data.get('volume', 1.0)  # New volume parameter, default 1.0 
    
    # Get mask related parameters
    mask_type = data.get('mask_type')  # Mask type
    mask_center_x = data.get('mask_center_x', 0.5)  # Mask center X coordinate
    mask_center_y = data.get('mask_center_y', 0.5)  # Mask center Y coordinate
    mask_size = data.get('mask_size', 1.0)  # Mask size, relative to screen height
    mask_rotation = data.get('mask_rotation', 0.0)  # Mask rotation angle
    mask_feather = data.get('mask_feather', 0.0)  # Mask feather degree
    mask_invert = data.get('mask_invert', False)  # Whether to invert mask
    mask_rect_width = data.get('mask_rect_width')  # Rectangle mask width
    mask_round_corner = data.get('mask_round_corner')  # Rectangle mask rounded corner

    background_blur = data.get('background_blur')  # Background blur level, optional values: 1 (light), 2 (medium), 3 (strong), 4 (maximum), default None (no background blur)

    result = {
        "success": False,
        "output": "",
        "error": ""
    }

    # Validate required parameters
    if not video_url:
        error_message = "Hi, the required parameters 'video_url' are missing."
        result["error"] = error_message
        return jsonify(result)

    try:
        draft_result = add_video_track(
            draft_folder=draft_folder,
            video_url=video_url,
            width=width,
            height=height,
            start=start,
            end=end,
            target_start=target_start,
            draft_id=draft_id,
            transform_y=transform_y,
            scale_x=scale_x,
            scale_y=scale_y,
            transform_x=transform_x,
            speed=speed,
            track_name=track_name,
            relative_index=relative_index,
            duration=duration,
            transition=transition,  # Pass transition type parameter
            transition_duration=transition_duration,  # Pass transition duration parameter
            volume=volume,  # Pass volume parameter
            # Pass mask related parameters
            mask_type=mask_type,
            mask_center_x=mask_center_x,
            mask_center_y=mask_center_y,
            mask_size=mask_size,
            mask_rotation=mask_rotation,
            mask_feather=mask_feather,
            mask_invert=mask_invert,
            mask_rect_width=mask_rect_width,
            mask_round_corner=mask_round_corner,
            background_blur=background_blur
        )
        
        result["success"] = True
        result["output"] = draft_result
        
        # è®°å½•ç´ æä¿¡æ¯åˆ°ç¼“å­˜
        material_info = {
            "type": "video",
            "url": video_url,
            "start": start,
            "end": end,
            "duration": end - start if end > start else None,
            "track_name": track_name,
            "added_at": datetime.now().isoformat()
        }
        add_material_to_cache(draft_id, material_info)
        
        return jsonify(result)

    except Exception as e:
        error_message = f"Error occurred while processing video: {str(e)}."
        result["error"] = error_message
        return jsonify(result)

@app.route('/add_audio', methods=['POST'])
def add_audio():
    data = request.get_json()
    
    # Get required parameters
    draft_folder = data.get('draft_folder')
    audio_url = data.get('audio_url')
    
    # Guard: reject unresolved placeholders
    if isinstance(audio_url, str) and ('{{' in audio_url or '}}' in audio_url):
        return jsonify({"success": False, "error": "audio_url æ˜¯å ä½ç¬¦ï¼Œæœªæ›¿æ¢ä¸ºçœŸå®åœ°å€ã€‚è¯·åœ¨è°ƒç”¨å‰å…ˆç”Ÿæˆå®é™…URLã€‚", "hint": audio_url})
    start = data.get('start', 0)
    end = data.get('end', None)
    draft_id = data.get('draft_id')
    volume = data.get('volume', 1.0)  # Default volume 1.0
    target_start = data.get('target_start', 0)  # New target start time parameter
    speed = data.get('speed', 1.0)  # New speed parameter
    track_name = data.get('track_name', 'audio_main')  # New track name parameter
    duration = data.get('duration', None)  # New duration parameter
    # Get audio effect parameters separately
    effect_type = data.get('effect_type', None)  # Audio effect type name
    effect_params = data.get('effect_params', None)  # Audio effect parameter list
    width = data.get('width', 1080)
    height = data.get('height', 1920)
    
    # # If there are audio effect parameters, combine them into sound_effects format
    sound_effects = None
    if effect_type is not None:
        sound_effects = [(effect_type, effect_params)]

    result = {
        "success": False,
        "output": "",
        "error": ""
    }

    # Validate required parameters
    if not audio_url:
        error_message = "Hi, the required parameters 'audio_url' are missing."
        result["error"] = error_message
        return jsonify(result)

    try:
        # Call the modified add_audio_track method
        draft_result = add_audio_track(
            draft_folder=draft_folder,
            audio_url=audio_url,
            start=start,
            end=end,
            target_start=target_start,
            draft_id=draft_id,
            volume=volume,
            track_name=track_name,
            speed=speed,
            sound_effects=sound_effects,  # Add audio effect parameters
            width=width,
            height=height,
            duration=duration  # Add duration parameter
        )
        
        result["success"] = True
        result["output"] = draft_result
        
        # è®°å½•ç´ æä¿¡æ¯åˆ°ç¼“å­˜
        material_info = {
            "type": "audio",
            "url": audio_url,
            "start": start,
            "end": end,
            "duration": end - start if end and end > start else None,
            "track_name": track_name,
            "volume": volume,
            "added_at": datetime.now().isoformat()
        }
        add_material_to_cache(draft_id, material_info)
        
        return jsonify(result)

    except Exception as e:
        error_message = f"Error occurred while processing audio: {str(e)}."
        result["error"] = error_message
        return jsonify(result)

@app.route('/create_draft', methods=['POST'])
def create_draft_service():
    data = request.get_json()
    
    # Get parameters
    draft_id = data.get('draft_id')  # User specified draft ID
    width = data.get('width', 1080)
    height = data.get('height', 1920)
    
    result = {
        "success": False,
        "output": "",
        "error": ""
    }
    
    try:
        # Create new draft with user specified ID or generate one
        draft_id, script = get_or_create_draft(draft_id=draft_id, width=width, height=height)
        
        result["success"] = True
        result["output"] = {
            "draft_id": draft_id,
            "draft_url": utilgenerate_draft_url(draft_id)
        }
        result["error"] = ""
        return jsonify(result)
        
    except Exception as e:
        error_message = f"Error occurred while creating draft: {str(e)}."
        result["error"] = error_message
        return jsonify(result)
        
@app.route('/add_subtitle', methods=['POST'])
def add_subtitle():
    data = request.get_json()
    
    # Get required parameters
    srt = data.get('srt')  # Subtitle content or URL
    draft_id = data.get('draft_id')
    time_offset = data.get('time_offset', 0.0)  # Default 0 seconds
    
    # Font style parameters
    font = data.get('font', None)
    font_size = data.get('font_size', 5.0)  # Default size 5.0
    bold = data.get('bold', False)  # Default not bold
    italic = data.get('italic', False)  # Default not italic
    underline = data.get('underline', False)  # Default no underline
    font_color = data.get('font_color', '#FFFFFF')  # Default white
    vertical = data.get('vertical', False)  # New: whether to display vertically, default False
    alpha = data.get('alpha', 1)  # New: transparency, default 1
    # Border parameters
    border_alpha = data.get('border_alpha', 1.0)
    border_color = data.get('border_color', '#000000')
    border_width = data.get('border_width', 0.0)
    
    # Background parameters
    background_color = data.get('background_color', '#000000')
    background_style = data.get('background_style', 0)
    background_alpha = data.get('background_alpha', 0.0)
        
    # Image adjustment parameters
    transform_x = data.get('transform_x', 0.0)  # Default 0
    transform_y = data.get('transform_y', -0.8)  # Default -0.8
    scale_x = data.get('scale_x', 1.0)  # Default 1.0
    scale_y = data.get('scale_y', 1.0)  # Default 1.0
    rotation = data.get('rotation', 0.0)  # Default 0.0
    track_name = data.get('track_name', 'subtitle')  # Default track name is 'subtitle'
    width = data.get('width', 1080)
    height = data.get('height', 1920)

    result = {
        "success": False,
        "output": "",
        "error": ""
    }

    # Validate required parameters
    if not srt:
        error_message = "Hi, the required parameters 'srt' are missing."
        result["error"] = error_message
        return jsonify(result)

    try:
        # Call add_subtitle_impl method
        draft_result = add_subtitle_impl(
            srt_path=srt,
            draft_id=draft_id,
            track_name=track_name,
            time_offset=time_offset,
            # Font style parameters
            font = font,
            font_size=font_size,
            bold=bold,
            italic=italic,
            underline=underline,
            font_color=font_color,
            vertical=vertical,  # New: pass vertical parameter
            alpha=alpha,  # New: pass alpha parameter
            border_alpha=border_alpha,
            border_color=border_color,
            border_width=border_width,
            background_color=background_color,
            background_style=background_style,
            background_alpha=background_alpha,
            # Image adjustment parameters
            transform_x=transform_x,
            transform_y=transform_y,
            scale_x=scale_x,
            scale_y=scale_y,
            rotation=rotation,
            width=width,
            height=height
        )
        
        result["success"] = True
        result["output"] = draft_result
        return jsonify(result)

    except Exception as e:
        error_message = f"Error occurred while processing subtitle: {str(e)}."
        result["error"] = error_message
        return jsonify(result)

@app.route('/add_text', methods=['POST'])
def add_text():
    data = request.get_json()
    
    # Get required parameters
    text = data.get('text')
    start = data.get('start', 0)
    end = data.get('end', 5)
    draft_id = data.get('draft_id')
    transform_y = data.get('transform_y', 0)
    transform_x = data.get('transform_x', 0)
    font = data.get('font', "æ–‡è½©ä½“")
    font_color = data.get('color', data.get('font_color', "#FF0000"))  # Support both 'color' and 'font_color'
    font_size = data.get('size', data.get('font_size', 8.0))  # Support both 'size' and 'font_size'
    track_name = data.get('track_name', "text_main")
    vertical = data.get('vertical', False)
    font_alpha = data.get('alpha', data.get('font_alpha', 1.0))  # Support both 'alpha' and 'font_alpha'  
    outro_animation = data.get('outro_animation', None)
    outro_duration = data.get('outro_duration', 0.5)
    width = data.get('width', 1080)
    height = data.get('height', 1920)
    
    # New fixed width and height parameters 
    fixed_width = data.get('fixed_width', -1)
    fixed_height = data.get('fixed_height', -1)
    
    # Border parameters
    border_alpha = data.get('border_alpha', 1.0)
    border_color = data.get('border_color', "#000000")
    border_width = data.get('border_width', 0.0)
    
    # Background parameters
    background_color = data.get('background_color', "#000000")
    background_style = data.get('background_style', 0)
    background_alpha = data.get('background_alpha', 0.0)
    background_round_radius = data.get('background_round_radius', 0.0)
    background_height = data.get('background_height', 0.14)  # Background height, range 0.0-1.0
    background_width = data.get('background_width', 0.14)  # Background width, range 0.0-1.0
    background_horizontal_offset = data.get('background_horizontal_offset', 0.5)  # Background horizontal offset, range 0.0-1.0
    background_vertical_offset = data.get('background_vertical_offset', 0.5)  # Background vertical offset, range 0.0-1.0

    # Shadow parameters
    shadow_enabled = data.get('shadow_enabled', False)  # Whether to enable shadow
    shadow_alpha = data.get('shadow_alpha', 0.9)  # Shadow transparency, range 0.0-1.0
    shadow_angle = data.get('shadow_angle', -45.0)  # Shadow angle, range -180.0-180.0
    shadow_color = data.get('shadow_color', "#000000")  # Shadow color
    shadow_distance = data.get('shadow_distance', 5.0)  # Shadow distance
    shadow_smoothing = data.get('shadow_smoothing', 0.15)  # Shadow smoothing, range 0.0-1.0
    
    # Bubble and decorative text effects
    bubble_effect_id = data.get('bubble_effect_id')
    bubble_resource_id = data.get('bubble_resource_id')
    effect_effect_id = data.get('effect_effect_id')
    
    # Entrance animation
    intro_animation = data.get('intro_animation')
    intro_duration = data.get('intro_duration', 0.5)
    
    # Exit animation
    outro_animation = data.get('outro_animation')
    outro_duration = data.get('outro_duration', 0.5)

    # Multi-style text parameters
    text_styles_data = data.get('text_styles', [])
    text_styles = None
    if text_styles_data:
        text_styles = []
        for style_data in text_styles_data:
            # Get style range
            start_pos = style_data.get('start', 0)
            end_pos = style_data.get('end', 0)
            
            # Create text style
            style = Text_style(
                size=style_data.get('style',{}).get('size', font_size),
                bold=style_data.get('style',{}).get('bold', False),
                italic=style_data.get('style',{}).get('italic', False),
                underline=style_data.get('style',{}).get('underline', False),
                color=hex_to_rgb(style_data.get('style',{}).get('color', font_color)),
                alpha=style_data.get('style',{}).get('alpha', font_alpha),
                align=style_data.get('style',{}).get('align', 1),
                vertical=style_data.get('style',{}).get('vertical', vertical),
                letter_spacing=style_data.get('style',{}).get('letter_spacing', 0),
                line_spacing=style_data.get('style',{}).get('line_spacing', 0)
            )
            
            # Create border (if any)
            border = None
            if style_data.get('border',{}).get('width', 0) > 0:
                border = Text_border(
                    alpha=style_data.get('border',{}).get('alpha', border_alpha),
                    color=hex_to_rgb(style_data.get('border',{}).get('color', border_color)),
                    width=style_data.get('border',{}).get('width', border_width)
                )
            
            # Create style range object
            style_range = TextStyleRange(
                start=start_pos,
                end=end_pos,
                style=style,
                border=border,
                font_str=style_data.get('font', font)
            )
            
            text_styles.append(style_range)

    result = {
        "success": False,
        "output": "",
        "error": ""
    }

    # Validate required parameters
    if not text or start is None or end is None:
        error_message = "Hi, the required parameters 'text', 'start' or 'end' are missing. "
        result["error"] = error_message
        return jsonify(result)

    try:
        
        # Call add_text_impl method
        draft_result = add_text_impl(
            text=text,
            start=start,
            end=end,
            draft_id=draft_id,
            transform_y=transform_y,
            transform_x=transform_x,
            font=font,
            font_color=font_color,
            font_size=font_size,
            track_name=track_name,
            vertical=vertical,
            font_alpha=font_alpha,
            border_alpha=border_alpha,
            border_color=border_color,
            border_width=border_width,
            background_color=background_color,
            background_style=background_style,
            background_alpha=background_alpha,
            background_round_radius=background_round_radius,
            background_height=background_height,
            background_width=background_width,
            background_horizontal_offset=background_horizontal_offset,
            background_vertical_offset=background_vertical_offset,
            shadow_enabled=shadow_enabled,
            shadow_alpha=shadow_alpha,
            shadow_angle=shadow_angle,
            shadow_color=shadow_color,
            shadow_distance=shadow_distance,
            shadow_smoothing=shadow_smoothing,
            bubble_effect_id=bubble_effect_id,
            bubble_resource_id=bubble_resource_id,
            effect_effect_id=effect_effect_id,
            intro_animation=intro_animation,
            intro_duration=intro_duration,
            outro_animation=outro_animation,
            outro_duration=outro_duration,
            width=width,
            height=height,
            fixed_width=fixed_width,
            fixed_height=fixed_height,
            text_styles=text_styles
        )
        
        result["success"] = True
        result["output"] = draft_result
        
        # è®°å½•ç´ æä¿¡æ¯åˆ°ç¼“å­˜
        material_info = {
            "type": "text",
            "content": text,
            "start": start,
            "end": end,
            "duration": end - start if end > start else None,
            "track_name": track_name,
            "font": font,
            "font_size": font_size,
            "added_at": datetime.now().isoformat()
        }
        add_material_to_cache(draft_id, material_info)
        
        return jsonify(result)

    except Exception as e:
        error_message = f"Error occurred while processing text: {str(e)}. You can click the link below for help: "
        result["error"] = error_message
        return jsonify(result)

@app.route('/add_image', methods=['POST'])
def add_image():
    data = request.get_json()
    
    # Get required parameters
    draft_folder = data.get('draft_folder')
    image_url = data.get('image_url')
    
    # Guard: reject unresolved placeholders
    if isinstance(image_url, str) and ('{{' in image_url or '}}' in image_url):
        return jsonify({"success": False, "error": "image_url æ˜¯å ä½ç¬¦ï¼Œæœªæ›¿æ¢ä¸ºçœŸå®åœ°å€ã€‚è¯·åœ¨è°ƒç”¨å‰å…ˆç”Ÿæˆå®é™…URLã€‚", "hint": image_url})
    width = data.get('width', 1080)
    height = data.get('height', 1920)
    start = data.get('start', 0)
    end = data.get('end', 3.0)  # Default display 3 seconds
    draft_id = data.get('draft_id')
    transform_y = data.get('transform_y', 0)
    scale_x = data.get('scale_x', 1)
    scale_y = data.get('scale_y', 1)
    transform_x = data.get('transform_x', 0)
    track_name = data.get('track_name', "image_main")  # Default track name
    relative_index = data.get('relative_index', 0)  # New track rendering order index parameter 
    animation = data.get('animation')  # Entrance animation parameter (backward compatibility)
    animation_duration = data.get('animation_duration', 0.5)  # Entrance animation duration
    intro_animation = data.get('intro_animation')  # New entrance animation parameter, higher priority than animation
    intro_animation_duration = data.get('intro_animation_duration', 0.5)
    outro_animation = data.get('outro_animation')  # New exit animation parameter
    outro_animation_duration = data.get('outro_animation_duration', 0.5)  # New exit animation duration
    combo_animation = data.get('combo_animation')  # New combo animation parameter
    combo_animation_duration = data.get('combo_animation_duration', 0.5)  # New combo animation duration
    transition = data.get('transition')  # Transition type parameter
    transition_duration = data.get('transition_duration', 0.5)  # Transition duration parameter, default 0.5 seconds
    
    # New mask related parameters 
    mask_type = data.get('mask_type')  # Mask type
    mask_center_x = data.get('mask_center_x', 0.0)  # Mask center X coordinate
    mask_center_y = data.get('mask_center_y', 0.0)  # Mask center Y coordinate
    mask_size = data.get('mask_size', 0.5)  # Mask main size, relative to canvas height
    mask_rotation = data.get('mask_rotation', 0.0)  # Mask rotation angle
    mask_feather = data.get('mask_feather', 0.0)  # Mask feather parameter
    mask_invert = data.get('mask_invert', False)  # Whether to invert mask
    mask_rect_width = data.get('mask_rect_width')  # Rectangle mask width
    mask_round_corner = data.get('mask_round_corner')  # Rectangle mask rounded corner

    background_blur = data.get('background_blur')  # Background blur level, optional values: 1 (light), 2 (medium), 3 (strong), 4 (maximum), default None (no background blur)

    result = {
        "success": False,
        "output": "",
        "error": ""
    }

    # Validate required parameters
    if not image_url:
        error_message = "Hi, the required parameters 'image_url' are missing."
        result["error"] = error_message
        return jsonify(result)

    try:
        draft_result = add_image_impl(
            draft_folder=draft_folder,
            image_url=image_url,
            width=width,
            height=height,
            start=start,
            end=end,
            draft_id=draft_id,
            transform_y=transform_y,
            scale_x=scale_x,
            scale_y=scale_y,
            transform_x=transform_x,
            track_name=track_name,
            relative_index=relative_index,  # Pass track rendering order index parameter
            animation=animation,  # Pass entrance animation parameter (backward compatibility)
            animation_duration=animation_duration,  # Pass entrance animation duration
            intro_animation=intro_animation,  # Pass new entrance animation parameter
            intro_animation_duration=intro_animation_duration,
            outro_animation=outro_animation,  # Pass exit animation parameter
            outro_animation_duration=outro_animation_duration,  # Pass exit animation duration
            combo_animation=combo_animation,  # Pass combo animation parameter
            combo_animation_duration=combo_animation_duration,  # Pass combo animation duration
            transition=transition,  # Pass transition type parameter
            transition_duration=transition_duration,  # Pass transition duration parameter (seconds)
            # Pass mask related parameters
            mask_type=mask_type,
            mask_center_x=mask_center_x,
            mask_center_y=mask_center_y,
            mask_size=mask_size,
            mask_rotation=mask_rotation,
            mask_feather=mask_feather,
            mask_invert=mask_invert,
            mask_rect_width=mask_rect_width,
            mask_round_corner=mask_round_corner,
            background_blur=background_blur
        )
        
        result["success"] = True
        result["output"] = draft_result
        
        # è®°å½•ç´ æä¿¡æ¯åˆ°ç¼“å­˜
        material_info = {
            "type": "image",
            "url": image_url,
            "start": start,
            "end": end,
            "duration": end - start if end > start else None,
            "track_name": track_name,
            "added_at": datetime.now().isoformat()
        }
        add_material_to_cache(draft_id, material_info)
        
        return jsonify(result)

    except Exception as e:
        error_message = f"Error occurred while processing image: {str(e)}."
        result["error"] = error_message
        return jsonify(result)

@app.route('/add_video_keyframe', methods=['POST'])
def add_video_keyframe():
    data = request.get_json()
    
    # Get required parameters
    draft_id = data.get('draft_id')
    track_name = data.get('track_name', 'video_main')  # Default main track
    
    # Single keyframe parameters (backward compatibility)
    property_type = data.get('property_type', 'alpha')  # Default opacity
    time = data.get('time', 0.0)  # Default 0 seconds
    value = data.get('value', '1.0')  # Default value 1.0
    
    # Batch keyframe parameters (new)
    property_types = data.get('property_types')  # Property type list
    times = data.get('times')  # Time list
    values = data.get('values')  # Value list

    result = {
        "success": False,
        "output": "",
        "error": ""
    }

    try:
        # Call add_video_keyframe_impl method
        draft_result = add_video_keyframe_impl(
            draft_id=draft_id,
            track_name=track_name,
            property_type=property_type,
            time=time,
            value=value,
            property_types=property_types,
            times=times,
            values=values
        )
        
        result["success"] = True
        result["output"] = draft_result
        return jsonify(result)

    except Exception as e:
        error_message = f"Error occurred while adding keyframe: {str(e)}."
        result["error"] = error_message
        return jsonify(result)

@app.route('/add_effect', methods=['POST'])
def add_effect():
    data = request.get_json()
    
    # Get required parameters
    effect_type = data.get('effect_type')  # Effect type name, will match from Video_scene_effect_type or Video_character_effect_type
    start = data.get('start', 0)  # Start time (seconds), default 0
    end = data.get('end', 3.0)  # End time (seconds), default 3 seconds
    draft_id = data.get('draft_id')  # Draft ID, if None or corresponding zip file not found, create new draft
    track_name = data.get('track_name', "effect_01")  # Track name, can be omitted when there is only one effect track
    params = data.get('params')  # Effect parameter list, items not provided or None in parameter list use default values
    width = data.get('width', 1080)
    height = data.get('height', 1920)

    result = {
        "success": False,
        "output": "",
        "error": ""
    }

    # Validate required parameters
    if not effect_type:
        error_message = "Hi, the required parameters 'effect_type' are missing. Please add them and try again."
        result["error"] = error_message
        return jsonify(result)

    try:
        # Call add_effect_impl method
        draft_result = add_effect_impl(
            effect_type=effect_type,
            start=start,
            end=end,
            draft_id=draft_id,
            track_name=track_name,
            params=params,
            width=width,
            height=height
        )
        
        result["success"] = True
        result["output"] = draft_result
        return jsonify(result)

    except Exception as e:
        error_message = f"Error occurred while adding effect: {str(e)}. "
        result["error"] = error_message
        return jsonify(result)

@app.route('/query_script', methods=['POST'])
def query_script():
    data = request.get_json()

    # Get required parameters
    draft_id = data.get('draft_id')
    force_update = data.get('force_update', True)
    
    result = {
        "success": False,
        "output": "",
        "error": ""
    }

    # Validate required parameters
    if not draft_id:
        error_message = "Hi, the required parameter 'draft_id' is missing. Please add it and try again."
        result["error"] = error_message
        return jsonify(result)

    try:
        # Call query_script_impl method
        script = query_script_impl(draft_id=draft_id, force_update=force_update)
        
        if script is None:
            error_message = f"Draft {draft_id} does not exist in cache."
            result["error"] = error_message
            return jsonify(result)
        
        # Convert script object to JSON serializable dictionary
        script_str = script.dumps()
        
        result["success"] = True
        result["output"] = script_str
        return jsonify(result)

    except Exception as e:
        error_message = f"Error occurred while querying script: {str(e)}. "
        result["error"] = error_message
        return jsonify(result)

@app.route('/save_draft', methods=['POST'])
def save_draft():
    data = request.get_json()
    
    # Get required parameters
    draft_id = (data.get('draft_id') or '').strip()
    draft_folder = data.get('draft_folder')  # Draft folder parameter
    
    result = {
        "success": False,
        "output": "",
        "error": ""
    }
    
    # Validate required parameters
    if not draft_id:
        error_message = "Hi, the required parameter 'draft_id' is missing. Please add it and try again."
        result["error"] = error_message
        return jsonify(result)
    
    try:
        # Call save_draft_impl method, start background task
        draft_result = save_draft_impl(draft_id, draft_folder)
        
        # Return the result from save_draft_impl directly
        return jsonify(draft_result)
        
    except Exception as e:
        error_message = f"Error occurred while saving draft: {str(e)}. "
        result["error"] = error_message
        return jsonify(result)

# Add new query status interface
@app.route('/query_draft_status', methods=['POST'])
def query_draft_status():
    data = request.get_json()
    
    # Get required parameters
    task_id = data.get('task_id')
    
    result = {
        "success": False,
        "output": "",
        "error": ""
    }
    
    # Validate required parameters
    if not task_id:
        error_message = "Hi, the required parameter 'task_id' is missing. Please add it and try again."
        result["error"] = error_message
        return jsonify(result)
    
    try:
        # Get task status
        task_status = query_task_status(task_id)
        
        if task_status["status"] == "not_found":
            error_message = f"Task with ID {task_id} not found. Please check if the task ID is correct."
            result["error"] = error_message
            return jsonify(result)
        
        # Return task status directly with success flag
        task_status["success"] = True
        return jsonify(task_status)
        
    except Exception as e:
        error_message = f"Error occurred while querying task status: {str(e)}."
        result["error"] = error_message
        return jsonify(result)

@app.route('/mirror_to_oss', methods=['POST'])
def mirror_to_oss():
    """Download an external URL (e.g., Dify file URL) and mirror it to our OSS bucket.
    Body: {"url": "http://...", "prefix": "capcut/images"}
    Return: {success, oss_url, object}
    """
    data = request.get_json(force=True, silent=True) or {}
    src_url = (data.get('url') or '').strip()
    prefix = (data.get('prefix') or 'capcut').strip().strip('/')
    if not src_url:
        return jsonify({"success": False, "error": "url required"}), 400
    try:
        # stream download
        r = requests.get(src_url, timeout=20, stream=True)
        r.raise_for_status()
        content_type = r.headers.get('Content-Type', '')
        ext = '.png'
        if 'jpeg' in content_type or 'jpg' in content_type:
            ext = '.jpg'
        elif 'webp' in content_type:
            ext = '.webp'
        elif 'gif' in content_type:
            ext = '.gif'
        object_name = f"{prefix}/{_uuid.uuid4().hex}{ext}" if prefix else f"{_uuid.uuid4().hex}{ext}"
        bucket = _ensure_bucket_v4()
        bucket.put_object(object_name, r.raw)
        signed = bucket.sign_url('GET', object_name, 24*60*60, slash_safe=True)
        return jsonify({"success": True, "oss_url": signed, "object": object_name})
    except Exception as e:
        return jsonify({"success": False, "error": str(e)}), 500

@app.route('/generate_draft_url', methods=['POST'])
def generate_draft_url():
    data = request.get_json(silent=True) or {}
    
    # Get required parameters
    draft_id = data.get('draft_id')
    draft_folder = data.get('draft_folder')  # Custom client base folder for local save use or display
    force_save = data.get('force_save')
    client_os = (data.get('client_os') or 'windows').lower()
    # Also accept query flag as compatibility
    if force_save is None:
        force_save = request.args.get('force_save', 'false').lower() in ['1', 'true', 'yes']
    
    result = {
        "success": False,
        "output": "",
        "error": ""
    }
    
    # Validate required parameters
    if not draft_id:
        error_message = "Hi, the required parameter 'draft_id' is missing. Please add it and try again."
        result["error"] = error_message
        return jsonify(result)
    
    try:
        # Sanitize and encode draft_id to avoid newline/space issues
        if isinstance(draft_id, str):
            draft_id = draft_id.strip()
        else:
            draft_id = str(draft_id).strip()
        safe_id = quote(draft_id, safe='-_.')

        # If upload-to-OSS mode is enabled and the draft zip already exists, return signed URL directly
        if IS_UPLOAD_DRAFT:
            signed_url, exists = get_signed_draft_url_if_exists(draft_id)
            if exists and signed_url:
                # If client provided customization info (os or draft_folder), generate derived zip
                if draft_folder or (client_os and client_os != 'windows'):
                    try:
                        if not draft_folder:
                            # If no explicit draft_folder, keep as-is but return base URL
                            pass
                        else:
                            custom_url = get_customized_signed_url(draft_id, client_os, draft_folder)
                            draft_result = {"draft_url": custom_url, "storage": "oss", "client_os": client_os, "draft_folder": draft_folder or ""}
                            result["success"] = True
                            result["output"] = draft_result
                            return jsonify(result)
                    except Exception as _:
                        # Fall back to base signed url on any failure
                        pass
                draft_result = {"draft_url": signed_url, "storage": "oss", "client_os": client_os, "draft_folder": draft_folder or ""}
                result["success"] = True
                result["output"] = draft_result
                return jsonify(result)

            # Not exists: if force_save requested, kick off background save now
            if force_save:
                task_info = save_draft_impl(draft_id, draft_folder)
                out = {
                    "status": "processing",
                    "task_id": task_info.get("task_id", draft_id),
                    "message": "Save task started. Please poll /query_draft_status until completed, then call /generate_draft_url again.",
                    "next": {
                        "query": "/query_draft_status",
                        "generate": "/generate_draft_url"
                    },
                    "client_os": client_os,
                    "draft_folder": draft_folder or ""
                }
                result["success"] = True
                result["output"] = out
                return jsonify(result)

        # Fallback to local preview router page
        draft_result = { "draft_url" : f"{DRAFT_DOMAIN}{PREVIEW_ROUTER}?draft_id={safe_id}", "storage": "local", "client_os": client_os, "draft_folder": draft_folder or ""}
        
        result["success"] = True
        result["output"] = draft_result
        return jsonify(result)
        
    except Exception as e:
        error_message = f"Error occurred while saving draft: {str(e)}."
        result["error"] = error_message
        return jsonify(result)

@app.route('/draft/downloader', methods=['GET'])
def draft_downloader():
    """Simple landing page for downloading or locating draft by id.
    Supports both ?draft_id=xxx and legacy ?=xxx query formats.
    """
    # Support both standard and legacy empty-key query
    draft_id = request.args.get('draft_id')
    if not draft_id and '' in request.args:
        draft_id = request.args.get('')
    if not draft_id:
        return Response("Missing 'draft_id' in query string.", status=400)
    draft_id = str(draft_id).strip()
    # Detect client os from query, default windows
    client_os = request.args.get('os', 'windows').lower()
    # Optional custom base from query for preview
    custom_base = request.args.get('base', '').strip()
    if custom_base:
        base = custom_base.rstrip('\\/')
    else:
        base = ''
    local_path = utilgenerate_draft_url(draft_id, client_os=client_os, base=base)
    import json as _json
    html_template = """
    <!DOCTYPE html>
    <html lang="zh-CN">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>è‰ç¨¿ä¸‹è½½/æ‰“å¼€</title>
        <style>
            body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; padding: 24px; }
            .card { max-width: 820px; margin: 0 auto; background: #fff; border-radius: 12px; padding: 24px; box-shadow: 0 10px 30px rgba(0,0,0,0.06); }
            h1 { margin: 0 0 12px; }
            .row { display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
            .id { font-family: ui-monospace, SFMono-Regular, Menlo, monospace; color: #4f46e5; }
            .path { background: #f3f4f6; padding: 12px; border-radius: 8px; font-family: ui-monospace, SFMono-Regular, Menlo, monospace; overflow:auto; }
            .tip { color: #6b7280; margin-top: 12px; }
            .btn { background:#4f46e5; color:#fff; border:none; padding:10px 16px; border-radius:8px; cursor:pointer; }
            .btn:disabled { opacity:.6; cursor:not-allowed; }
            .log { margin-top:10px; background:#f9fafb; border-radius:8px; padding:12px; height:160px; overflow:auto; font-family: ui-monospace, SFMono-Regular, Menlo, monospace; font-size: 13px; }
            select { padding:6px 10px; border-radius:8px; border:1px solid #e5e7eb; }
        </style>
    </head>
    <body>
        <div class="card">
            <h1>è‰ç¨¿ä¿¡æ¯</h1>
            <div class="row">
              <p>è‰ç¨¿ IDï¼š<span class="id">__DRAFT_ID_DISPLAY__</span></p>
              <label>ç³»ç»Ÿ: 
                <select id="osSelect">
                  <option value="windows">Windows</option>
                  <option value="linux">Linux</option>
                </select>
              </label>
              <label>è‡ªå®šä¹‰æ ¹è·¯å¾„:
                <input id="baseInput" type="text" placeholder="å¯é€‰ï¼Œå¦‚ F:/MyDrafts æˆ– /data/drafts" style="padding:6px 10px;border-radius:8px;border:1px solid #e5e7eb;min-width:260px;" />
              </label>
            </div>
            <p>æœ¬åœ°è‰ç¨¿è·¯å¾„ï¼ˆOS: __CLIENT_OS__ï¼‰ï¼š</p>
            <div class="path">__LOCAL_PATH__</div>
            <p class="tip">å¦‚æœä½ å·²å¼€å¯äº‘ä¸Šä¼ ï¼ˆconfig.json ä¸­ is_upload_draft=trueï¼‰å¹¶ä¸”è¯¥è‰ç¨¿ zip å·²ç»ä¸Šä¼ ï¼Œä¸‹é¢çš„æŒ‰é’®ä¼šåœ¨å®Œæˆåè‡ªåŠ¨è·³è½¬åˆ° OSS ç­¾åä¸‹è½½é“¾æ¥ã€‚</p>
            <button id="saveUploadBtn" class="btn">ä¸€é”®ä¿å­˜å¹¶ä¸Šä¼ åˆ°OSS</button>
            <div id="status" class="tip"></div>
            <div id="log" class="log"></div>
        </div>
        <script>
            const draftId = __DRAFT_ID__;
            const btn = document.getElementById('saveUploadBtn');
            const statusEl = document.getElementById('status');
            const logEl = document.getElementById('log');
            const osSelect = document.getElementById('osSelect');
            const clientOs = '__CLIENT_OS__';
            osSelect.value = clientOs;
            const baseInput = document.getElementById('baseInput');
            try { baseInput.value = new URL(window.location.href).searchParams.get('base') || ''; } catch(e) {}
            osSelect.addEventListener('change', () => {
                const base = new URL(window.location.href);
                base.searchParams.set('draft_id', __DRAFT_ID__);
                base.searchParams.set('os', osSelect.value);
                if (baseInput.value) base.searchParams.set('base', baseInput.value);
                window.location.href = base.toString();
            });
            baseInput.addEventListener('change', () => {
                const base = new URL(window.location.href);
                base.searchParams.set('draft_id', __DRAFT_ID__);
                base.searchParams.set('os', osSelect.value);
                if (baseInput.value) base.searchParams.set('base', baseInput.value);
                else base.searchParams.delete('base');
                window.location.href = base.toString();
            });
            function log(msg) {
                const t = new Date().toLocaleTimeString();
                logEl.textContent += `[${{t}}] ${{msg}}\\n`;
                logEl.scrollTop = logEl.scrollHeight;
            }
            async function postJSON(url, body) {
                const res = await fetch(url, { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(body) });
                return await res.json();
            }
            async function pollStatus(taskId) {
                while (true) {
                    const s = await postJSON('/query_draft_status', { task_id: taskId });
                    if (s && s.status) {
                        statusEl.textContent = `ä»»åŠ¡çŠ¶æ€: ${{s.status}}ï¼Œè¿›åº¦: ${{s.progress||0}}% ï¼Œ${{s.message||''}}`;
                        log(`status=${{s.status}}, progress=${{s.progress}}`);
                        if (s.status === 'completed') break;
                        if (s.status === 'failed') throw new Error(s.message || 'ä»»åŠ¡å¤±è´¥');
                    }
                    await new Promise(r => setTimeout(r, 2000));
                }
            }
            async function finalizeRedirect() {
                const r = await postJSON('/generate_draft_url', { draft_id: draftId, client_os: osSelect.value, draft_folder: baseInput.value || undefined });
                if (r && r.success && r.output && r.output.draft_url) {
                    log('è·³è½¬åˆ° OSS é“¾æ¥');
                    window.location.href = r.output.draft_url;
                } else {
                    throw new Error('æœªè·å–åˆ°ä¸‹è½½é“¾æ¥');
                }
            }
            async function autoRun() {
                try {
                    btn.disabled = true;
                    statusEl.textContent = 'æ­£åœ¨æ£€æµ‹äº‘ç«¯æ–‡ä»¶...';
                    log('æ£€æµ‹æ˜¯å¦å·²å­˜åœ¨ OSS ç›´é“¾');
                    const first = await postJSON('/generate_draft_url', { draft_id: draftId, client_os: osSelect.value, draft_folder: baseInput.value || undefined });
                    if (first && first.success && first.output) {
                        if (first.output.storage === 'oss' && first.output.draft_url) {
                            window.location.href = first.output.draft_url; return;
                        }
                    }
                    log('æœªå‘ç°ç›´é“¾ï¼Œè‡ªåŠ¨è§¦å‘ä¿å­˜å¹¶ä¸Šä¼ ');
                    statusEl.textContent = 'æ­£åœ¨æäº¤ä¿å­˜ä»»åŠ¡...';
                    const start = await postJSON('/generate_draft_url?force_save=true', { draft_id: draftId, client_os: osSelect.value, draft_folder: baseInput.value || undefined });
                    if (start && start.success && start.output) {
                        if (start.output.storage === 'oss' && start.output.draft_url) {
                            window.location.href = start.output.draft_url; return;
                        }
                        if (start.output.status === 'processing' && start.output.task_id) {
                            await pollStatus(start.output.task_id);
                            await finalizeRedirect();
                            return;
                        }
                    }
                    throw new Error('è‡ªåŠ¨æµç¨‹æ¥å£è¿”å›å¼‚å¸¸');
                } catch (e) {
                    log('è‡ªåŠ¨æµç¨‹å¤±è´¥ï¼Œè¯·ç‚¹å‡»æŒ‰é’®é‡è¯•: ' + e.message);
                } finally {
                    btn.disabled = false;
                }
            }
            // è‡ªåŠ¨è¿è¡Œ
            document.addEventListener('DOMContentLoaded', () => {
                autoRun();
            });
            // æ‰‹åŠ¨æŒ‰é’®ä½œä¸ºå…œåº•
            btn.addEventListener('click', async () => {
                btn.disabled = true; statusEl.textContent = 'æ­£åœ¨æäº¤ä»»åŠ¡...'; log('æäº¤ force_save è¯·æ±‚');
                try {
                    const r = await postJSON('/generate_draft_url?force_save=true', { draft_id: draftId, client_os: osSelect.value, draft_folder: baseInput.value || undefined });
                    if (r && r.success && r.output) {
                        if (r.output.storage === 'oss' && r.output.draft_url) {
                            // å·²å­˜åœ¨ï¼Œç›´æ¥è·³è½¬
                            window.location.href = r.output.draft_url; return;
                        }
                        if (r.output.status === 'processing' && r.output.task_id) {
                            await pollStatus(r.output.task_id);
                            await finalizeRedirect();
                            return;
                        }
                    }
                    throw new Error('æ¥å£è¿”å›å¼‚å¸¸');
                } catch (e) {
                    alert('æ“ä½œå¤±è´¥: ' + e.message);
                    log('å¤±è´¥: ' + e.message);
                } finally {
                    btn.disabled = false;
                }
            });
        </script>
    </body>
    </html>
    """
    html = (html_template
            .replace("__DRAFT_ID__", _json.dumps(draft_id))
            .replace("__DRAFT_ID_DISPLAY__", draft_id)
            .replace("__LOCAL_PATH__", local_path)
            .replace("__CLIENT_OS__", client_os))
    return Response(html, mimetype='text/html')

@app.route('/add_sticker', methods=['POST'])
def add_sticker():
    data = request.get_json()
    # Get required parameters
    resource_id = data.get('sticker_id')
    start = data.get('start', 0)
    end = data.get('end', 5.0)  # Default display 5 seconds
    draft_id = data.get('draft_id')
    transform_y = data.get('transform_y', 0)
    transform_x = data.get('transform_x', 0)
    alpha = data.get('alpha', 1.0)
    flip_horizontal = data.get('flip_horizontal', False)
    flip_vertical = data.get('flip_vertical', False)
    rotation = data.get('rotation', 0.0)
    scale_x = data.get('scale_x', 1.0)
    scale_y = data.get('scale_y', 1.0)
    track_name = data.get('track_name', 'sticker_main')
    relative_index = data.get('relative_index', 0)
    width = data.get('width', 1080)
    height = data.get('height', 1920)

    result = {
        "success": False,
        "output": "",
        "error": ""
    }

    # Validate required parameters
    if not resource_id:
        error_message = "Hi, the required parameter 'sticker_id' is missing. Please add it and try again. "
        result["error"] = error_message
        return jsonify(result)

    try:
        # Call add_sticker_impl method
        draft_result = add_sticker_impl(
            resource_id=resource_id,
            start=start,
            end=end,
            draft_id=draft_id,
            transform_y=transform_y,
            transform_x=transform_x,
            alpha=alpha,
            flip_horizontal=flip_horizontal,
            flip_vertical=flip_vertical,
            rotation=rotation,
            scale_x=scale_x,
            scale_y=scale_y,
            track_name=track_name,
            relative_index=relative_index,
            width=width,
            height=height
        )

        result["success"] = True
        result["output"] = draft_result
        return jsonify(result)

    except Exception as e:
        error_message = f"Error occurred while adding sticker: {str(e)}. "
        result["error"] = error_message
        return jsonify(result)

@app.route('/get_intro_animation_types', methods=['GET'])
def get_intro_animation_types():
    """Return supported entrance animation type list
    
    If IS_CAPCUT_ENV is True, return entrance animation types in CapCut environment
    Otherwise return entrance animation types in JianYing environment
    """
    result = {
        "success": True,
        "output": "",
        "error": ""
    }
    
    try:
        animation_types = []
        
        if IS_CAPCUT_ENV:
            # Return entrance animation types in CapCut environment
            for name, member in CapCut_Intro_type.__members__.items():
                animation_types.append({
                    "name": name
                })
        else:
            # Return entrance animation types in JianYing environment
            for name, member in Intro_type.__members__.items():
                animation_types.append({
                    "name": name
                })
        
        result["output"] = animation_types
        return jsonify(result)
    
    except Exception as e:
        result["success"] = False
        result["error"] = f"Error occurred while getting entrance animation types: {str(e)}"
        return jsonify(result)
        
@app.route('/get_outro_animation_types', methods=['GET'])
def get_outro_animation_types():
    """Return supported exit animation type list
    
    If IS_CAPCUT_ENV is True, return exit animation types in CapCut environment
    Otherwise return exit animation types in JianYing environment
    """
    result = {
        "success": True,
        "output": "",
        "error": ""
    }
    
    try:
        animation_types = []
        
        if IS_CAPCUT_ENV:
            # Return exit animation types in CapCut environment
            for name, member in CapCut_Outro_type.__members__.items():
                animation_types.append({
                    "name": name
                })
        else:
            # Return exit animation types in JianYing environment
            for name, member in Outro_type.__members__.items():
                animation_types.append({
                    "name": name
                })
        
        result["output"] = animation_types
        return jsonify(result)
    
    except Exception as e:
        result["success"] = False
        result["error"] = f"Error occurred while getting exit animation types: {str(e)}"
        return jsonify(result)


@app.route('/get_combo_animation_types', methods=['GET'])
def get_combo_animation_types():
    """Return supported combo animation type list
    
    If IS_CAPCUT_ENV is True, return combo animation types in CapCut environment
    Otherwise return combo animation types in JianYing environment
    """
    result = {
        "success": True,
        "output": "",
        "error": ""
    }
    
    try:
        animation_types = []
        
        if IS_CAPCUT_ENV:
            # Return combo animation types in CapCut environment
            for name, member in CapCut_Group_animation_type.__members__.items():
                animation_types.append({
                    "name": name
                })
        else:
            # Return combo animation types in JianYing environment
            for name, member in Group_animation_type.__members__.items():
                animation_types.append({
                    "name": name
                })
        
        result["output"] = animation_types
        return jsonify(result)
    
    except Exception as e:
        result["success"] = False
        result["error"] = f"Error occurred while getting combo animation types: {str(e)}"
        return jsonify(result)


@app.route('/get_transition_types', methods=['GET'])
def get_transition_types():
    """Return supported transition animation type list
    
    If IS_CAPCUT_ENV is True, return transition animation types in CapCut environment
    Otherwise return transition animation types in JianYing environment
    """
    result = {
        "success": True,
        "output": "",
        "error": ""
    }
    
    try:
        transition_types = []
        
        if IS_CAPCUT_ENV:
            # Return transition animation types in CapCut environment
            for name, member in CapCut_Transition_type.__members__.items():
                transition_types.append({
                    "name": name
                })
        else:
            # Return transition animation types in JianYing environment
            for name, member in Transition_type.__members__.items():
                transition_types.append({
                    "name": name
                })
        
        result["output"] = transition_types
        return jsonify(result)
    
    except Exception as e:
        result["success"] = False
        result["error"] = f"Error occurred while getting transition animation types: {str(e)}"
        return jsonify(result)


@app.route('/get_mask_types', methods=['GET'])
def get_mask_types():
    """Return supported mask type list
    
    If IS_CAPCUT_ENV is True, return mask types in CapCut environment
    Otherwise return mask types in JianYing environment
    """
    result = {
        "success": True,
        "output": "",
        "error": ""
    }
    
    try:
        mask_types = []
        
        if IS_CAPCUT_ENV:
            # Return mask types in CapCut environment
            for name, member in CapCut_Mask_type.__members__.items():
                mask_types.append({
                    "name": name
                })
        else:
            # Return mask types in JianYing environment
            for name, member in Mask_type.__members__.items():
                mask_types.append({
                    "name": name
                })
        
        result["output"] = mask_types
        return jsonify(result)
    
    except Exception as e:
        result["success"] = False
        result["error"] = f"Error occurred while getting mask types: {str(e)}"
        return jsonify(result)


@app.route('/get_audio_effect_types', methods=['GET'])
def get_audio_effect_types():
    """Return supported audio effect type list
    
    If IS_CAPCUT_ENV is True, return audio effect types in CapCut environment
    Otherwise return audio effect types in JianYing environment
    
    The returned structure includes name, type and Effect_param information
    """
    result = {
        "success": True,
        "output": "",
        "error": ""
    }
    
    try:
        audio_effect_types = []
        
        if IS_CAPCUT_ENV:
            # Return audio effect types in CapCut environment
            # 1. Voice filters effect types
            for name, member in CapCut_Voice_filters_effect_type.__members__.items():
                params_info = []
                for param in member.value.params:
                    params_info.append({
                        "name": param.name,
                        "default_value": param.default_value * 100,
                        "min_value": param.min_value * 100,
                        "max_value": param.max_value * 100
                    })
                
                audio_effect_types.append({
                    "name": name,
                    "type": "Voice_filters",
                    "params": params_info
                })
            
            # 2. Voice characters effect types
            for name, member in CapCut_Voice_characters_effect_type.__members__.items():
                params_info = []
                for param in member.value.params:
                    params_info.append({
                        "name": param.name,
                        "default_value": param.default_value * 100,
                        "min_value": param.min_value * 100,
                        "max_value": param.max_value * 100
                    })
                
                audio_effect_types.append({
                    "name": name,
                    "type": "Voice_characters",
                    "params": params_info
                })
            
            # 3. Speech to song effect types
            for name, member in CapCut_Speech_to_song_effect_type.__members__.items():
                params_info = []
                for param in member.value.params:
                    params_info.append({
                        "name": param.name,
                        "default_value": param.default_value * 100,
                        "min_value": param.min_value * 100,
                        "max_value": param.max_value * 100
                    })
                
                audio_effect_types.append({
                    "name": name,
                    "type": "Speech_to_song",
                    "params": params_info
                })
        else:
            # Return audio effect types in JianYing environment
            # 1. Tone effect types
            for name, member in Tone_effect_type.__members__.items():
                params_info = []
                for param in member.value.params:
                    params_info.append({
                        "name": param.name,
                        "default_value": param.default_value * 100,
                        "min_value": param.min_value * 100,
                        "max_value": param.max_value * 100
                    })
                
                audio_effect_types.append({
                    "name": name,
                    "type": "Tone",
                    "params": params_info
                })
            
            # 2. Audio scene effect types
            for name, member in Audio_scene_effect_type.__members__.items():
                params_info = []
                for param in member.value.params:
                    params_info.append({
                        "name": param.name,
                        "default_value": param.default_value * 100,
                        "min_value": param.min_value * 100,
                        "max_value": param.max_value * 100
                    })
                
                audio_effect_types.append({
                    "name": name,
                    "type": "Audio_scene",
                    "params": params_info
                })
            
            # 3. Speech to song effect types
            for name, member in Speech_to_song_type.__members__.items():
                params_info = []
                for param in member.value.params:
                    params_info.append({
                        "name": param.name,
                        "default_value": param.default_value * 100,
                        "min_value": param.min_value * 100,
                        "max_value": param.max_value * 100
                    })
                
                audio_effect_types.append({
                    "name": name,
                    "type": "Speech_to_song",
                    "params": params_info
                })
        
        result["output"] = audio_effect_types
        return jsonify(result)
    
    except Exception as e:
        result["success"] = False
        result["error"] = f"Error occurred while getting audio effect types: {str(e)}"
        return jsonify(result)


@app.route('/get_font_types', methods=['GET'])
def get_font_types():
    """Return supported font type list
    
    Return font types in JianYing environment
    """
    result = {
        "success": True,
        "output": "",
        "error": ""
    }
    
    try:
        font_types = []
        
        # Return font types in JianYing environment
        for name, member in Font_type.__members__.items():
            font_types.append({
                "name": name
            })
        
        result["output"] = font_types
        return jsonify(result)
    
    except Exception as e:
        result["success"] = False
        result["error"] = f"Error occurred while getting font types: {str(e)}"
        return jsonify(result)


@app.route('/get_text_intro_types', methods=['GET'])
def get_text_intro_types():
    """Return supported text entrance animation type list
    
    If IS_CAPCUT_ENV is True, return text entrance animation types in CapCut environment
    Otherwise return text entrance animation types in JianYing environment
    """
    result = {
        "success": True,
        "output": "",
        "error": ""
    }
    
    try:
        text_intro_types = []
        
        if IS_CAPCUT_ENV:
            # Return text entrance animation types in CapCut environment
            for name, member in CapCut_Text_intro.__members__.items():
                text_intro_types.append({
                    "name": name
                })
        else:
            # Return text entrance animation types in JianYing environment
            for name, member in Text_intro.__members__.items():
                text_intro_types.append({
                    "name": name
                })
        
        result["output"] = text_intro_types
        return jsonify(result)
    
    except Exception as e:
        result["success"] = False
        result["error"] = f"Error occurred while getting text entrance animation types: {str(e)}"
        return jsonify(result)

@app.route('/get_text_outro_types', methods=['GET'])
def get_text_outro_types():
    """Return supported text exit animation type list
    
    If IS_CAPCUT_ENV is True, return text exit animation types in CapCut environment
    Otherwise return text exit animation types in JianYing environment
    """
    result = {
        "success": True,
        "output": "",
        "error": ""
    }
    
    try:
        text_outro_types = []
        
        if IS_CAPCUT_ENV:
            # Return text exit animation types in CapCut environment
            for name, member in CapCut_Text_outro.__members__.items():
                text_outro_types.append({
                    "name": name
                })
        else:
            # Return text exit animation types in JianYing environment
            for name, member in Text_outro.__members__.items():
                text_outro_types.append({
                    "name": name
                })
        
        result["output"] = text_outro_types
        return jsonify(result)
    
    except Exception as e:
        result["success"] = False
        result["error"] = f"Error occurred while getting text exit animation types: {str(e)}"
        return jsonify(result)

@app.route('/get_text_loop_anim_types', methods=['GET'])
def get_text_loop_anim_types():
    """Return supported text loop animation type list
    
    If IS_CAPCUT_ENV is True, return text loop animation types in CapCut environment
    Otherwise return text loop animation types in JianYing environment
    """
    result = {
        "success": True,
        "output": "",
        "error": ""
    }
    
    try:
        text_loop_anim_types = []
        
        if IS_CAPCUT_ENV:
            # Return text loop animation types in CapCut environment
            for name, member in CapCut_Text_loop_anim.__members__.items():
                text_loop_anim_types.append({
                    "name": name
                })
        else:
            # Return text loop animation types in JianYing environment
            for name, member in Text_loop_anim.__members__.items():
                text_loop_anim_types.append({
                    "name": name
                })
        
        result["output"] = text_loop_anim_types
        return jsonify(result)
    
    except Exception as e:
        result["success"] = False
        result["error"] = f"Error occurred while getting text loop animation types: {str(e)}"
        return jsonify(result)


@app.route('/get_video_scene_effect_types', methods=['GET'])
def get_video_scene_effect_types():
    """Return supported scene effect type list
    
    If IS_CAPCUT_ENV is True, return scene effect types in CapCut environment
    Otherwise return scene effect types in JianYing environment
    """
    result = {
        "success": True,
        "output": "",
        "error": ""
    }
    
    try:
        effect_types = []
        
        if IS_CAPCUT_ENV:
            # Return scene effect types in CapCut environment
            for name, member in CapCut_Video_scene_effect_type.__members__.items():
                effect_types.append({
                    "name": name
                })
        else:
            # Return scene effect types in JianYing environment
            for name, member in Video_scene_effect_type.__members__.items():
                effect_types.append({
                    "name": name
                })
        
        result["output"] = effect_types
        return jsonify(result)
    
    except Exception as e:
        result["success"] = False
        result["error"] = f"Error occurred while getting scene effect types: {str(e)}"
        return jsonify(result)


@app.route('/get_video_character_effect_types', methods=['GET'])
def get_video_character_effect_types():
    """Return supported character effect type list
    
    If IS_CAPCUT_ENV is True, return character effect types in CapCut environment
    Otherwise return character effect types in JianYing environment
    """
    result = {
        "success": True,
        "output": "",
        "error": ""
    }
    
    try:
        effect_types = []
        
        if IS_CAPCUT_ENV:
            # Return character effect types in CapCut environment
            for name, member in CapCut_Video_character_effect_type.__members__.items():
                effect_types.append({
                    "name": name
                })
        else:
            # Return character effect types in JianYing environment
            for name, member in Video_character_effect_type.__members__.items():
                effect_types.append({
                    "name": name
                })
        
        result["output"] = effect_types
        return jsonify(result)
    
    except Exception as e:
        result["success"] = False
        result["error"] = f"Error occurred while getting character effect types: {str(e)}"
        return jsonify(result)

@app.route('/upload_to_oss', methods=['POST'])
def upload_to_oss_route():
    """Upload binary content to OSS and return signed url.
    Accepts:
    - multipart/form-data: file=<binary>, prefix
    - application/json: {"filename":"a.png","data_base64":"...","prefix":"capcut/images"}
    Return: {success, oss_url, object}
    """
    try:
        prefix = (request.form.get('prefix') or request.args.get('prefix') or 'capcut').strip().strip('/')
        data = None
        filename = None
        if 'file' in request.files:
            f = request.files['file']
            data = f.read()
            filename = f.filename or 'upload.bin'
        else:
            js = request.get_json(silent=True) or {}
            filename = js.get('filename') or 'upload.bin'
            b64 = js.get('data_base64') or ''
            if b64:
                import base64
                try:
                    data = base64.b64decode(b64)
                except Exception:
                    return jsonify({"success": False, "error": "invalid base64"}), 400
        if not data:
            return jsonify({"success": False, "error": "no file provided"}), 400
        # guess extension
        ext = '.bin'
        lower = (filename or '').lower()
        if lower.endswith('.png'):
            ext = '.png'
        elif lower.endswith('.jpg') or lower.endswith('.jpeg'):
            ext = '.jpg'
        elif lower.endswith('.webp'):
            ext = '.webp'
        elif lower.endswith('.gif'):
            ext = '.gif'
        object_name = f"{prefix}/{_uuid.uuid4().hex}{ext}" if prefix else f"{_uuid.uuid4().hex}{ext}"
        bucket = _ensure_bucket_v4()
        bucket.put_object(object_name, data)
        signed = bucket.sign_url('GET', object_name, 24*60*60, slash_safe=True)
        return jsonify({"success": True, "oss_url": signed, "object": object_name})
    except Exception as e:
        return jsonify({"success": False, "error": str(e)}), 500

# åˆ é™¤é‡å¤çš„ç¬¬ä¸€ä¸ªé¢„è§ˆå‡½æ•°ï¼Œä¿ç•™å¢å¼ºç‰ˆ

@app.route('/draft/preview/<draft_id>', methods=['GET'])
def enhanced_draft_preview(draft_id: str):
    """å¢å¼ºç‰ˆè‰ç¨¿è¯¦ç»†é¢„è§ˆé¡µé¢ - ç®€åŒ–ç‰ˆ"""
    try:
        # è·å–è‰ç¨¿çš„ç´ æä¿¡æ¯
        materials = get_draft_materials(draft_id)
        
        # æ™ºèƒ½æ£€æŸ¥è‰ç¨¿å­˜åœ¨æ€§ - æ”¯æŒæœ¬åœ°æ–‡ä»¶å’ŒOSSçŠ¶æ€
        # ç®€åŒ–è‰ç¨¿å­˜åœ¨æ€§æ£€æŸ¥ - åªè¦æœ‰ç´ æä¿¡æ¯å°±è®¤ä¸ºè‰ç¨¿å­˜åœ¨
        draft_exists = len(materials) > 0
        file_size = 9500  # é»˜è®¤å€¼
        import time
        created_time = time.time()
        draft_source = "oss"
        
        if not draft_exists:
            return f"""
<!DOCTYPE html>
<html>
<head><title>è‰ç¨¿ä¸å­˜åœ¨</title></head>
<body style="font-family: Arial; text-align: center; padding: 50px;">
    <h2>è‰ç¨¿ {draft_id} ä¸å­˜åœ¨</h2>
    <p>è¯¥è‰ç¨¿å¯èƒ½å°šæœªç”Ÿæˆå®Œæˆï¼Œæˆ–è€…å·²è¢«æ¸…ç†ã€‚</p>
    <p><a href="javascript:history.back()">è¿”å›ä¸Šä¸€é¡µ</a></p>
</body>
</html>
""", 404
        
        # åˆå§‹ä¸æ˜¾ç¤ºç´ æè¯¦ç»†ä¿¡æ¯ï¼Œç­‰å¾…ç”¨æˆ·ç‚¹å‡»è½¨é“æ—¶åŠ¨æ€æ˜¾ç¤º
        material_rows = """
                        <tr class="material-rows" style="background-color: #2a2a2a;">
                            <td colspan="2" style="text-align: center; color: #888; padding: 20px;">
                                ç‚¹å‡»ä¸‹æ–¹è½¨é“ç´ ææŸ¥çœ‹è¯¦ç»†ä¿¡æ¯
                            </td>
                        </tr>"""
        
        # å°†ç´ ææ•°æ®è½¬æ¢ä¸ºJavaScriptå¯ç”¨çš„æ ¼å¼
        materials_json = json.dumps(materials, ensure_ascii=False)
        
        html_content = f"""
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‰ç¨¿é¢„è§ˆ - {draft_id}</title>
    <style>
        * {{
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }}
        
        body {{
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', sans-serif;
            background: #1a1a1a;
            color: #fff;
            overflow-x: hidden;
        }}
        
        .header {{
            background: #2d2d2d;
            padding: 15px 20px;
            border-bottom: 1px solid #404040;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }}
        
        .header h1 {{
            font-size: 18px;
            font-weight: 600;
            color: #fff;
            text-align: center;
            flex: 1;
        }}
        
        .back-btn {{
            background: #404040;
            color: #fff;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            text-decoration: none;
            font-size: 14px;
            transition: background 0.2s;
        }}
        
        .back-btn:hover {{
            background: #505050;
        }}
        
        .main-container {{
            display: grid;
            grid-template-columns: 1fr 500px;
            height: calc(100vh - 60px);
            gap: 20px;
        }}
        
        .preview-section {{
            background: #1a1a1a;
            display: flex;
            flex-direction: column;
        }}
        
        .content-preview {{
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            padding: 20px;
            position: relative;
        }}
        
        .preview-container {{
            background: #2d2d2d;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            text-align: center;
            min-height: 300px;
            width: 100%;
            max-width: 600px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            border: 2px solid #404040;
            position: relative;
            transition: all 0.3s ease;
        }}
        
        .preview-container.active {{
            border-color: #0066ff;
            box-shadow: 0 0 20px rgba(0, 102, 255, 0.3);
        }}
        
        .preview-icon {{
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.7;
            transition: all 0.3s ease;
        }}
        
        .preview-content {{
            display: none;
            width: 100%;
        }}
        
        .preview-content.active {{
            display: block;
        }}
        
        .video-preview {{
            background: #000;
            border-radius: 8px;
            aspect-ratio: 16/9;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 48px;
            margin-bottom: 20px;
        }}
        
        .audio-preview {{
            width: 100%;
        }}
        
        .waveform {{
            background: linear-gradient(90deg, 
                transparent 0%, 
                rgba(0, 102, 255, 0.3) 20%, 
                rgba(0, 102, 255, 0.6) 50%, 
                rgba(0, 102, 255, 0.3) 80%, 
                transparent 100%);
            height: 80px;
            border-radius: 8px;
            margin: 20px 0;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #0066ff;
            font-weight: bold;
        }}
        
        .text-preview {{
            background: #1a1a1a;
            border-radius: 8px;
            padding: 20px;
            font-size: 24px;
            font-weight: bold;
            color: #fff;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
            border: 2px solid #0066ff;
        }}
        
        .play-controls {{
            width: 100%;
            max-width: 600px;
            background: #2d2d2d;
            border-radius: 8px;
            padding: 12px 16px;
            margin-top: 15px;
            display: flex;
            align-items: center;
            gap: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }}
        
        .play-button {{
            background: #0066ff;
            color: white;
            border: none;
            border-radius: 6px;
            width: 36px;
            height: 36px;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            flex-shrink: 0;
        }}
        
        .play-button:hover {{
            background: #0052cc;
            transform: scale(1.05);
        }}
        
        .progress-container {{
            flex: 1;
            display: flex;
            align-items: center;
            gap: 8px;
        }}
        
        .progress-bar {{
            flex: 1;
            height: 4px;
            background: #404040;
            border-radius: 2px;
            position: relative;
            cursor: pointer;
        }}
        
        .progress-fill {{
            height: 100%;
            background: #0066ff;
            border-radius: 2px;
            width: 0%;
            transition: width 0.1s ease;
        }}
        
        .time-display {{
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 12px;
            color: #ccc;
            font-family: monospace;
            min-width: 80px;
        }}
        
        .timeline {{
            background: #252525;
            border-top: 1px solid #404040;
            padding: 20px;
            min-height: 140px;
        }}
        
        .timeline-header {{
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }}
        
        .timeline-title {{
            font-size: 14px;
            color: #ccc;
        }}
        
        .timeline-duration {{
            font-size: 12px;
            color: #888;
        }}
        
        .tracks-container {{
            position: relative;
        }}
        
        .time-ruler {{
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding: 0 10px;
            font-size: 11px;
            color: #666;
        }}
        
        .track {{
            background: #1a1a1a;
            border-radius: 6px;
            margin-bottom: 8px;
            padding: 8px;
            position: relative;
            border: 1px solid #404040;
            transition: all 0.2s ease;
        }}
        
        .track:hover {{
            border-color: #0066ff;
            box-shadow: 0 2px 8px rgba(0, 102, 255, 0.2);
        }}
        
        .track-label {{
            position: absolute;
            left: 8px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 11px;
            color: #aaa;
            z-index: 2;
            pointer-events: none;
        }}
        
        .track-content {{
            height: 40px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
            font-weight: 600;
            position: relative;
            cursor: pointer;
            transition: all 0.2s ease;
        }}
        
        .track-content:hover {{
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }}
        
        .track-video {{
            background: linear-gradient(135deg, #8e24aa, #6a1b9a);
        }}
        
        .track-audio {{
            background: linear-gradient(135deg, #0066ff, #0052cc);
        }}
        
        .track-text {{
            background: linear-gradient(135deg, #ff9800, #f57c00);
        }}
        
        .track-music {{
            background: linear-gradient(135deg, #4caf50, #388e3c);
        }}
        
        .track-content::before {{
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: repeating-linear-gradient(
                90deg,
                transparent 0px,
                transparent 10px,
                rgba(255, 255, 255, 0.1) 10px,
                rgba(255, 255, 255, 0.1) 11px
            );
            border-radius: 4px;
        }}
        
        .details-panel {{
            background: #2d2d2d;
            border-left: 1px solid #404040;
            display: flex;
            flex-direction: column;
        }}
        
        .panel-header {{
            background: #353535;
            padding: 8px 10px;
            border-bottom: 1px solid #404040;
            text-align: center;
            font-size: 16px;
            font-weight: 600;
        }}
        
        .panel-content {{
            flex: 1;
            overflow-y: auto;
        }}
        
        .details-section {{
            padding: 8px;
            border-bottom: 1px solid #404040;
        }}
        
        .details-table {{
            width: 100%;
            border-collapse: collapse;
        }}
        
        .details-table tr {{
            border-bottom: 1px solid #404040;
        }}
        
        .details-table td {{
            padding: 8px 0;
            font-size: 14px;
        }}
        
        .details-table td:first-child {{
            color: #aaa;
            width: 30%;
        }}
        
        .details-table td:last-child {{
            color: #fff;
            font-weight: 500;
        }}
        

        
        .download-section {{
            padding: 15px;
            background: #353535;
        }}
        
        .download-info {{
            background: rgba(0, 191, 165, 0.1);
            border: 1px solid rgba(0, 191, 165, 0.3);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 15px;
            text-align: center;
        }}
        
        .download-icon {{
            width: 60px;
            height: 60px;
            background: #00bfa5;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 15px;
            font-size: 24px;
        }}
        
        .download-path {{
            background: #1a1a1a;
            border: 1px solid #404040;
            border-radius: 6px;
            padding: 8px 12px;
            font-size: 12px;
            color: #ccc;
            margin-bottom: 15px;
            word-break: break-all;
        }}
        
        .action-buttons {{
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 15px;
        }}
        
        .btn {{
            background: #0066ff;
            color: white;
            border: none;
            padding: 12px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: background 0.2s;
            text-decoration: none;
            text-align: center;
        }}
        
        .btn:hover {{
            background: #0052cc;
        }}
        
        .btn-secondary {{
            background: #404040;
        }}
        
        .btn-secondary:hover {{
            background: #505050;
        }}
        
        .selected-asset {{
            background: #353535;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }}
        
        .selected-asset h3 {{
            color: #0066ff;
            margin-bottom: 10px;
            font-size: 14px;
        }}
        
        .asset-info {{
            font-size: 12px;
            color: #ccc;
            line-height: 1.5;
        }}
        
        @media (max-width: 768px) {{
            .main-container {{
                grid-template-columns: 1fr;
                grid-template-rows: 1fr auto;
            }}
            
            .details-panel {{
                border-left: none;
                border-top: 1px solid #404040;
                max-height: 40vh;
            }}
            
            .content-preview {{
                padding: 20px;
            }}
        }}
    </style>
</head>
<body>
    <div class="header">
        <a href="javascript:history.back()" class="back-btn">â† è¿”å›</a>
        <h1>è‰ç¨¿é¢„è§ˆ - {draft_id}</h1>
        <div style="width: 80px;"></div>
    </div>
    
    <div class="main-container">
        <div class="preview-section">
            <div class="content-preview">
                <div class="preview-container" id="preview-container">
                    <div class="preview-icon" id="preview-icon">ğŸ¬</div>
                    <h3 id="preview-title">ç‚¹å‡»ä¸‹æ–¹è½¨é“ä¸Šçš„ç´ æå¯å…³é”®å¸§ï¼Œåœ¨æ­¤æŸ¥çœ‹å…¶è¯¦ç»†ä¿¡æ¯</h3>
                    <p style="color: #888; margin-top: 10px;" id="preview-subtitle">é€‰æ‹©ç´ ææ¥é¢„è§ˆå†…å®¹</p>
                    
                    <!-- è§†é¢‘é¢„è§ˆ -->
                    <div class="preview-content" id="video-preview">
                        <div class="video-preview">ğŸ¥</div>
                        <h3>è§†é¢‘ç´ æé¢„è§ˆ</h3>
                        <p style="color: #888;">è§†é¢‘è½¨é“å†…å®¹</p>
                    </div>
                    
                    <!-- éŸ³é¢‘é¢„è§ˆ -->
                    <div class="preview-content" id="audio-preview">
                        <div class="audio-preview">
                            <div class="waveform">ğŸµ éŸ³é¢‘æ³¢å½¢</div>
                        </div>
                        <h3>éŸ³é¢‘ç´ æé¢„è§ˆ</h3>
                        <p style="color: #888;">è¯­éŸ³åˆæˆéŸ³é¢‘</p>
                    </div>
                    
                    <!-- æ–‡æœ¬é¢„è§ˆ -->
                    <div class="preview-content" id="text-preview">
                        <div class="text-preview" id="text-content">ç¤ºä¾‹æ–‡æœ¬å†…å®¹</div>
                        <h3>æ–‡æœ¬ç´ æé¢„è§ˆ</h3>
                        <p style="color: #888;">æ–‡æœ¬è½¨é“å†…å®¹å±•ç¤º</p>
                    </div>
                </div>
                
                <div class="play-controls">
                    <button class="play-button" id="play-btn" onclick="togglePlay()">
                        â–¶ï¸
                    </button>
                    <div class="progress-container">
                        <div class="progress-bar" onclick="seekTo(event)">
                            <div class="progress-fill" id="progress-fill"></div>
                        </div>
                        <div class="time-display">
                            <span id="current-time">0:00</span>
                            <span style="color: #666;">/</span>
                            <span id="total-time">0:30</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="timeline">
                <div class="timeline-header">
                    <div class="timeline-title">æ—¶é—´è½´</div>
                    <div class="timeline-duration">æ€»æ—¶é•¿: 0:30</div>
                </div>
                
                <div class="tracks-container">
                    <div class="time-ruler">
                        <span>0:00</span>
                        <span>0:05</span>
                        <span>0:10</span>
                        <span>0:15</span>
                        <span>0:20</span>
                        <span>0:25</span>
                        <span>0:30</span>
                    </div>
                    
                    <div class="track">
                        <div class="track-label">ä¸»è§†é¢‘è½¨é“</div>
                        <div class="track-content track-video" onclick="selectAsset('video', 'ä¸»è§†é¢‘è½¨é“', 'è§†é¢‘ç´ æå†…å®¹', event)" data-type="video">
                            ğŸ¥ ä¸»è§†é¢‘
                        </div>
                    </div>
                    
                    <div class="track">
                        <div class="track-label">è¯­éŸ³æ—ç™½</div>
                        <div class="track-content track-audio" onclick="selectAsset('audio', 'è¯­éŸ³æ—ç™½', 'è±†åŒ…è¯­éŸ³åˆæˆéŸ³é¢‘', event)" data-type="audio" style="width: 93%;">
                            ğŸ¤ è¯­éŸ³æ—ç™½
                        </div>
                    </div>
                    
                    <div class="track">
                        <div class="track-label">æ ‡é¢˜æ–‡æœ¬</div>
                        <div class="track-content track-text" onclick="selectAsset('text', 'æ ‡é¢˜æ–‡æœ¬', 'AIç”Ÿæˆçš„æ ‡é¢˜å†…å®¹', event)" data-type="text" style="width: 17%;">
                            AI
                        </div>
                    </div>
                    
                    <div class="track">
                        <div class="track-label">èƒŒæ™¯éŸ³ä¹</div>
                        <div class="track-content track-music" onclick="selectAsset('music', 'èƒŒæ™¯éŸ³ä¹', 'èƒŒæ™¯éŸ³ä¹è½¨é“', event)" data-type="music">
                            â™ª èƒŒæ™¯éŸ³ä¹
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="details-panel">
            <div class="panel-header">è¯¦ç»†ä¿¡æ¯</div>
            <div class="panel-content">
                <div class="details-section">
                    <div class="selected-asset" id="selected-asset" style="display: none;">
                        <h3>å·²é€‰æ‹©ç´ æ</h3>
                        <div class="asset-info" id="asset-info">
                            æš‚æ— é€‰æ‹©
                        </div>
                    </div>
                    
                    <table class="details-table">
                        <!-- ç´ æä¿¡æ¯ -->
                        {material_rows}
                        <tr>
                            <td>è‰ç¨¿ID:</td>
                            <td>{draft_id}</td>
                        </tr>
                        <tr>
                            <td>ç”»é¢å°ºå¯¸:</td>
                            <td>1080 Ã— 1920</td>
                        </tr>
                        <tr>
                            <td>æ€»æ—¶é•¿:</td>
                            <td>0:30</td>
                        </tr>
                        <tr>
                            <td>è½¨é“æ•°é‡:</td>
                            <td>4</td>
                        </tr>
                        <tr>
                            <td>æ–‡ä»¶å¤§å°:</td>
                            <td>{round(file_size/1024, 1)} KB</td>
                        </tr>
                        <tr>
                            <td>çŠ¶æ€:</td>
                            <td>{"å·²ç”Ÿæˆ" if draft_source == "local" else "äº‘ç«¯å·²ä¿å­˜" if draft_source == "oss" else "å·²å®Œæˆ"}</td>
                        </tr>
                        <tr>
                            <td>å­˜å‚¨ä½ç½®:</td>
                            <td>{"æœ¬åœ°æ–‡ä»¶" if draft_source == "local" else "OSSäº‘å­˜å‚¨" if draft_source == "oss" else "æœªçŸ¥"}</td>
                        </tr>
                    </table>
                </div>

            </div>
            
            <div class="download-section">
                <div class="panel-header" style="background: transparent; padding: 0 0 15px 0; text-align: left;">ä¸‹è½½è‰ç¨¿</div>
                
                <div class="download-info">
                    <div class="download-icon">ğŸ“</div>
                    <p>è‰ç¨¿ä¿å­˜10åˆ†é’Ÿï¼Œè¯·å°½å¿«ä¸‹è½½</p>
                </div>
                
                <!-- ç³»ç»Ÿé€‰æ‹© -->
                <div style="margin-bottom: 15px;">
                    <label style="display: block; font-size: 12px; color: #aaa; margin-bottom: 5px;">ç³»ç»Ÿç±»å‹:</label>
                    <select id="osSelect" style="width: 100%; padding: 8px; background: #1a1a1a; border: 1px solid #404040; border-radius: 6px; color: #fff; font-size: 12px;">
                        <option value="windows">Windows</option>
                        <option value="linux">Linux</option>
                    </select>
                </div>
                
                <!-- è‡ªå®šä¹‰è·¯å¾„ -->
                <div style="margin-bottom: 15px;">
                    <label style="display: block; font-size: 12px; color: #aaa; margin-bottom: 5px;">è‡ªå®šä¹‰æ ¹è·¯å¾„ (å¯é€‰):</label>
                    <input id="baseInput" type="text" placeholder="å¦‚: F:/MyDrafts" style="width: 100%; padding: 8px; background: #1a1a1a; border: 1px solid #404040; border-radius: 6px; color: #fff; font-size: 12px; box-sizing: border-box;" />
                </div>
                
                <!-- æœ¬åœ°è·¯å¾„æ˜¾ç¤º -->
                <div class="download-path" id="localPath">
                    è·å–æœ¬åœ°è·¯å¾„ä¸­...
                </div>
                
                <!-- æ“ä½œæŒ‰é’® -->
                <div class="action-buttons">
                    <button id="saveUploadBtn" class="btn" style="width: 100%; margin-bottom: 10px;">
                        â˜ï¸ ä¸€é”®ä¿å­˜å¹¶ä¸Šä¼ åˆ°OSS
                    </button>
                    <button class="btn btn-secondary" onclick="copyLocalPath()" style="width: 100%;">
                        ğŸ“‹ å¤åˆ¶æœ¬åœ°è·¯å¾„
                    </button>
                </div>
                
                <!-- çŠ¶æ€æ˜¾ç¤º -->
                <div id="downloadStatus" style="font-size: 11px; color: #888; margin-top: 10px; text-align: center;">
                    å‡†å¤‡å°±ç»ª
                </div>
                
                <!-- æ—¥å¿—åŒºåŸŸ -->
                <div id="downloadLog" style="background: #1a1a1a; border: 1px solid #404040; border-radius: 6px; padding: 8px; margin-top: 10px; height: 100px; overflow-y: auto; font-family: monospace; font-size: 10px; color: #ccc; display: none;">
                </div>
            </div>
        </div>
    </div>
    
    <script>
        let isPlaying = false;
        let currentTime = 0;
        const maxTime = 30;
        let playInterval;
        let currentAsset = null;
        
        // æ˜¾ç¤ºä¸åŒç±»å‹çš„å†…å®¹
        function showContent(type, name, description) {{
            document.querySelectorAll('.preview-content').forEach(content => {{
                content.classList.remove('active');
            }});
            
            document.getElementById('preview-icon').textContent = type === 'video' ? 'ğŸ¥' : type === 'audio' ? 'ğŸµ' : 'ğŸ“';
            document.getElementById('preview-title').textContent = name;
            document.getElementById('preview-subtitle').textContent = description;
            
            if (type === 'video') {{
                document.getElementById('video-preview').classList.add('active');
            }} else if (type === 'audio') {{
                document.getElementById('audio-preview').classList.add('active');
            }} else {{
                document.getElementById('text-preview').classList.add('active');
            }}
            
            // timelineä»£ç æš‚æ—¶æ³¨é‡Šæ‰è¿›è¡Œè°ƒè¯•
            console.log('selectAsset function called successfully');
                    </div>
                </div>
            </div>
            
            <div class="download-section">
                <div class="panel-header" style="background: transparent; padding: 0 0 15px 0; text-align: left;">ä¸‹è½½è‰ç¨¿</div>
                
                <div class="download-info">
                    <div class="download-icon">ğŸ“</div>
                    <p>è‰ç¨¿ä¿å­˜10åˆ†é’Ÿï¼Œè¯·å°½å¿«ä¸‹è½½</p>
                </div>
                
                <!-- ç³»ç»Ÿé€‰æ‹© -->
                <div style="margin-bottom: 15px;">
                    <label style="display: block; font-size: 12px; color: #aaa; margin-bottom: 5px;">ç³»ç»Ÿç±»å‹:</label>
                    <select id="osSelect" style="width: 100%; padding: 8px; background: #1a1a1a; border: 1px solid #404040; border-radius: 6px; color: #fff; font-size: 12px;">
                        <option value="windows">Windows</option>
                        <option value="linux">Linux</option>
                    </select>
                </div>
                
                <!-- è‡ªå®šä¹‰è·¯å¾„ -->
                <div style="margin-bottom: 15px;">
                    <label style="display: block; font-size: 12px; color: #aaa; margin-bottom: 5px;">è‡ªå®šä¹‰æ ¹è·¯å¾„ (å¯é€‰):</label>
                    <input id="baseInput" type="text" placeholder="å¦‚: F:/MyDrafts" style="width: 100%; padding: 8px; background: #1a1a1a; border: 1px solid #404040; border-radius: 6px; color: #fff; font-size: 12px; box-sizing: border-box;" />
                </div>
                
                <!-- æœ¬åœ°è·¯å¾„æ˜¾ç¤º -->
                <div class="download-path" id="localPath">
                    è·å–æœ¬åœ°è·¯å¾„ä¸­...
                </div>
                
                <!-- æ“ä½œæŒ‰é’® -->
                <div class="action-buttons">
                    <button id="saveUploadBtn" class="btn" style="width: 100%; margin-bottom: 10px;">
                        â˜ï¸ ä¸€é”®ä¿å­˜å¹¶ä¸Šä¼ åˆ°OSS
                    </button>
                    <button class="btn btn-secondary" onclick="copyLocalPath()" style="width: 100%;">
                        ğŸ“‹ å¤åˆ¶æœ¬åœ°è·¯å¾„
                    </button>
                </div>
                
                <!-- çŠ¶æ€æ˜¾ç¤º -->
                <div id="downloadStatus" style="font-size: 11px; color: #888; margin-top: 10px; text-align: center;">
                    å‡†å¤‡å°±ç»ª
                </div>
                
                <!-- æ—¥å¿—åŒºåŸŸ -->
                <div id="downloadLog" style="background: #1a1a1a; border: 1px solid #404040; border-radius: 6px; padding: 8px; margin-top: 10px; height: 100px; overflow-y: auto; font-family: monospace; font-size: 10px; color: #ccc; display: none;">
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentAsset = null;
        let isPlaying = false;
        
        // å…¨å±€å˜é‡ï¼Œé˜²æ­¢materialTypeæœªå®šä¹‰é”™è¯¯
        let materialType = 'unknown';
        
        // ç´ ææ•°æ®
        const materials = {materials_json};
        
        // æ ¹æ®è½¨é“ç±»å‹æ˜ å°„åˆ°å®é™…ç´ ææ•°æ®
        function getMaterialByType(trackType) {{
            console.log('æŸ¥æ‰¾ç´ æç±»å‹:', trackType, 'å¯ç”¨ç´ æ:', materials);
            
            // æ ¹æ®è½¨é“ç±»å‹æŸ¥æ‰¾å¯¹åº”çš„ç´ æ
            for (let material of materials) {{
                if (trackType === 'video' && material.type === 'video') {{
                    console.log('æ‰¾åˆ°è§†é¢‘ç´ æ:', material);
                    return material;
                }}
                if (trackType === 'audio' && material.type === 'audio') {{
                    // ä¼˜å…ˆåŒ¹é…éèƒŒæ™¯éŸ³ä¹çš„éŸ³é¢‘ç´ æï¼ˆè¯­éŸ³æ—ç™½ï¼‰
                    if (!material.track_name || (!material.track_name.includes('bgm') && !material.track_name.includes('music'))) {{
                        console.log('æ‰¾åˆ°è¯­éŸ³æ—ç™½ç´ æ:', material);
                        return material;
                    }}
                }}
                if (trackType === 'text' && material.type === 'text') {{
                    console.log('æ‰¾åˆ°æ–‡æœ¬ç´ æ:', material);
                    return material;
                }}
                if (trackType === 'music' && material.type === 'audio' && material.track_name && 
                    (material.track_name.includes('bgm') || material.track_name.includes('music'))) {{
                    console.log('æ‰¾åˆ°èƒŒæ™¯éŸ³ä¹ç´ æ:', material);
                    return material;
                }}
            }}
            
            // å¦‚æœæ²¡æœ‰æ‰¾åˆ°å¯¹åº”çš„ç´ æï¼Œè¿”å›ç¬¬ä¸€ä¸ªç´ æä½œä¸ºç¤ºä¾‹
            console.log('æœªæ‰¾åˆ°åŒ¹é…ç´ æï¼Œè¿”å›ç¬¬ä¸€ä¸ªç´ æ');
            return materials.length > 0 ? materials[0] : null;
        }}
        
        // æ›´æ–°Detailsè¡¨æ ¼
        function updateDetailsTable(material) {{
            alert('updateDetailsTableå‡½æ•°è¢«è°ƒç”¨');
            console.log('æ›´æ–°Detailsè¡¨æ ¼ï¼Œç´ ææ•°æ®:', material);
            if (!material) {{
                console.log('æ²¡æœ‰ç´ ææ•°æ®ï¼Œé€€å‡º');
                return;
            }}
            
            // åˆ é™¤æ‰€æœ‰ç°æœ‰çš„ç´ æä¿¡æ¯è¡Œ
            const materialRows = document.querySelectorAll('.details-table .material-rows');
            materialRows.forEach(row => row.remove());
            
            const detailsTable = document.querySelector('.details-table');
            const draftIdRow = detailsTable.querySelector('tr');
            
            // åˆ›å»ºæ–°çš„ç´ æä¿¡æ¯è¡Œ
            const materialType = material.type || material.materialType || material.material_type || 'unknown';
            const urlLabel = materialType === 'text' ? 'Content' : materialType.charAt(0).toUpperCase() + materialType.slice(1) + ' URL';
            const urlContent = material.url || material.content || '-';
            const startTime = material.start || '-';
            const endTime = material.end || '-';
            const duration = (typeof startTime === 'number' && typeof endTime === 'number') ? 
                (endTime - startTime).toFixed(2) + 's' : '-';
            
            const materialRowsHTML = `
                <tr class="material-rows" style="background-color: #2a2a2a;">
                    <td>Type:</td>
                    <td>${{materialType}}</td>
                </tr>
                <tr class="material-rows" style="background-color: #2a2a2a;">
                    <td>${{urlLabel}}:</td>
                    <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${{urlContent}}">${{urlContent}}</td>
                </tr>
                <tr class="material-rows" style="background-color: #2a2a2a;">
                    <td>Start Time:</td>
                    <td>${{startTime}}s</td>
                </tr>
                <tr class="material-rows" style="background-color: #2a2a2a;">
                    <td>End Time:</td>
                    <td>${{endTime}}s</td>
                </tr>
                <tr class="material-rows" style="background-color: #2a2a2a;">
                    <td>Playback Duration:</td>
                    <td>${{duration}}</td>
                </tr>
                <tr class="material-rows"><td colspan="2" style="height: 10px; border: none;"></td></tr>
            `;
            
            draftIdRow.insertAdjacentHTML('beforebegin', materialRowsHTML);
        }}
        
        function selectAsset(type, name, description, event) {{
            alert('ç‚¹å‡»äº‹ä»¶è§¦å‘æˆåŠŸï¼ç´ æç±»å‹: ' + type);
            console.log('selectAssetè¢«è°ƒç”¨ï¼Œå‚æ•°:', {{type, name, description}});
            
            // ç§»é™¤ä¹‹å‰çš„é€‰æ‹©çŠ¶æ€
            document.querySelectorAll('.track-content').forEach(el => {{
                el.style.boxShadow = '';
                el.style.transform = '';
            }});
            
            // æŸ¥æ‰¾å¯¹åº”çš„ç´ ææ•°æ®å¹¶æ›´æ–°Detailsè¡¨æ ¼
            const material = getMaterialByType(type);
            console.log('è·å–åˆ°çš„ç´ æ:', material);
            if (material) {{
                updateDetailsTable(material);
            }} else {{
                console.log('æ²¡æœ‰æ‰¾åˆ°å¯¹åº”çš„ç´ ææ•°æ®');
            }}
            
            // æ·»åŠ é€‰æ‹©çŠ¶æ€åˆ°è¢«ç‚¹å‡»çš„å…ƒç´ 
            const targetElement = event ? event.target : document.querySelector(`[data-type="${{type}}"]`);
            if (targetElement) {{
                targetElement.style.boxShadow = '0 0 15px rgba(0, 102, 255, 0.6)';
                targetElement.style.transform = 'translateY(-2px)';
            }}
            
            // æ›´æ–°é¢„è§ˆåŒºåŸŸ
            const previewContainer = document.getElementById('preview-container');
            const previewIcon = document.getElementById('preview-icon');
            const previewTitle = document.getElementById('preview-title');
            const previewSubtitle = document.getElementById('preview-subtitle');
            
            // éšè—æ‰€æœ‰é¢„è§ˆå†…å®¹
            document.querySelectorAll('.preview-content').forEach(el => {{
                el.classList.remove('active');
            }});
            
            // æ¿€æ´»é¢„è§ˆå®¹å™¨
            previewContainer.classList.add('active');
            
            // æ ¹æ®ç´ æç±»å‹æ˜¾ç¤ºå¯¹åº”é¢„è§ˆ
            switch(type) {{
                case 'video':
                    previewIcon.textContent = 'ğŸ¥';
                    previewTitle.textContent = 'è§†é¢‘ç´ æé¢„è§ˆ';
                    previewSubtitle.textContent = 'ä¸»è§†é¢‘è½¨é“å†…å®¹';
                    document.getElementById('video-preview').classList.add('active');
                    break;
                case 'audio':
                case 'music':
                    previewIcon.textContent = 'ğŸµ';
                    previewTitle.textContent = 'éŸ³é¢‘ç´ æé¢„è§ˆ';
                    previewSubtitle.textContent = type === 'music' ? 'èƒŒæ™¯éŸ³ä¹è½¨é“' : 'è¯­éŸ³æ—ç™½è½¨é“';
                    document.getElementById('audio-preview').classList.add('active');
                    break;
                case 'text':
                    previewIcon.textContent = 'ğŸ“';
                    previewTitle.textContent = 'æ–‡æœ¬ç´ æé¢„è§ˆ';
                    previewSubtitle.textContent = 'æ ‡é¢˜æ–‡æœ¬å†…å®¹';
                    document.getElementById('text-content').textContent = name;
                    document.getElementById('text-preview').classList.add('active');
                    break;
            }}
            
            // æ›´æ–°é€‰æ‹©çš„ç´ æä¿¡æ¯
            const selectedAsset = document.getElementById('selected-asset');
            const assetInfo = document.getElementById('asset-info');
            selectedAsset.style.display = 'block';
//             assetInfo.innerHTML = \`
//                 <strong>ç±»å‹:</strong> \${{type}}<br>
//                 <strong>åç§°:</strong> \${{name}}<br>
//                 <strong>æè¿°:</strong> \${{description}}<br>
//             `;
//             
//             currentAsset = {{ type, name, description }};
//         }}
        

        
        function togglePlay() {{
            const playBtn = document.getElementById('play-btn');
            isPlaying = !isPlaying;
            
            if (isPlaying) {{
                playBtn.textContent = 'â¸ï¸';
                simulatePlayback();
            }} else {{
                playBtn.textContent = 'â–¶ï¸';
            }}
        }}
        
        function simulatePlayback() {{
            if (!isPlaying) return;
            
            const currentTimeEl = document.getElementById('current-time');
            const progressFill = document.getElementById('progress-fill');
            let seconds = 0;
            const totalDuration = 30;
            
            const interval = setInterval(() => {{
                if (!isPlaying) {{
                    clearInterval(interval);
                    return;
                }}
                
                seconds++;
                const mins = Math.floor(seconds / 60);
                const secs = seconds % 60;
                currentTimeEl.textContent = `${{mins}}:${{secs.toString().padStart(2, '0')}}`;
                
                // æ›´æ–°è¿›åº¦æ¡
                const progress = (seconds / totalDuration) * 100;
                progressFill.style.width = `${{progress}}%`;
                
                if (seconds >= totalDuration) {{
                    clearInterval(interval);
                    togglePlay();
                    currentTimeEl.textContent = '0:00';
                    progressFill.style.width = '0%';
                }}
            }}, 1000);
        }}
        
        function seekTo(event) {{
            const progressBar = event.currentTarget;
            const rect = progressBar.getBoundingClientRect();
            const clickX = event.clientX - rect.left;
            const width = rect.width;
            const percentage = clickX / width;
            
            const totalDuration = 30;
            const targetTime = Math.floor(percentage * totalDuration);
            
            // æ›´æ–°æ—¶é—´æ˜¾ç¤º
            const mins = Math.floor(targetTime / 60);
            const secs = targetTime % 60;
            document.getElementById('current-time').textContent = `${{mins}}:${{secs.toString().padStart(2, '0')}}`;
            
            // æ›´æ–°è¿›åº¦æ¡
            const progressFill = document.getElementById('progress-fill');
            progressFill.style.width = `${{percentage * 100}}%`;
            
            // å¦‚æœæ­£åœ¨æ’­æ”¾ï¼Œé‡æ–°å¼€å§‹æ’­æ”¾
            if (isPlaying) {{
                isPlaying = false;
                togglePlay();
                setTimeout(() => togglePlay(), 100);
            }}
        }}
        
        function copyUrl(url) {{
            navigator.clipboard.writeText(url).then(() => {{
                alert('é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
            }}).catch(() => {{
                alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶ï¼š' + url);
            }});
        }}
        
        function copyLocalPath() {{
            const localPath = document.getElementById('localPath').textContent;
            navigator.clipboard.writeText(localPath).then(() => {{
                alert('æœ¬åœ°è·¯å¾„å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
            }}).catch(() => {{
                alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶ï¼š' + localPath);
            }});
        }}
        
        // ä¸‹è½½ç›¸å…³å‡½æ•°
        function updateLocalPath() {{
            const osSelect = document.getElementById('osSelect');
            const baseInput = document.getElementById('baseInput');
            const localPathEl = document.getElementById('localPath');
            
            const draftId = '{draft_id}';
            const clientOs = osSelect.value;
            const customBase = baseInput.value;
            
            // æ„é€ æœ¬åœ°è·¯å¾„
            let localPath = '';
            if (clientOs === 'windows') {{
                const base = customBase || 'F:\\\\jianyin\\\\cgwz\\\\JianyingPro Drafts';
                localPath = `${{base}}\\\\${{draftId}}`;
            }} else {{
                const base = customBase || '/data/drafts';
                localPath = `${{base}}/${{draftId}}`;
            }}
            
            localPathEl.textContent = localPath;
        }}
        
        function downloadLog(msg) {{
            const logEl = document.getElementById('downloadLog');
            const time = new Date().toLocaleTimeString();
            logEl.textContent += `[${{time}}] ${{msg}}\\n`;
            logEl.scrollTop = logEl.scrollHeight;
            logEl.style.display = 'block';
        }}
        
        async function postJSON(url, body) {{
            const res = await fetch(url, {{ 
                method: 'POST', 
                headers: {{'Content-Type': 'application/json'}}, 
                body: JSON.stringify(body) 
            }});
            return await res.json();
        }}
        
        async function pollDownloadStatus(taskId) {{
            const statusEl = document.getElementById('downloadStatus');
            while (true) {{
                const status = await postJSON('/query_draft_status', {{ task_id: taskId }});
                if (status && status.status) {{
                    downloadLog(`status=${{status.status}}, progress=${{status.progress}}`);
                    
                    if (status.status === 'completed') break;
                    if (status.status === 'failed') {{
                        throw new Error(status.message || 'ä»»åŠ¡å¤±è´¥');
                    }}
                }}
                await new Promise(r => setTimeout(r, 2000));
            }}
        }}
        
        async function finalizeDownloadRedirect() {{
            const osSelect = document.getElementById('osSelect');
            const baseInput = document.getElementById('baseInput');
            const draftId = '{draft_id}';
            
            const result = await postJSON('/generate_draft_url', {{ 
                draft_id: draftId, 
                client_os: osSelect.value, 
                draft_folder: baseInput.value || undefined 
            }});
            
            if (result && result.success && result.output && result.output.draft_url) {{
                downloadLog('è·³è½¬åˆ° OSS ä¸‹è½½é“¾æ¥');
                window.open(result.output.draft_url, '_blank');
            }} else {{
                throw new Error('æœªè·å–åˆ°ä¸‹è½½é“¾æ¥');
            }}
        }}
        
        // é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {{
            console.log('è‰ç¨¿é¢„è§ˆé¡µé¢å·²åŠ è½½');
            
            // åˆå§‹åŒ–ä¸‹è½½åŠŸèƒ½
            const osSelect = document.getElementById('osSelect');
            const baseInput = document.getElementById('baseInput');
            const saveUploadBtn = document.getElementById('saveUploadBtn');
            
            // åˆå§‹æ›´æ–°è·¯å¾„
            updateLocalPath();
            
            // ç›‘å¬å˜åŒ–
            osSelect.addEventListener('change', updateLocalPath);
            baseInput.addEventListener('input', updateLocalPath);
            
            // ä¿å­˜ä¸Šä¼ æŒ‰é’®äº‹ä»¶
            saveUploadBtn.addEventListener('click', async function() {{
                const statusEl = document.getElementById('downloadStatus');
                const draftId = '{draft_id}';
                
                saveUploadBtn.disabled = true;
                statusEl.textContent = 'æ­£åœ¨æ£€æµ‹äº‘ç«¯æ–‡ä»¶...';
                downloadLog('å¼€å§‹ä¿å­˜å¹¶ä¸Šä¼ åˆ°OSS');
                
                try {{
                    // é¦–å…ˆæ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
                    downloadLog('æ£€æµ‹æ˜¯å¦å·²å­˜åœ¨ OSS ç›´é“¾');
                    const checkResult = await postJSON('/generate_draft_url', {{ 
                        draft_id: draftId, 
                        client_os: osSelect.value, 
                        draft_folder: baseInput.value || undefined 
                    }});
                    
                    if (checkResult && checkResult.success && checkResult.output) {{
                        if (checkResult.output.storage === 'oss' && checkResult.output.draft_url) {{
                            downloadLog('å‘ç°å·²å­˜åœ¨çš„OSSé“¾æ¥ï¼Œç›´æ¥è·³è½¬');
                            window.open(checkResult.output.draft_url, '_blank');
                            return;
                        }}
                    }}
                    
                    // è§¦å‘ä¿å­˜ä¸Šä¼ 
                    downloadLog('æœªå‘ç°ç›´é“¾ï¼Œå¼€å§‹ä¿å­˜å¹¶ä¸Šä¼ ');
                    statusEl.textContent = 'æ­£åœ¨æäº¤ä¿å­˜ä»»åŠ¡...';
                    
                    const saveResult = await postJSON('/generate_draft_url?force_save=true', {{ 
                        draft_id: draftId, 
                        client_os: osSelect.value, 
                        draft_folder: baseInput.value || undefined 
                    }});
                    
                    if (saveResult && saveResult.success && saveResult.output) {{
                        if (saveResult.output.storage === 'oss' && saveResult.output.draft_url) {{
                            downloadLog('ä¿å­˜å®Œæˆï¼Œç›´æ¥è·³è½¬');
                            window.open(saveResult.output.draft_url, '_blank');
                            return;
                        }}
                        
                        if (saveResult.output.status === 'processing' && saveResult.output.task_id) {{
                            downloadLog('ä»»åŠ¡å·²æäº¤ï¼Œç­‰å¾…å®Œæˆ...');
                            await pollDownloadStatus(saveResult.output.task_id);
                            await finalizeDownloadRedirect();
                            return;
                        }}
                    }}
                    
                    throw new Error('ä¿å­˜ä¸Šä¼ æµç¨‹å¼‚å¸¸');
                    
                }} catch (error) {{
                    downloadLog('æ“ä½œå¤±è´¥: ' + error.message);
                    statusEl.textContent = 'æ“ä½œå¤±è´¥: ' + error.message;
                    alert('æ“ä½œå¤±è´¥: ' + error.message);
                }} finally {{
                    saveUploadBtn.disabled = false;
                }}
            }});
        }});
    </script>
</body>
</html>
"""
        return html_content
        
    except Exception as e:
        return f"é¢„è§ˆé¡µé¢ç”Ÿæˆå¤±è´¥: {str(e)}", 500

@app.route('/debug/cache/<draft_id>', methods=['GET'])
def debug_cache(draft_id: str):
    """è°ƒè¯•ï¼šæŸ¥çœ‹è‰ç¨¿ç¼“å­˜å†…å®¹"""
    materials = get_draft_materials(draft_id)
    return jsonify({
        "draft_id": draft_id,
        "materials": materials,
        "cache_keys": list(draft_materials_cache.keys())
    })

if __name__ == '__main__':
    app.run(host='0.0.0.0', port=PORT)
PORT = 9001
